import{e as te,r,i as _e,c as l,a as s,k as _,F as w,l as O,p as k,v as $,q as ge,o,n as B,t as n,A as Ie,f as be,j as ee,h as T,D as Ce,C as Te,E as we,y as se,g as Oe}from"./DcswZMe2.js";import{_ as oe}from"./DlAUqK2U.js";import{_ as Me}from"./gnT7fiFC.js";import{s as ae}from"./D-aQuylm.js";import"./B98MRPuF.js";const Re={class:"chat-container glass-panel"},ke={key:0,class:"empty-chat"},xe={class:"msg-text"},Ee={class:"chat-input-row"},Se=te({__name:"MultiplayerChat",props:{roomId:{},userId:{},username:{},messages:{}},setup(x){const M=x,v=r(""),u=r(null);function E(){u.value&&(u.value.scrollTop=u.value.scrollHeight)}_e(()=>M.messages,()=>{Ie(()=>E())},{deep:!0});async function g(){if(!v.value.trim())return;const I=v.value.trim();v.value="";try{await $fetch(`/api/rooms/${M.roomId}/chat`,{method:"POST",body:{userId:M.userId,username:M.username,text:I}})}catch(y){console.error("Failed to send message",y)}}return(I,y)=>(o(),l("div",Re,[s("div",{class:"chat-messages",ref_key:"msgContainer",ref:u},[x.messages.length===0?(o(),l("div",ke,"No messages yet...")):_("",!0),(o(!0),l(w,null,O(x.messages,(p,f)=>(o(),l("div",{key:f,class:"chat-msg"},[s("span",{class:B(["msg-sender",{me:p.userId===x.userId}])},n(p.username)+":",3),s("span",xe,n(p.text),1)]))),128))],512),s("div",Ee,[k(s("input",{"onUpdate:modelValue":y[0]||(y[0]=p=>v.value=p),onKeyup:ge(g,["enter"]),placeholder:"Type a message...",class:"chat-input",maxlength:"100"},null,544),[[$,v.value]]),s("button",{onClick:g,class:"send-btn"},"SEND")])]))}}),Pe=Object.assign(oe(Se,[["__scopeId","data-v-6cc4137d"]]),{__name:"MultiplayerChat"}),Ae={class:"multi-container"},$e={key:0,class:"setup-screen glass-panel lobby-panel"},Le={class:"lobby-actions"},Be={class:"room-list"},Ue={key:0,class:"no-rooms"},Ye=["onClick"],Fe={class:"room-info"},Ne={class:"room-title"},Ve={class:"room-meta-row"},De={class:"room-host"},Ge={class:"room-time"},He={class:"room-status-badge"},je={key:1,class:"setup-screen glass-panel"},We={class:"form-container"},Ke={class:"form-group"},Xe={class:"form-group"},qe={class:"form-group"},ze={class:"form-group"},Je={class:"form-group"},Qe=["value"],Ze={class:"action-row"},es={key:2,class:"setup-screen glass-panel room-view"},ss={class:"room-header-title"},as={class:"room-header-meta"},ts={class:"room-content-row"},os={class:"player-grid"},ls={class:"player-name"},ns={key:0,class:"me-badge"},rs={key:1,class:"host-badge"},us={class:"chat-sidebar"},is={key:0,class:"host-controls"},cs=["disabled"],ds={key:0,class:"hint-text"},ms={key:1,class:"guest-controls"},vs={key:3,class:"ingame-container"},ps={key:0,class:"result-overlay"},fs={class:"result-box glass-panel"},ys={class:"victory-text"},hs={class:"result-list"},_s={class:"rank"},gs={class:"name"},Is={class:"score"},bs={class:"match-hud"},Cs={class:"leaderboard-hud"},Ts={class:"lb-rank"},ws={class:"lb-name"},Os={class:"lb-score"},Ms=te({__name:"multiplayer",setup(x){const M=Oe(),{user:v}=be(),u=r("LOBBY"),E=r([]),g=r("New Room"),I=r(4),y=r(120),p=r(10),f=r(null),U=[{id:"1",name:"God Chang-seop (신창섭) '바로 리부트 정상화' MV",url:"/audio/samples/God Chang-seop (신창섭) '바로 리부트 정상화' MV.mp3"},{id:"2",name:"I Love You",url:"/audio/samples/I Love You.mp3"},{id:"3",name:"Nyan Cat! [Official]",url:"/audio/samples/Nyan Cat! [Official].mp3"},{id:"random",name:"Random Sample",url:null}];ee(()=>{f.value=U[3]});const i=r(null),d=r(null),Y=r(0),c=T(()=>v.value?._id||sessionStorage.getItem("umm_player_id")||"guest_"+Math.random().toString(36).substr(2,9)),F=T(()=>v.value?.displayName||v.value?.username||"Guest"),X=T(()=>i.value?.hostId===c.value),R=r(null),S=r(null),N=r([]),q=r([]),b=r(0),P=r(null),V=r(null),D=r(0),z=r(360),le=r(0),A=r([]);let G=!1;const H=Ce("showNavbar");ee(()=>{!v.value?._id&&!sessionStorage.getItem("umm_player_id")&&sessionStorage.setItem("umm_player_id",c.value),j()}),Te(()=>{L(),H.value=!0});function L(){P.value&&clearInterval(P.value),V.value&&clearInterval(V.value)}async function ne(){le.value++;const a=A.value.find(e=>e.userId===c.value);a&&(a.clearCount=(a.clearCount||0)+1);try{await $fetch("/api/rooms/clear",{method:"POST",body:{matchId:d.value,userId:c.value}})}catch(e){console.error("Failed to notify clear",e)}}async function re(){const a=Y.value+1;try{const e=await $fetch("/api/rooms/next-map",{method:"POST",body:{roomId:d.value,userId:c.value,mapIndex:a}});e.map&&(R.value=e.map,Y.value=e.mapIndex,N.value=e.map.engineObstacles||[],q.value=e.map.sections||[],D.value=0)}catch(e){console.error("Failed to load next map",e)}}async function j(){try{await $fetch("/api/rooms/cleanup");const a=await $fetch("/api/rooms");E.value=a.rooms}catch(a){console.error("Failed to fetch rooms",a)}}async function ue(){if(!g.value)return;let a=f.value?.url,e=f.value?.name;if(!f.value||f.value.id==="random"){const m=U.filter(t=>t.id!=="random"),h=m[Math.floor(Math.random()*m.length)];a=h.url,e=h.name}try{const m=await $fetch("/api/rooms/create",{method:"POST",body:{title:g.value,maxPlayers:I.value,duration:y.value,userId:c.value,username:F.value,difficulty:p.value,musicUrl:a,musicTitle:e}});m.success&&(d.value=m.roomId,u.value="ROOM",J())}catch{alert("Failed to create room")}}async function ie(a){try{const e=await $fetch("/api/rooms/join",{method:"POST",body:{roomId:a,userId:c.value,username:F.value}});e.success&&(d.value=e.roomId,u.value="ROOM",J())}catch(e){alert("Cannot join room: "+(e.statusMessage||"Error"))}}async function W(){if(L(),d.value)try{await $fetch(`/api/rooms/${d.value}/leave`,{method:"POST",body:{userId:c.value}})}catch(a){console.error("Failed to leave room",a)}d.value=null,i.value=null,u.value="LOBBY",H.value=!0,j()}function J(){L(),V.value=ae(async()=>{if(d.value)try{const a={userId:c.value};u.value==="PLAY"&&(a.progress=D.value,a.y=z.value),u.value==="PLAY"&&await $fetch(`/api/rooms/${d.value}/update`,{method:"POST",body:a});const e=await $fetch(`/api/rooms/${d.value}/status`,{params:{userId:c.value}});if(i.value=e.room,A.value=e.room.players||[],e.room.status==="playing"&&e.room.startedAt){const m=new Date(e.room.startedAt).getTime(),h=Date.now(),t=Math.floor((h-m)/1e3),C=e.room.duration||60;b.value=Math.max(0,C-t)}u.value==="ROOM"&&e.room.status==="playing"&&de(e.room)}catch(a){console.error("Poll error",a)}},1e3)}async function ce(){if(!(!X.value||!d.value))try{await $fetch(`/api/rooms/${d.value}/start`,{method:"POST",body:{userId:c.value}})}catch(a){const e=a.data?.statusMessage||a.statusMessage||a.message||"Unknown error";alert("Failed to start: "+e)}}async function de(a){if(!G&&(G=!0,!!a.map)){R.value=a.map,b.value=a.duration||60,S.value=null;try{const e=new(window.AudioContext||window.webkitAudioContext);if(R.value.audioUrl){const h=await(await fetch(R.value.audioUrl)).arrayBuffer();S.value=await e.decodeAudioData(h)}else{const m=e.sampleRate*b.value;S.value=e.createBuffer(1,m,e.sampleRate)}}catch(e){console.error("Audio Load Error",e)}N.value=R.value.engineObstacles||[],u.value="PLAY",H.value=!1,G=!1,P.value&&clearInterval(P.value),P.value=ae(()=>{b.value>0?b.value--:ve()},1e3)}}function me(a){D.value=a.progress,z.value=a.y}function Q(a){a?.outcome==="win"&&(ne(),setTimeout(()=>{re()},1500))}async function ve(){try{const a=await $fetch(`/api/rooms/${d.value}/status`,{params:{userId:c.value}});a.room&&(A.value=a.room.players||[])}catch{}L(),u.value="RESULT"}async function pe(){await W(),M.push("/")}function fe(a){return`${Math.floor(a/60)}:${(a%60).toString().padStart(2,"0")}`}const ye=T(()=>[...A.value].sort((a,e)=>(e.clearCount||0)!==(a.clearCount||0)?(e.clearCount||0)-(a.clearCount||0):e.progress-a.progress).slice(0,3)),K=T(()=>[...A.value].sort((a,e)=>(e.clearCount||0)!==(a.clearCount||0)?(e.clearCount||0)-(a.clearCount||0):e.progress-a.progress)),Z=T(()=>K.value.find(a=>a.userId!==c.value)),he=T(()=>K.value[0]?.userId===c.value);return(a,e)=>{const m=Pe,h=Me;return o(),l("div",Ae,[e[17]||(e[17]=s("div",{class:"background-anim"},null,-1)),u.value==="LOBBY"?(o(),l("div",$e,[e[8]||(e[8]=s("h1",{class:"glow-text"},"MULTIPLAYER LOBBY",-1)),s("div",Le,[s("button",{onClick:e[0]||(e[0]=t=>u.value="CREATE"),class:"create-btn"},"CREATE ROOM"),s("button",{onClick:j,class:"refresh-btn"},"REFRESH")]),s("div",Be,[E.value.length===0?(o(),l("div",Ue,"NO ROOMS AVAILABLE")):(o(!0),l(w,{key:1},O(E.value,t=>(o(),l("div",{key:t._id,class:"room-card",onClick:C=>ie(t._id)},[s("div",Fe,[s("h3",Ne,n(t.title),1),s("div",Ve,[s("span",De,"HOST: "+n(t.host),1),s("span",Ge,"TIME: "+n(t.duration)+"s",1)])]),s("div",He,n(t.currentPlayers)+" / "+n(t.maxPlayers),1)],8,Ye))),128))]),s("button",{onClick:pe,class:"back-btn-simple"},"BACK TO MENU")])):u.value==="CREATE"?(o(),l("div",je,[e[13]||(e[13]=s("h1",{class:"glow-text"},"CREATE ROOM",-1)),s("div",We,[s("div",Ke,[e[9]||(e[9]=s("label",null,"ROOM TITLE",-1)),k(s("input",{"onUpdate:modelValue":e[1]||(e[1]=t=>g.value=t),class:"input-field",placeholder:"Enter room name",maxlength:"20"},null,512),[[$,g.value]])]),s("div",Xe,[s("label",null,"MAX PLAYERS: "+n(I.value),1),k(s("input",{type:"range","onUpdate:modelValue":e[2]||(e[2]=t=>I.value=t),min:"2",max:"10",class:"range-slider"},null,512),[[$,I.value,void 0,{number:!0}]])]),s("div",qe,[e[10]||(e[10]=s("label",null,"DURATION (Seconds: 30 ~ 1800)",-1)),k(s("input",{type:"number","onUpdate:modelValue":e[3]||(e[3]=t=>y.value=t),class:"input-field",min:"30",max:"1800",step:"10"},null,512),[[$,y.value,void 0,{number:!0}]]),e[11]||(e[11]=s("div",{class:"duration-hint"},"30s (30sec) ~ 1800s (30min)",-1))]),s("div",ze,[s("label",null,"DIFFICULTY: "+n(p.value),1),k(s("input",{type:"range","onUpdate:modelValue":e[4]||(e[4]=t=>p.value=t),min:"1",max:"30",class:"range-slider"},null,512),[[$,p.value,void 0,{number:!0}]])]),s("div",Je,[e[12]||(e[12]=s("label",null,"MUSIC",-1)),k(s("select",{"onUpdate:modelValue":e[5]||(e[5]=t=>f.value=t),class:"input-field select-field"},[(o(),l(w,null,O(U,t=>s("option",{key:t.id,value:t},n(t.name),9,Qe)),64))],512),[[we,f.value]])])]),s("div",Ze,[s("button",{onClick:ue,class:"confirm-btn"},"CREATE"),s("button",{onClick:e[6]||(e[6]=t=>u.value="LOBBY"),class:"cancel-btn"},"CANCEL")])])):u.value==="ROOM"?(o(),l("div",es,[s("h2",ss,n(i.value?.title),1),s("div",as,[s("span",null,"TIME: "+n(i.value?.duration)+"s",1),s("span",null,"DIFF: "+n(i.value?.difficulty),1),s("span",null,"MUSIC: "+n(i.value?.musicTitle||"Random"),1),s("span",null,"PLAYERS: "+n(i.value?.players.length)+" / "+n(i.value?.maxPlayers),1)]),s("div",ts,[s("div",os,[(o(!0),l(w,null,O(i.value?.players,t=>(o(),l("div",{key:t.userId,class:B(["player-card-lg",{host:t.isHost}])},[e[14]||(e[14]=s("div",{class:"avatar-lg"},"◆",-1)),s("div",ls,n(t.username),1),t.userId===c.value?(o(),l("span",ns,"YOU")):_("",!0),t.isHost?(o(),l("span",rs,"HOST")):_("",!0)],2))),128)),(o(!0),l(w,null,O(i.value?i.value.maxPlayers-i.value.players.length:0,t=>(o(),l("div",{key:`placeholder-${t}`,class:"player-card-lg empty"},[...e[15]||(e[15]=[s("div",{class:"avatar-lg empty"},"+",-1),s("div",{class:"player-name"},"EMPTY",-1)])]))),128))]),s("div",us,[d.value?(o(),se(m,{key:0,roomId:d.value,userId:c.value,username:F.value,messages:i.value?.messages||[]},null,8,["roomId","userId","username","messages"])):_("",!0)])]),X.value?(o(),l("div",is,[s("button",{onClick:ce,class:"start-btn",disabled:!i.value||i.value.players.length<1},"START GAME",8,cs),i.value&&i.value.players.length<2?(o(),l("p",ds,"Waiting for players...")):_("",!0)])):(o(),l("div",ms,[...e[16]||(e[16]=[s("div",{class:"loading-spinner"},null,-1),s("p",{class:"waiting-text"},"WAITING FOR HOST TO START...",-1)])])),s("button",{onClick:W,class:"leave-btn"},"LEAVE ROOM")])):u.value==="PLAY"||u.value==="RESULT"?(o(),l("div",vs,[u.value==="RESULT"?(o(),l("div",ps,[s("div",fs,[s("h1",ys,n(he.value?"VICTORY":"FINISH"),1),s("div",hs,[(o(!0),l(w,null,O(K.value,(t,C)=>(o(),l("div",{key:t.userId,class:B(["result-row",{winner:C===0,me:t.userId===c.value}])},[s("span",_s,"#"+n(C+1),1),s("span",gs,n(t.username),1),s("span",Is,n(t.progress.toFixed(1))+"% ("+n(t.clearCount||0)+" Wins)",1)],2))),128))]),s("button",{onClick:W,class:"action-btn"},"EXIT TO LOBBY")])])):_("",!0),s("div",bs,[s("div",{class:B(["timer-display",{critical:b.value<30}])},n(fe(b.value)),3),s("div",Cs,[(o(!0),l(w,null,O(ye.value,(t,C)=>(o(),l("div",{key:t.userId,class:"lb-item"},[s("span",Ts,"#"+n(C+1),1),s("span",ws,n(t.username),1),s("span",Os,n(t.progress.toFixed(0))+"%",1)]))),128))])]),S.value?(o(),se(h,{key:Y.value,audioBuffer:S.value,obstacles:N.value,sections:q.value,loadMap:R.value,multiplayerMode:!0,opponentY:Z.value?.y||360,opponentProgress:Z.value?.progress||0,onExit:Q,onComplete:e[7]||(e[7]=t=>Q({outcome:"win"})),onProgressUpdate:me},null,8,["audioBuffer","obstacles","sections","loadMap","opponentY","opponentProgress"])):_("",!0)])):_("",!0)])}}}),Ps=oe(Ms,[["__scopeId","data-v-abf20490"]]);export{Ps as default};
