import{e as vt,r as y,h as pe,j as je,C as Ke,i as yt,c as p,a as c,k as P,n as gt,m as me,t as A,p as pt,v as mt,o as m}from"./OCD2nr9N.js";import{G as wt}from"./DP0Q2vyH.js";import{_ as Mt}from"./DlAUqK2U.js";const Pt={class:"game-wrapper"},St={class:"game-container"},xt={class:"hud"},Tt={class:"hud-top-left"},kt={class:"game-actions"},Ct={class:"title-container"},_t={key:0,class:"game-title"},It={key:1,class:"game-title tutorial"},At={class:"progress-bar-container"},Rt={class:"progress-text"},Bt={class:"score-container"},Ot={class:"score-val"},Et={class:"speed-indicator"},Dt={key:0,class:"mini-badge"},Lt={key:1,class:"mini-badge"},Gt={key:2,class:"autoplay-badge"},Nt={key:3,class:"autoplay-badge tutorial"},Xt={key:4,class:"autoplay-badge practice"},Ut={key:0,class:"status-overlay fail"},Ht={class:"status-content"},Yt={key:0,class:"new-best-text"},Wt={class:"status-sub"},Vt={class:"status-stats"},zt={key:1,class:"status-overlay win"},Ft={class:"status-content"},Jt={class:"status-stats"},$t={class:"video-save-section"},jt=["disabled"],Kt={key:0},qt={key:1},Zt={key:1,class:"save-success"},Qt={key:0,class:"rating-vote pointer-events-auto"},bt={class:"rating-controls"},ea={class:"rating-value"},ta={key:1,class:"rating-done"},aa={key:2,class:"overlay countdown-overlay"},la={class:"countdown-text"},ia={key:3,class:"validation-status"},na={class:"mini-progress"},oa={key:4,class:"checkpoint-indicator"},sa={key:5,class:"controls-hint"},ra={key:0,class:"tutorial-message-bubble"},ca={key:1},ua={key:0},qe=.1,da=vt({__name:"GameCanvas",props:{audioBuffer:{},obstacles:{},sections:{},autoRetry:{type:Boolean},loadMap:{},isViewOnly:{type:Boolean},multiplayerMode:{type:Boolean},difficulty:{},opponentY:{},opponentProgress:{},practiceMode:{type:Boolean},tutorialMode:{type:Boolean},invincible:{type:Boolean}},emits:["retry","exit","complete","map-ready","progress-update","record-update"],setup(I,{emit:Ze}){const r=I,N=Ze,O=y(null),a=y(new wt),x=y(!1),E=y(!1),D=y(0),W=y(0),j=y(""),U=y(0),K=y(null),Ge=y(0),we=y(!1),Me=y(!1),V=y(r.difficulty||10),ae=y(!1),Pe=y(!1),z=y(0),Se=y(!1),le=y(15),ie=y(!1),ne=y(!1),oe=y(!1);let F=null,se=[];const Qe=async()=>{if(!(!r.loadMap?._id||ie.value))try{await $fetch(`/api/maps/${r.loadMap._id}/rate`,{method:"POST",body:{rating:le.value}}),ie.value=!0}catch{alert("Failed to submit rating.")}},be=()=>{if(O.value)try{se=[],ne.value=!1;const e=O.value.captureStream(30);if(g&&w)try{const u=g.createMediaStreamDestination();w.connect(u),u.stream.getAudioTracks().forEach(L=>e.addTrack(L))}catch{console.log("[Recording] Audio capture not available, video only")}const i={mimeType:"video/webm;codecs=vp9"};MediaRecorder.isTypeSupported(i.mimeType)||(i.mimeType="video/webm"),F=new MediaRecorder(e,i),F.ondataavailable=u=>{u.data&&u.data.size>0&&se.push(u.data)},F.start(100),console.log("[Recording] Started")}catch(e){console.error("[Recording] Failed to start:",e)}},Ne=()=>{F&&F.state!=="inactive"&&(F.stop(),console.log("[Recording] Stopped"))},et=async()=>{if(se.length===0){alert("ÎÖπÌôîÎêú ÏòÅÏÉÅÏù¥ ÏóÜÏäµÎãàÎã§. Îã§Ïãú ÌîåÎ†àÏù¥Ìï¥Ï£ºÏÑ∏Ïöî.");return}oe.value=!0;try{const e=new Blob(se,{type:"video/webm"}),i=r.loadMap?.title||"gameplay",u=new Date().toISOString().slice(0,19).replace(/[:-]/g,""),k=`UMM_${i}_${u}.webm`,L=URL.createObjectURL(e),X=document.createElement("a");X.href=L,X.download=k,document.body.appendChild(X),X.click(),document.body.removeChild(X),URL.revokeObjectURL(L),ne.value=!0,console.log("[Recording] Saved:",k)}catch(e){console.error("[Recording] Save failed:",e),alert("ÏòÅÏÉÅ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.")}finally{oe.value=!1}},R=y(0),re=y(!1),xe=y(0),q=y(!1);let Te=null;const ke=y(360),Ce=y(0);let g=null,w=null;const C=y([]);let ce=null,ue=null,de=!1;const Xe=pe(()=>{if(!r.loadMap?.messages)return null;const e=W.value,i=r.loadMap.messages.filter(u=>u.progress<=e);return i.length===0?null:i[i.length-1].text});let Ue,fe=0;const B=y(!1),tt=pe(()=>{const e=a.value.speedMultiplier;return e<.6?"#aa5500":e<.8?"#ff8800":e<1.1?"#4488ff":e<1.5?"#44ff44":e<1.8?"#ff44ff":"#ff4444"}),at=pe(()=>{const e=a.value.speedMultiplier;return e<.6?"0.25x":e<.8?"0.5x":e<1.1?"1x":e<1.5?"2x":e<1.8?"3x":"4x"});pe(()=>V.value<8?"EASY":V.value<16?"NORMAL":V.value<24?"HARD":"IMPOSSIBLE");const lt=async()=>{if(!g)return;const e=async i=>{try{const k=await(await fetch(i)).arrayBuffer();return await g.decodeAudioData(k)}catch(u){return console.error(`Failed to load sfx: ${i}`,u),null}};ce||(ce=await e("/audio/click_down.mp3")),ue||(ue=await e("/audio/click_up.mp3"))},he=(e,i=.5)=>{if(!(!g||!e))try{const u=g.createBufferSource(),k=g.createGain();u.buffer=e,k.gain.value=i,u.connect(k),k.connect(g.destination),u.start()}catch{}},_e=()=>{if(!r.audioBuffer||!O.value)return;ve(),g||(g=new(window.AudioContext||window.webkitAudioContext)),g.state==="suspended"&&g.resume(),lt();const e=r.multiplayerMode?!1:a.value.isAutoplay;a.value.setMapConfig({density:1,portalFrequency:.15,difficulty:V.value}),a.value.reset(),a.value.isAutoplay=e,ae.value=e,r.loadMap?(a.value.loadMapData(r.loadMap),V.value=r.loadMap.difficulty,q.value=!0,r.tutorialMode&&r.loadMap.autoplayLog&&r.loadMap.autoplayLog.length>0&&(a.value.isAutoplay=!0,ae.value=!0,console.log("[Tutorial] Using saved autoplayLog, length:",r.loadMap.autoplayLog.length)),r.loadMap.bestScore?z.value=Math.min(100,r.loadMap.bestScore/10):z.value=0):(a.value.generateMap(r.obstacles,r.sections,r.audioBuffer.duration,void 0,!1),r.tutorialMode&&(a.value.isAutoplay=!0,ae.value=!0),st()),x.value=!1,E.value=!1,j.value="",U.value=0,W.value=0,D.value=0,we.value=!1,de=!1,N("progress-update",{progress:0,ghostProgress:0}),N("progress-update",{progress:0,ghostProgress:0}),C.value.length===0?(b(),Ye()):(C.value=[],b(),Ye()),Ge.value++},it=()=>{Pe.value||(N("map-ready",{difficulty:V.value,engineObstacles:a.value.obstacles,enginePortals:a.value.portals,autoplayLog:a.value.autoplayLog,duration:r.audioBuffer.duration}),Pe.value=!0)},nt=()=>{it()},He=()=>{if(!r.practiceMode||x.value)return;const e={x:a.value.playerX,y:a.value.playerY,velocity:a.value.velocity,isHolding:a.value.isHolding,cameraX:a.value.cameraX,isGravityInverted:a.value.isGravityInverted,speedMultiplier:a.value.speedMultiplier,isMini:a.value.isMini,waveAngle:a.value.waveAngle,score:a.value.score,progress:a.value.progress,startTimeOffset:(g?.currentTime||0)-a.value.startTime,obstacles:JSON.parse(JSON.stringify(a.value.obstacles)),portals:JSON.parse(JSON.stringify(a.value.portals)),timestamp:Date.now()};C.value.push(e);const i=O.value?.getContext("2d");i&&(i.save(),i.fillStyle="#00ff00",i.font="bold 30px Arial",i.fillText("CHECKPOINT SET!",O.value.width/2,100),i.restore()),console.log("Checkpoint set at",checkpoint.progress+"%")},ot=()=>{if(C.value.length===0||!r.practiceMode)return;const e=C.value[C.value.length-1];if(a.value.playerX=e.x,a.value.playerY=e.y,a.value.velocity=e.velocity,a.value.isHolding=e.isHolding,a.value.cameraX=e.cameraX,a.value.isGravityInverted=e.isGravityInverted,a.value.speedMultiplier=e.speedMultiplier,a.value.isMini=e.isMini,a.value.waveAngle=e.waveAngle,a.value.score=e.score,a.value.progress=e.progress,a.value.obstacles=JSON.parse(JSON.stringify(e.obstacles)),a.value.portals=JSON.parse(JSON.stringify(e.portals)),x.value=!1,E.value=!1,j.value="",B.value=!0,a.value.isDead=!1,a.value.isPlaying=!0,w)try{w.stop()}catch{}if(g&&r.audioBuffer){w=g.createBufferSource(),w.buffer=r.audioBuffer,w.connect(g.destination);const i=e.startTimeOffset;a.value.startTime=g.currentTime-i,w.start(0,i),fe=g.currentTime}a.value.trail=[],Ie()},st=async()=>{if(!r.multiplayerMode){if(a.value.autoplayLog.length>0){q.value=!0;return}q.value=!1,re.value=!0,xe.value=0;for(let e=0;;e++)try{if(e>0&&(console.log(`[Validation] Retry ${e+1}: Regenerating map with updated offsets...`),a.value.generateMap(r.obstacles,r.sections,r.audioBuffer.duration,void 0,!1,e)),await a.value.computeAutoplayLogAsync(a.value.playerX,a.value.playerY,u=>{xe.value=u*100})){console.log(`[Validation] Path found on Attempt ${e+1}!`),q.value=!0;break}else if(e>100){console.error("[Validation] Safeguard triggered: Stopped after 100 failed retries.");break}}catch(i){console.error("Background validation error:",i);break}re.value=!1}},Ye=()=>{K.value="GO!",setTimeout(()=>{K.value=null,rt()},400)},rt=()=>{if(!g||!r.audioBuffer)return;w=g.createBufferSource(),w.buffer=r.audioBuffer,w.connect(g.destination),w.onended=()=>{!x.value&&B.value&&Ve()};const e=g.currentTime+.05;w.start(e),a.value.isPlaying=!0,a.value.startTime=e,B.value=!0,fe=g.currentTime,be(),Ie()},ve=()=>{if(B.value=!1,Te&&clearTimeout(Te),w){try{w.stop()}catch{}w.disconnect(),w=null}if(g){try{g.close()}catch{}g=null}cancelAnimationFrame(Ue)},Z=e=>{if(e){const i=e.target;if(i&&(i.tagName==="INPUT"||i.tagName==="BUTTON"||i.closest(".no-prevent-default")))return;e.preventDefault()}!B.value||a.value.isAutoplay||(a.value.isHolding||he(ce,1.5),a.value.setHolding(!0))},Q=e=>{if(e){const i=e.target;if(i&&(i.tagName==="INPUT"||i.tagName==="BUTTON"||i.closest(".no-prevent-default")))return;e.preventDefault()}a.value.isAutoplay||(a.value.isHolding&&he(ue,1),a.value.setHolding(!1))},We=e=>{e.code==="KeyC"&&r.practiceMode?He():e.code==="KeyX"&&r.practiceMode&&C.value.length>0&&C.value.pop()};je(()=>{window.addEventListener("keydown",We)}),Ke(()=>{window.removeEventListener("keydown",We),ve()});const ct=()=>{if(x.value=!0,j.value=a.value.failReason||"CRASHED",U.value=a.value.getProgress(),B.value=!1,U.value>z.value?(z.value=U.value,Se.value=!0):Se.value=!1,w)try{w.stop()}catch{}setTimeout(()=>{Ne(),N("record-update",{score:D.value,progress:W.value})},3e3);const e=()=>{x.value&&(b(),requestAnimationFrame(e))};e(),Te=setTimeout(()=>{x.value&&(r.practiceMode&&C.value.length>0?ot():_e())},r.practiceMode?1e3:3e3)},Ve=()=>{if(E.value=!0,B.value=!1,D.value=Math.floor(D.value+1e3),U.value=100,w)try{w.stop()}catch{}setTimeout(()=>{Ne(),N("record-update",{score:D.value,progress:100})},3e3),N("complete",{score:D.value});const e=()=>{E.value&&(b(),requestAnimationFrame(e))};e()},Ie=()=>{!B.value&&!x.value&&!E.value||(ut(),b(),B.value&&(Ue=requestAnimationFrame(Ie)))},ut=()=>{if(!g)return;const e=g.currentTime,i=e-a.value.startTime;let u=e-fe;if(fe=e,u>.1&&(u=.1),u<0&&(u=0),a.value.update(u,i),R.value=i,a.value.isAutoplay&&(a.value.isHolding&&!de?he(ce,1.5):!a.value.isHolding&&de&&he(ue,1),de=a.value.isHolding),D.value=a.value.score,W.value=a.value.progress,we.value=a.value.isGravityInverted,Me.value=a.value.isMini,a.value.isDead?r.invincible?(a.value.isDead=!1,a.value.isPlaying=!0):x.value||ct():!a.value.isPlaying&&B.value&&!x.value&&!E.value&&Ve(),(r.multiplayerMode||r.tutorialMode)&&a.value.totalLength>0){const k=a.value.playerX/a.value.totalLength*100;N("progress-update",{progress:Math.min(100,k),y:a.value.playerY,ghostProgress:r.opponentProgress||0});const L=r.opponentY!==void 0?r.opponentY:360,X=r.opponentProgress||0;ke.value+=(L-ke.value)*qe,Ce.value+=(X-Ce.value)*qe}},b=()=>{const e=O.value?.getContext("2d");if(!e||!O.value)return;const i=O.value.width,u=O.value.height,k=e.createLinearGradient(0,0,0,u);k.addColorStop(0,"#0a0a1a"),k.addColorStop(.5,"#151530"),k.addColorStop(1,"#0a0a1a"),e.fillStyle=k,e.fillRect(0,0,i,u),e.save(),e.strokeStyle="rgba(80, 80, 180, 0.08)",e.lineWidth=1;const L=40,X=-a.value.cameraX%L;for(let t=X;t<i;t+=L)e.beginPath(),e.moveTo(t,0),e.lineTo(t,u),e.stroke();for(let t=0;t<u;t+=L)e.beginPath(),e.moveTo(0,t),e.lineTo(i,t),e.stroke();e.restore(),e.save(),e.translate(-a.value.cameraX,0);const Ae=a.value.isGravityInverted?"#ffff00":"#ff00ff",Re=a.value.isGravityInverted?"#ffff00":"#00ffff";if(e.fillStyle=Ae,e.globalAlpha=.15,e.fillRect(a.value.cameraX,0,i,a.value.minY),e.globalAlpha=1,e.fillStyle=Re,e.globalAlpha=.15,e.fillRect(a.value.cameraX,a.value.maxY,i,u-a.value.maxY),e.globalAlpha=1,e.strokeStyle=Ae,e.lineWidth=3,e.shadowBlur=15,e.shadowColor=Ae,e.beginPath(),e.moveTo(a.value.cameraX,a.value.minY),e.lineTo(a.value.cameraX+i,a.value.minY),e.stroke(),e.strokeStyle=Re,e.shadowColor=Re,e.beginPath(),e.moveTo(a.value.cameraX,a.value.maxY),e.lineTo(a.value.cameraX+i,a.value.maxY),e.stroke(),e.shadowBlur=0,a.value.portals.forEach(t=>{if(t.x+t.width<a.value.cameraX-50||t.x>a.value.cameraX+i+50)return;e.save(),t.angle&&(e.translate(t.x+t.width/2,t.y+t.height/2),e.rotate(t.angle*Math.PI/180),e.translate(-(t.x+t.width/2),-(t.y+t.height/2)));const T=a.value.getPortalColor(t.type),l=a.value.getPortalSymbol(t.type),n=t.type==="mini_pink"||t.type==="mini_green";if(e.globalAlpha=t.activated?.3:1,e.fillStyle=T,e.shadowBlur=20,e.shadowColor=T,n){const o=t.x+t.width/2,s=t.y+t.height/2,h=t.width/2,d=t.height/2,v=8;e.beginPath();for(let f=0;f<=v*2;f++){const M=Math.PI*2*f/(v*2)-Math.PI/2,_=f%2===0?1:.6,G=o+Math.cos(M)*h*_,Y=s+Math.sin(M)*d*_;f===0?e.moveTo(G,Y):e.lineTo(G,Y)}e.closePath(),e.fill()}else e.beginPath(),e.roundRect(t.x,t.y,t.width,t.height,12),e.fill(),e.fillStyle="rgba(255,255,255,0.4)",e.beginPath(),e.roundRect(t.x+6,t.y+6,t.width-12,t.height-12,8),e.fill();e.shadowBlur=0,e.fillStyle="#000",e.font="bold 18px Outfit",e.textAlign="center",e.textBaseline="middle",e.fillText(l,t.x+t.width/2,t.y+t.height/2),e.restore()}),a.value.obstacles.forEach(t=>{if(t.x+t.width<a.value.cameraX-50||t.x>a.value.cameraX+i+50)return;if(e.save(),t.angle!==void 0&&t.angle!==0&&(e.translate(t.x+t.width/2,t.y+t.height/2),e.rotate(t.angle*Math.PI/180),e.translate(-(t.x+t.width/2),-(t.y+t.height/2))),t.type==="spike"||t.type==="mini_spike"){const l=t.type==="mini_spike";e.fillStyle=l?"#ff6666":"#ff4444",e.shadowBlur=l?8:12,e.shadowColor="#ff4444",e.beginPath(),t.y>300?(e.moveTo(t.x,t.y+t.height),e.lineTo(t.x+t.width/2,t.y),e.lineTo(t.x+t.width,t.y+t.height)):(e.moveTo(t.x,t.y),e.lineTo(t.x+t.width/2,t.y+t.height),e.lineTo(t.x+t.width,t.y)),e.closePath(),e.fill()}else if(t.type==="block")e.fillStyle="#444",e.shadowBlur=5,e.shadowColor="#666",e.fillRect(t.x,t.y,t.width,t.height),e.fillStyle="#555",e.fillRect(t.x+2,t.y+2,t.width-4,t.height-4);else if(t.type==="triangle"||t.type==="steep_triangle"){const l=t.type==="steep_triangle";e.fillStyle=l?"#222":"#333",e.shadowBlur=5,e.shadowColor="#555",e.beginPath(),e.moveTo(t.x,t.y+t.height),e.lineTo(t.x+t.width,t.y+t.height),e.lineTo(t.x+t.width,t.y),e.closePath(),e.fill(),e.fillStyle=l?"#444":"#555";const n=4;e.beginPath(),e.moveTo(t.x+n*2,t.y+t.height-n),e.lineTo(t.x+t.width-n,t.y+t.height-n),e.lineTo(t.x+t.width-n,t.y+n*2),e.fill()}else if(t.type==="saw"){const l=t.x+t.width/2,n=t.y+t.height/2,o=t.width/2,s=t.height/2;e.fillStyle="#ffaa00",e.shadowBlur=20,e.shadowColor="#ffaa00",e.beginPath(),e.ellipse(l,n,o,s,0,0,Math.PI*2),e.fill(),e.fillStyle="#ff6600";const h=10,d=R.value*8;for(let v=0;v<h;v++){const f=Math.PI*2*v/h+d,M=l+Math.cos(f)*o*.75,S=n+Math.sin(f)*s*.75;e.beginPath(),e.ellipse(M,S,o*.15,s*.15,0,0,Math.PI*2),e.fill()}e.fillStyle="#cc8800",e.beginPath(),e.ellipse(l,n,o*.25,s*.25,0,0,Math.PI*2),e.fill()}else if(t.type==="spike_ball"){const l=t.x+t.width/2,n=t.y+t.height/2,o=t.width/2,s=t.height/2;e.fillStyle="#666",e.shadowBlur=15,e.shadowColor="#444";const h=8,d=R.value*3;e.fillStyle="#444";for(let f=0;f<h;f++){const M=Math.PI*2*f/h+d;e.beginPath();const S=l+Math.cos(M)*o*1.2,_=n+Math.sin(M)*s*1.2;e.moveTo(l+Math.cos(M-.2)*o*.8,n+Math.sin(M-.2)*s*.8),e.lineTo(S,_),e.lineTo(l+Math.cos(M+.2)*o*.8,n+Math.sin(M+.2)*s*.8),e.fill()}const v=e.createRadialGradient(l-o*.3,n-s*.3,o*.1,l,n,o);v.addColorStop(0,"#888"),v.addColorStop(1,"#222"),e.fillStyle=v,e.beginPath(),e.ellipse(l,n,o*.8,s*.8,0,0,Math.PI*2),e.fill()}else if(t.type==="laser"){const l=t.y+t.height/2,n=Math.sin(R.value*15)*5+10;e.strokeStyle="#ff3333",e.lineWidth=2,e.shadowBlur=Math.max(0,n),e.shadowColor="#ff0000",e.beginPath(),e.moveTo(t.x,l),e.lineTo(t.x+t.width,l),e.stroke(),e.strokeStyle="#ffffff",e.lineWidth=1,e.shadowBlur=0,e.beginPath(),e.moveTo(t.x,l),e.lineTo(t.x+t.width,l),e.stroke(),e.fillStyle="#777",e.fillRect(t.x,t.y,8,t.height),e.fillRect(t.x+t.width-8,t.y,8,t.height)}else if(t.type==="v_laser"){const l=t.x+t.width/2,n=Math.sin(R.value*15)*5+10;e.strokeStyle="#ff3333",e.lineWidth=2,e.shadowBlur=Math.max(0,n),e.shadowColor="#ff0000",e.beginPath(),e.moveTo(l,t.y),e.lineTo(l,t.y+t.height),e.stroke(),e.strokeStyle="#ffffff",e.lineWidth=1,e.shadowBlur=0,e.beginPath(),e.moveTo(l,t.y),e.lineTo(l,t.y+t.height),e.stroke(),e.fillStyle="#777",e.fillRect(t.x,t.y,t.width,8),e.fillRect(t.x,t.y+t.height-8,t.width,8)}else if(t.type==="slope")e.fillStyle="#222",e.beginPath(),t.angle>0?(e.moveTo(t.x,t.y+t.height),e.lineTo(t.x+t.width,t.y),e.lineTo(t.x,t.y)):(e.moveTo(t.x+t.width,t.y+t.height),e.lineTo(t.x,t.y),e.lineTo(t.x+t.width,t.y)),e.closePath(),e.fill(),e.strokeStyle="rgba(100,200,255,0.3)",e.lineWidth=3,e.stroke();else if(t.type==="mine"){const l=t.x+t.width/2,n=t.y+t.height/2,o=t.width/2,s=Math.sin(R.value*10)*.1+.9;e.fillStyle="#ff3333",e.shadowBlur=10,e.shadowColor="#ff0000",e.beginPath();for(let h=0;h<6;h++){const d=Math.PI/3*h+R.value*2,v=l+Math.cos(d)*o*s,f=n+Math.sin(d)*o*s;h===0?e.moveTo(v,f):e.lineTo(v,f)}e.closePath(),e.fill(),e.fillStyle="#550000",e.beginPath(),e.arc(l,n,o*.4,0,Math.PI*2),e.fill()}else if(t.type==="orb"){const l=t.x+t.width/2,n=t.y+t.height/2,o=t.width/2,s=t.height/2,h=Math.sin(R.value*5)*.1+1,d=e.createRadialGradient(l,n,o*.1,l,n,o*h);d.addColorStop(0,"#ffffff"),d.addColorStop(.4,"#aa44ff"),d.addColorStop(.8,"#4400cc"),d.addColorStop(1,"rgba(68, 0, 204, 0)"),e.fillStyle=d,e.globalCompositeOperation="lighter",e.beginPath(),e.ellipse(l,n,o*h,s*h,0,0,Math.PI*2),e.fill(),e.globalCompositeOperation="source-over"}else if(t.type==="hammer"){const l=t.x+t.width/2,n=t.y+t.height/2;e.strokeStyle="#888",e.linewidth=4,e.beginPath(),e.moveTo(l,n),e.lineTo(l,n+40),e.stroke(),e.fillStyle="#aaa",e.beginPath(),e.arc(l,n,t.width/2,0,Math.PI*2),e.fill()}else if(["rotor","saw","spark_mine"].includes(t.type)){const l=t.x+t.width/2,n=t.y+t.height/2,o=t.width/2;if(t.type==="rotor"){e.fillStyle="#ddd";const s=4,h=(t.angle||0)*Math.PI/180;for(let d=0;d<s;d++){const v=h+Math.PI*2*d/s;e.beginPath(),e.moveTo(l,n),e.arc(l,n,o,v-.2,v+.2),e.fill()}}else if(t.type==="spark_mine"){e.fillStyle="#ffaa00",e.beginPath();const s=12,h=(t.angle||0)*Math.PI/180;for(let d=0;d<s*2;d++){const v=d%2===0?o:o*.4,f=h+Math.PI*d/s;e.lineTo(l+Math.cos(f)*v,n+Math.sin(f)*v)}e.fill()}}else if(t.type==="laser_beam"){const l=t.y+t.height/2;e.strokeStyle="#00ffff",e.lineWidth=t.height,e.shadowColor="#00ffff",e.shadowBlur=20,e.beginPath(),e.moveTo(t.x,l),e.lineTo(t.x+t.width,l),e.stroke(),e.shadowBlur=0,e.strokeStyle="#fff",e.lineWidth=t.height*.3,e.stroke()}else if(t.type==="piston_v")e.fillStyle="#555",e.fillRect(t.x,t.y,t.width,t.height),e.fillStyle="#888",e.fillRect(t.x+t.width*.3,t.y,t.width*.4,t.height),e.fillStyle="#333",t.y<360?e.fillRect(t.x,t.y+t.height-20,t.width,20):e.fillRect(t.x,t.y,t.width,20);else if(t.type==="cannon")e.fillStyle="#444",e.beginPath(),e.arc(t.x+t.width/2,t.y+t.height/2,t.width/2,0,Math.PI*2),e.fill(),e.fillStyle="#000",e.beginPath(),e.arc(t.x+t.width/2,t.y+t.height/2,t.width/3,0,Math.PI*2),e.fill();else if(["falling_spike","growing_spike","crusher_jaw"].includes(t.type)){e.fillStyle="#ff4444",e.beginPath();const l=t.x+t.width/2;t.type==="falling_spike"?(e.moveTo(t.x,t.y),e.lineTo(t.x+t.width,t.y),e.lineTo(l,t.y+t.height)):(e.moveTo(t.x,t.y+t.height),e.lineTo(t.x+t.width,t.y+t.height),e.lineTo(l,t.y)),e.fill()}else if(t.type==="swing_blade"){const l=t.x+t.width/2,n=t.y;e.strokeStyle="#eee",e.lineWidth=2,e.beginPath(),e.moveTo(l,n),e.lineTo(l,n+t.height),e.stroke(),e.fillStyle="#ccc",e.beginPath(),e.ellipse(l,n+t.height,t.width/2,t.height/2,0,0,Math.PI*2),e.fill()}else if(t.type==="mine"){e.fillStyle="#222",e.strokeStyle="#ff3333";let l=1;if(t.customData?.pulseSpeed){const d=R.value,v=t.customData.pulseSpeed||2,f=t.customData.pulseAmount||.2;l=1+Math.sin(d*v)*f}const n=t.width/2*l,o=t.x+t.width/2,s=t.y+t.height/2;e.beginPath(),e.arc(o,s,n,0,Math.PI*2),e.fill(),e.stroke();const h=8;e.beginPath();for(let d=0;d<h;d++){const v=Math.PI*2*d/h,f=rx,M=ry,S=rx+6,_=ry+6;e.moveTo(o+Math.cos(v)*f,s+Math.sin(v)*M),e.lineTo(o+Math.cos(v)*S,s+Math.sin(v)*_)}e.stroke()}else if(t.type==="planet"){const l=t.x+t.width/2,n=t.y+t.height/2,o=t.width/2,s=e.createRadialGradient(l,n-o*.3,o*.1,l,n,o);s.addColorStop(0,"#4488ff"),s.addColorStop(1,"#002266"),e.fillStyle=s,e.beginPath(),e.arc(l,n,o,0,Math.PI*2),e.fill();const h=R.value,d=t.customData?.orbitCount??2,v=t.customData?.orbitSpeed??1,f=t.customData?.orbitDistance??t.width*.8;for(let M=0;M<d;M++){const S=h*v+M*(Math.PI*2/d),_=l+Math.cos(S)*f,G=n+Math.sin(S)*f;e.fillStyle="#88ccff",e.beginPath(),e.arc(_,G,8,0,Math.PI*2),e.fill()}}else if(t.type==="star"){const l=t.x+t.width/2,n=t.y+t.height/2,o=t.width/2,s=R.value,h=1+Math.sin(s*5)*.05,d=e.createRadialGradient(l,n,o*.2,l,n,o*h);if(d.addColorStop(0,"#ffff88"),d.addColorStop(.5,"#ffaa00"),d.addColorStop(1,"rgba(255, 68, 0, 0)"),e.fillStyle=d,e.beginPath(),e.arc(l,n,o*1.2*h,0,Math.PI*2),e.fill(),e.fillStyle="#fff",e.beginPath(),e.arc(l,n,o*.6,0,Math.PI*2),e.fill(),t.children&&t.children.length>0){const f=t.children,M=t.customData?.orbitSpeed??1;f.forEach((S,_)=>{const G=s*M+_*(Math.PI*2/f.length),Y=t.customData?.orbitDistance??t.width*.85,te=l+Math.cos(G)*Y,Oe=n+Math.sin(G)*Y;if(e.fillStyle="#00ff88",e.beginPath(),e.arc(te,Oe,14,0,Math.PI*2),e.fill(),S.type==="planet"){const Ee=S.customData?.orbitCount??2,De=S.customData?.orbitSpeed??2,J=S.customData?.orbitDistance??S.width*.8;for(let $=0;$<Ee;$++){const ge=s*De+$*(Math.PI*2/Ee),Le=te+Math.cos(ge)*J,ht=Oe+Math.sin(ge)*J;e.fillStyle="#fff",e.beginPath(),e.arc(Le,ht,4,0,Math.PI*2),e.fill()}}})}else{const f=t.customData?.orbitCount??(t.type==="star"?0:3);if(f>0){const M=t.customData?.orbitSpeed??1,S=t.customData?.orbitDistance??t.width*.85;for(let _=0;_<f;_++){const G=s*M+_*(Math.PI*2/f),Y=l+Math.cos(G)*S,te=n+Math.sin(G)*S;if(e.fillStyle="#00ff88",e.beginPath(),e.arc(Y,te,14,0,Math.PI*2),e.fill(),t.type==="star"&&t.customData?.nestedOrbit){const De=M*2.5;for(let J=0;J<2;J++){const $=s*De+J*(Math.PI*2/2),ge=Y+Math.cos($)*25,Le=te+Math.sin($)*25;e.fillStyle="#fff",e.beginPath(),e.arc(ge,Le,4,0,Math.PI*2),e.fill()}}}}}}else e.fillStyle="#ff00ff",e.fillRect(t.x,t.y,t.width,t.height),e.fillStyle="#fff",e.font="10px Arial",e.fillText("?",t.x+t.width/2-3,t.y+t.height/2+3);e.restore()}),a.value.isAutoplay&&a.value.aiPredictedPath.length>1){e.save(),e.beginPath(),e.moveTo(a.value.aiPredictedPath[0].x,a.value.aiPredictedPath[0].y);for(let t=1;t<a.value.aiPredictedPath.length;t++)e.lineTo(a.value.aiPredictedPath[t].x,a.value.aiPredictedPath[t].y);e.strokeStyle="rgba(0, 255, 255, 0.15)",e.lineWidth=12,e.lineCap="round",e.lineJoin="round",e.stroke(),e.strokeStyle="rgba(0, 255, 255, 0.6)",e.lineWidth=3,e.stroke(),e.restore()}if(a.value.trail.length>1){e.beginPath(),e.moveTo(a.value.trail[0].x,a.value.trail[0].y);for(let T=1;T<a.value.trail.length;T++){const l=a.value.trail[T];l&&e.lineTo(l.x,l.y)}const t=a.value.isGravityInverted?"rgba(255, 255, 0, 0.6)":"rgba(0, 255, 255, 0.6)";e.strokeStyle=t,e.lineWidth=14,e.lineCap="round",e.lineJoin="round",e.stroke(),e.shadowBlur=0}if(r.multiplayerMode){const T=Ce.value/100*a.value.totalLength,l=ke.value;e.save(),e.fillStyle="rgba(255, 0, 255, 0.8)",e.shadowBlur=20,e.shadowColor="#ff00ff";const n=35;e.translate(T,l),e.beginPath(),e.moveTo(n/2,0),e.lineTo(-n/3,-n/3),e.lineTo(-n/6,0),e.lineTo(-n/3,n/3),e.closePath(),e.fill(),e.fillStyle="white",e.font="bold 16px Outfit",e.textAlign="center",e.fillText("OPPONENT",0,-30),e.restore()}if(a.value.particles.forEach(t=>{e.fillStyle=t.color,e.globalAlpha=Math.max(0,t.life),e.beginPath(),e.arc(t.x,t.y,4,0,Math.PI*2),e.fill()}),e.globalAlpha=1,e.globalAlpha=1,a.value.boss.active){const t=a.value.boss;e.save(),e.translate(t.x,t.y),e.shadowBlur=40,e.shadowColor="#ff0000",e.fillStyle="#440000",e.beginPath();const T=60;for(let l=0;l<8;l++){const n=Math.PI*2*l/8;e.lineTo(Math.cos(n)*T,Math.sin(n)*T)}e.fill(),e.fillStyle="#ff0000",e.beginPath(),e.arc(0,0,20,0,Math.PI*2),e.fill(),e.restore(),t.projectiles.forEach(l=>{e.save(),e.translate(l.x,l.y),e.fillStyle="#ffff00",e.shadowBlur=10,e.shadowColor="#ffaa00",e.beginPath(),e.arc(0,0,15,0,Math.PI*2),e.fill(),e.restore()})}r.practiceMode&&C.value.forEach((t,T)=>{e.save();const l=15,n=T===C.value.length-1;e.translate(t.x,t.y),e.beginPath(),e.moveTo(0,-l),e.lineTo(l,0),e.lineTo(0,l),e.lineTo(-l,0),e.closePath(),n?(e.fillStyle="#00ff00",e.shadowBlur=15,e.shadowColor="#00ff00"):e.fillStyle="rgba(0, 255, 0, 0.4)",e.fill(),e.strokeStyle="#fff",e.lineWidth=2,e.stroke(),e.restore()});const Fe=a.value.playerX,Je=a.value.playerY,ee=a.value.playerSize,$e=a.value.isHolding?-1:1,dt=a.value.isGravityInverted?-$e:$e,ft=Math.atan2(dt,1);e.save(),e.translate(Fe,Je),e.rotate(ft);const Be=a.value.isGravityInverted?"#ffff00":a.value.isHolding?"#00ffff":"#ff00ff";e.shadowBlur=25,e.shadowColor=Be;const H=ee*1.2;e.beginPath(),e.moveTo(H,0),e.lineTo(-H*.5,-H*.6),e.lineTo(-H*.15,0),e.lineTo(-H*.5,H*.6),e.closePath();const ye=e.createLinearGradient(-H,0,H,0);ye.addColorStop(0,Be),ye.addColorStop(.5,"#ffffff"),ye.addColorStop(1,Be),e.fillStyle=ye,e.fill(),e.strokeStyle="#fff",e.lineWidth=1.5,e.stroke(),e.restore(),e.shadowBlur=0,a.value.showHitboxes&&(e.strokeStyle="#00ff00",e.lineWidth=2,e.strokeRect(Fe-ee,Je-ee,ee*2,ee*2),e.strokeStyle="#ff0000",a.value.obstacles.forEach(t=>{if(t.x+t.width<a.value.cameraX-50||t.x>a.value.cameraX+i+100)return;const T=a.value.getObstacleStateAt(t,R.value),l=T.y,n=T.angle||0;e.save(),e.translate(t.x+t.width/2,l+t.height/2),n!==0&&e.rotate(n*Math.PI/180);const o=t.width/2,s=t.height/2;if(t.type==="slope")e.beginPath(),n>0?(e.moveTo(-o,s),e.lineTo(o,-s),e.lineTo(-o,-s)):(e.moveTo(o,s),e.lineTo(-o,-s),e.lineTo(o,-s)),e.closePath(),e.stroke();else if(t.type==="triangle"||t.type==="steep_triangle")e.beginPath(),e.moveTo(-o,s),e.lineTo(o,s),e.lineTo(o,-s),e.closePath(),e.stroke();else if(t.type==="spike"||t.type==="mini_spike"){const h=t.y>360;e.beginPath(),h?(e.moveTo(-o,s),e.lineTo(0,-s),e.lineTo(o,s)):(e.moveTo(-o,-s),e.lineTo(0,s),e.lineTo(o,-s)),e.closePath(),e.stroke()}else t.type==="saw"||t.type==="spike_ball"||t.type==="mine"||t.type==="orb"?(e.beginPath(),e.arc(0,0,o,0,Math.PI*2),e.stroke()):(t.type==="laser"||t.type,e.strokeRect(-o,-s,t.width,t.height));e.restore()})),e.restore(),(E.value||x.value)&&(e.save(),e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(0,0,i,u),e.restore()),a.value.isMeasureHighlight&&(e.save(),e.fillStyle="rgba(255, 255, 255, 0.15)",e.globalCompositeOperation="screen",e.fillRect(0,0,i,u),e.restore())},ze=()=>{if(document.hidden&&B.value){if(w)try{w.stop()}catch{}B.value=!1,x.value=!0,j.value="Ìè¨Ïª§Ïä§ Ïù¥ÌÉàÎ°ú Ï§ëÎã®Îê®"}};return je(()=>{window.addEventListener("keydown",e=>{e.repeat||(e.code==="Space"||e.code==="ArrowUp"||e.code==="KeyW")&&Z(e)}),window.addEventListener("keyup",e=>{(e.code==="Space"||e.code==="ArrowUp"||e.code==="KeyW")&&Q(e)}),window.addEventListener("mousedown",Z),window.addEventListener("mouseup",Q),window.addEventListener("touchstart",Z,{passive:!1}),window.addEventListener("touchend",Q,{passive:!1}),document.addEventListener("visibilitychange",ze),_e()}),Ke(()=>{ve(),window.removeEventListener("mousedown",Z),window.removeEventListener("mouseup",Q),window.removeEventListener("touchstart",Z),window.removeEventListener("touchend",Q),document.removeEventListener("visibilitychange",ze)}),yt(()=>r.audioBuffer,()=>{ve(),_e()}),(e,i)=>(m(),p("div",Pt,[c("div",St,[c("canvas",{ref_key:"canvas",ref:O,width:"1280",height:"720"},null,512),c("div",xt,[c("div",Tt,[c("div",kt,[!I.multiplayerMode&&!I.loadMap&&q.value&&!Pe.value?(m(),p("button",{key:0,onClick:nt,class:"hud-action-btn save"}," SAVE MAP ")):P("",!0),c("button",{onClick:i[0]||(i[0]=u=>N("exit",{progress:U.value,score:D.value,outcome:x.value?"fail":"win"})),class:"hud-action-btn exit"},"ÎÇòÍ∞ÄÍ∏∞"),c("button",{onClick:i[1]||(i[1]=u=>N("change-mode")),class:"hud-action-btn mode-change"},"MODE"),I.practiceMode&&!x.value?(m(),p("button",{key:1,onClick:He,class:"hud-action-btn checkpoint"},"SET CP (C)")):P("",!0)]),c("div",Ct,[c("div",{class:gt(["wave-icon",{inverted:we.value}])},"‚ñ∂",2),I.tutorialMode?(m(),p("h1",It,"TUTORIAL")):(m(),p("h1",_t,"ULTRA MUSIC MANIA"))]),c("div",At,[c("div",{class:"progress-bar",style:me({width:W.value+"%"})},null,4),z.value>0?(m(),p("div",{key:0,class:"best-record-marker",style:me({left:z.value+"%"})},[...i[3]||(i[3]=[c("div",{class:"marker-line"},null,-1),c("span",{class:"marker-text"},"BEST",-1)])],4)):P("",!0),c("span",Rt,A(Math.floor(W.value))+"%",1)])]),c("div",Bt,[i[4]||(i[4]=c("div",{class:"score-label"},"SCORE",-1)),c("div",Ot,A(Math.floor(D.value)),1)]),c("div",Et,[c("span",{style:me({color:tt.value})},A(at.value),5),Me.value?(m(),p("span",Dt,"MINI")):P("",!0),Me.value?(m(),p("span",Lt,"MINI")):P("",!0),ae.value&&!I.tutorialMode?(m(),p("span",Gt,"AUTO MODE")):P("",!0),I.tutorialMode?(m(),p("span",Nt,"TUTORIAL")):P("",!0),I.practiceMode?(m(),p("span",Xt,"PRACTICE")):P("",!0)]),x.value?(m(),p("div",Ut,[c("div",Ht,[i[6]||(i[6]=c("h1",{class:"status-text fail"},"CRASHED",-1)),Se.value?(m(),p("p",Yt,"üéâ NEW BEST! "+A(U.value)+"%",1)):P("",!0),c("p",Wt,A(j.value),1),c("div",Vt,[c("span",null,A(U.value)+"% PROGRESS",1),i[5]||(i[5]=c("span",{class:"stat-divider"},"|",-1)),c("span",null,"ATTEMPT "+A(Ge.value),1)])])])):P("",!0),E.value?(m(),p("div",zt,[c("div",Ft,[i[9]||(i[9]=c("h1",{class:"status-text win"},"COMPLETE!",-1)),i[10]||(i[10]=c("p",{class:"status-sub"},"Î™®Îì† Ïû•Ïï†Î¨ºÏùÑ ÎèåÌååÌñàÏäµÎãàÎã§",-1)),c("div",Jt,[c("span",null,"SCORE "+A(Math.floor(D.value)),1)]),c("div",$t,[ne.value?P("",!0):(m(),p("button",{key:0,onClick:et,class:"save-video-btn",disabled:oe.value},[oe.value?(m(),p("span",Kt,"üíæ Ï†ÄÏû• Ï§ë...")):(m(),p("span",qt,"üé¨ ÏòÅÏÉÅ Ï†ÄÏû•"))],8,jt)),ne.value?(m(),p("p",Zt,"‚úÖ ÏòÅÏÉÅÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!")):P("",!0),i[7]||(i[7]=c("p",{class:"save-hint"},"ÌÅ¥Î¶¨Ïñ¥ Ïû•Î©¥ÏùÑ ÎèôÏòÅÏÉÅÏúºÎ°ú Ï†ÄÏû•Ìï©ÎãàÎã§",-1))]),I.loadMap&&I.loadMap._id&&!ie.value?(m(),p("div",Qt,[i[8]||(i[8]=c("p",{class:"rating-label"},"RATE THIS MAP (1-30)",-1)),c("div",bt,[pt(c("input",{type:"range",min:"1",max:"30","onUpdate:modelValue":i[2]||(i[2]=u=>le.value=u),class:"rating-slider"},null,512),[[mt,le.value,void 0,{number:!0}]]),c("span",ea,A(le.value),1)]),c("button",{onClick:Qe,class:"submit-rating-btn"},"SUBMIT VOTE")])):ie.value?(m(),p("div",ta," THANK YOU FOR VOTING! ")):P("",!0)])])):P("",!0),K.value?(m(),p("div",aa,[c("div",la,A(K.value),1)])):P("",!0),re.value&&!x.value&&!E.value?(m(),p("div",ia,[i[11]||(i[11]=c("div",{class:"status-msg"},"OPTIMIZING MAP...",-1)),c("div",na,[c("div",{class:"fill",style:me({width:xe.value+"%"})},null,4)])])):P("",!0),I.practiceMode&&C.value.length>0?(m(),p("div",oa," CPs: "+A(C.value.length)+" (Last: "+A(Math.floor(C.value[C.value.length-1].progress))+"%) ",1)):P("",!0),!K.value&&!x.value&&!E.value&&!re.value?(m(),p("div",sa,[I.tutorialMode&&Xe.value?(m(),p("div",ra,A(Xe.value),1)):(m(),p("div",ca,[i[12]||(i[12]=c("span",null,"ÌÅ¥Î¶≠/Ïä§ÌéòÏù¥Ïä§ Ïú†ÏßÄ = ÏúÑÎ°ú | Ìï¥Ï†ú = ÏïÑÎûòÎ°ú",-1)),I.practiceMode?(m(),p("span",ua," | [C] Ï≤¥ÌÅ¨Ìè¨Ïù∏Ìä∏ | [X] ÏµúÍ∑º ÏÇ≠Ï†ú")):P("",!0)]))])):P("",!0)])])]))}}),ya=Object.assign(Mt(da,[["__scopeId","data-v-b24d4760"]]),{__name:"GameCanvas"});export{ya as _};
