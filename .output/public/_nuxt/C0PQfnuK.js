import{_ as Q}from"./C9Qrg4RW.js";import{e as ee,f as ae,r as l,j as te,C as se,h as le,c as v,a,k as b,x as ne,t as o,B as Y,n as $,y as oe,b as ue,w as ie,T as re,g as ce,o as i}from"./DdPwfpQH.js";import{_ as ve}from"./DlAUqK2U.js";import"./BK6mPTWH.js";const x=globalThis.setInterval,de={class:"multi-container"},pe={key:0,class:"setup-screen glass-panel"},me={class:"mode-grid"},fe={key:1,class:"setup-screen glass-panel"},ye={class:"matchmaking-box"},ge={class:"category-badge"},he={class:"status-msg"},Ce={key:2,class:"setup-screen glass-panel"},Te={class:"ready-box"},_e={class:"vs-header"},Ee={class:"player-info"},Ie={class:"player-info"},be={key:0,class:"selected-map"},Ae={class:"map-name"},we={class:"map-meta"},Me={key:3,class:"setup-screen glass-panel"},Se={class:"result-box"},Ne={class:"duel-res"},ke={class:"res-item"},Oe={class:"clear-count"},Re={class:"res-item"},xe={class:"clear-count enemy"},Pe={key:0,class:"match-meta"},De={key:4,class:"ingame-container"},Le={class:"match-hud"},Ue={class:"clear-counts-hud"},Be={class:"my-clears"},Ge={class:"enemy-clears"},Ye={key:0,class:"opponent-clear-alert"},$e=ee({__name:"multiplayer",setup(He){const H=ce(),{user:r,updateRating:F}=ae(),u=l("MODESELECT"),g=l("Connecting to server..."),p=l(""),n=l(null),h=l(""),A=l(0),S=l(0),P=l(360),D=l(360),C=l(0),V=l(0),w=l({p1:0,p2:0}),T=l("draw"),y=l(0),m=l(0),N=l(!1),L=l(0);l([]);const M=l(null),k=l([]),O=l([]),d=l(180);let _=null;te(()=>{}),se(()=>{clearInterval(_),clearInterval(f)});const E=l(null);let f=null;const I=le(()=>{if(r.value?._id)return r.value._id;let t=sessionStorage.getItem("umm_player_id");return t||(t="guest_"+Math.random().toString(36).substring(2,15),sessionStorage.setItem("umm_player_id",t)),t});async function R(t){h.value=t,u.value="MATCHMAKING",g.value="SCANNING FOR COMPETITORS...";try{const e=await $fetch("/api/matchmaking/find",{method:"POST",body:{category:t,rating:r.value?.rating||1e3,userId:I.value}});E.value=e.matchId,e.status==="ready"?U(e):f=x(async()=>{try{const s=await $fetch("/api/matchmaking/status",{method:"POST",body:{matchId:E.value,userId:I.value}});(s.status==="ready"||s.status==="playing")&&(clearInterval(f),U(s))}catch(s){console.error("Polling error",s)}},2e3)}catch(e){console.error("Matchmaking failed",e),g.value=`MATCHMAKING ERROR: ${e.statusMessage||e.message||"Server Error"}`,setTimeout(()=>u.value="MODESELECT",4e3);return}}async function U(t){if(n.value=t.map,p.value=t.opponent?.username||"GHOST",g.value="DOWNLOADING BATTLE TRACK...",n.value.audioData||n.value.audioUrl)try{let e=null;if(n.value.audioData?e=await(await fetch(n.value.audioData)).arrayBuffer():n.value.audioUrl&&(e=await(await fetch(n.value.audioUrl)).arrayBuffer()),e){const s=new(window.AudioContext||window.webkitAudioContext);M.value=await s.decodeAudioData(e)}}catch(e){console.warn("Could not auto-load audio, using silent buffer",e)}g.value="OPPONENT FOUND: SYNCHRONIZING...",await new Promise(e=>setTimeout(e,1e3)),u.value="READY"}async function B(){if(!n.value)return;h.value==="1m"?d.value=60:h.value==="3m"?d.value=180:h.value==="10m"&&(d.value=600),k.value=n.value.beatTimes||[],O.value=n.value.sections||[];const t=new(window.AudioContext||window.webkitAudioContext),e=Math.max(1,t.sampleRate*(n.value.duration||120));M.value=t.createBuffer(1,e,t.sampleRate),u.value="PLAY",A.value=0,S.value=0,C.value=0,V.value=0,clearInterval(_),_=x(()=>{d.value--,d.value<=0&&Z()},1e3),clearInterval(f),f=x(async()=>{try{const s=await $fetch("/api/matchmaking/status",{method:"POST",body:{matchId:E.value,userId:I.value,progress:A.value,y:P.value}});if(s.opponent){S.value=s.opponent.progress,D.value=s.opponent.y;const c=s.opponent.clearCount||0;c>m.value&&(m.value=c,K())}}catch{}},200)}function K(){N.value=!0,setTimeout(()=>{N.value=!1},3e3)}function z(t){A.value=t.progress,t.progress>C.value&&(C.value=t.progress),P.value=t.y}async function W(){y.value++;try{await $fetch("/api/matchmaking/clear",{method:"POST",body:{matchId:E.value,userId:I.value}})}catch{}await j()}async function j(){L.value++;try{const t=await $fetch("/api/matchmaking/next-map",{method:"POST",body:{matchId:E.value,userId:I.value,mapIndex:L.value}});t.map&&(n.value=t.map,k.value=t.map.beatTimes||[],O.value=t.map.sections||[],C.value=0,A.value=0)}catch(t){console.error("Failed to load next map",t)}}function X(t){(t?.outcome==="complete"||C.value>=100)&&W()}function Z(){clearInterval(_),clearInterval(f);let t="draw";y.value>m.value?t="player":y.value<m.value&&(t="opponent"),q(t)}function q(t){if(clearInterval(_),clearInterval(f),T.value=t,w.value.p1=y.value,w.value.p2=m.value,r.value&&!r.value.isGuest&&(t==="player"||t==="opponent")){const e=r.value.rating||1e3,s=t==="player"?25:-15,c=Math.max(0,e+s);F(c,{opponent:p.value,winner:t==="player"?r.value.username:p.value,myScore:w.value.p1,opponentScore:w.value.p2,date:new Date,ratingChange:s})}u.value="RESULT"}function J(t){const e=Math.floor(t/60),s=t%60;return`${e}:${s<10?"0":""}${s}`}function G(){H.push("/")}return(t,e)=>{const s=Q;return i(),v("div",de,[e[17]||(e[17]=a("div",{class:"background-anim"},null,-1)),u.value==="MODESELECT"?(i(),v("div",pe,[e[8]||(e[8]=a("h1",{class:"glow-text"},"BATTLE CATEGORY",-1)),a("div",me,[a("div",{class:"mode-card",onClick:e[0]||(e[0]=c=>R("1m"))},[...e[5]||(e[5]=[a("div",{class:"mode-icon"},"‚ö°",-1),a("h3",null,"SPRINT",-1),a("p",null,"1 MINUTE MATCH",-1)])]),a("div",{class:"mode-card",onClick:e[1]||(e[1]=c=>R("3m"))},[...e[6]||(e[6]=[a("div",{class:"mode-icon"},"‚öîÔ∏è",-1),a("h3",null,"STANDARD",-1),a("p",null,"3 MINUTE MATCH",-1)])]),a("div",{class:"mode-card",onClick:e[2]||(e[2]=c=>R("10m"))},[...e[7]||(e[7]=[a("div",{class:"mode-icon"},"üåå",-1),a("h3",null,"ENDURANCE",-1),a("p",null,"10 MINUTE MATCH",-1)])])]),a("button",{onClick:G,class:"back-btn-simple"},"BACK TO MENU")])):u.value==="MATCHMAKING"?(i(),v("div",fe,[a("div",ye,[e[9]||(e[9]=a("h1",{class:"glow-text"},"SEARCHING_OPPONENT",-1)),a("div",ge,o(h.value)+" CLASS",1),e[10]||(e[10]=ne('<div class="radar" data-v-67b945f8><div class="radar-line" data-v-67b945f8></div><div class="pings" data-v-67b945f8><div class="ping" style="top:20%;left:30%;" data-v-67b945f8></div><div class="ping" style="top:70%;left:80%;" data-v-67b945f8></div></div></div>',1)),a("p",he,o(g.value),1),a("button",{onClick:e[3]||(e[3]=c=>u.value="MODESELECT"),class:"cancel-btn"},"CANCEL")])])):u.value==="READY"?(i(),v("div",Ce,[a("div",Te,[a("div",_e,[a("div",Ee,[e[11]||(e[11]=a("div",{class:"avatar"},"‚óÜ",-1)),a("span",null,o(Y(r)?.username||"GUEST"),1)]),e[13]||(e[13]=a("div",{class:"vs-badge"},"VS",-1)),a("div",Ie,[e[12]||(e[12]=a("div",{class:"avatar opponent"},"‚óá",-1)),a("span",null,o(p.value),1)])]),n.value?(i(),v("div",be,[e[14]||(e[14]=a("h2",{class:"map-label"},"SELECTED_MAP",-1)),a("h1",Ae,o(n.value.title),1),a("p",we,"DIFF: "+o(n.value.difficulty)+" | BY: "+o(n.value.creatorName),1)])):b("",!0),a("button",{onClick:B,class:"battle-btn"},"BATTLE START")])])):u.value==="RESULT"?(i(),v("div",Me,[a("div",Se,[a("h1",{class:$(["victory-text",{loss:T.value==="opponent",draw:T.value==="draw"}])},o(T.value==="player"?"VICTORY":T.value==="opponent"?"DEFEAT":"DRAW"),3),a("div",Ne,[a("div",ke,[a("span",null,o(Y(r)?.username||"YOU"),1),a("div",Oe,o(y.value)+" CLEARS",1)]),a("div",Re,[a("span",null,o(p.value),1),a("div",xe,o(m.value)+" CLEARS",1)])]),d.value<=0?(i(),v("div",Pe,[...e[15]||(e[15]=[a("span",{class:"timeout-badge"},"TIME OUT RESULT",-1)])])):b("",!0),a("button",{onClick:e[4]||(e[4]=c=>u.value="MODESELECT"),class:"action-btn"},"REMATCH"),a("button",{onClick:G,class:"action-btn secondary"},"EXIT")])])):u.value==="PLAY"?(i(),v("div",De,[a("div",Le,[a("div",{class:$(["timer-display",{critical:d.value<30}])},o(J(d.value)),3),a("div",Ue,[a("span",Be,"YOU: "+o(y.value),1),e[16]||(e[16]=a("span",{class:"vs-text"},"VS",-1)),a("span",Ge,o(p.value)+": "+o(m.value),1)]),ue(re,{name:"fade"},{default:ie(()=>[N.value?(i(),v("div",Ye," üéâ "+o(p.value)+"Ïù¥(Í∞Ä) Î†àÎ≤®ÏùÑ ÌÅ¥Î¶¨Ïñ¥ÌñàÏäµÎãàÎã§! ",1)):b("",!0)]),_:1})]),M.value?(i(),oe(s,{key:0,audioBuffer:M.value,obstacles:k.value,sections:O.value,loadMap:n.value,multiplayerMode:!0,opponentY:D.value,opponentProgress:S.value,onRetry:B,onExit:X,onProgressUpdate:z},null,8,["audioBuffer","obstacles","sections","loadMap","opponentY","opponentProgress"])):b("",!0)])):b("",!0)])}}}),We=ve($e,[["__scopeId","data-v-67b945f8"]]);export{We as default};
