import{s as N,_ as W}from"./B9gDmzY8.js";import{e as j,f as X,r as l,j as Z,D as q,h as J,c as m,a as e,k as w,B as Q,t as o,C as G,n as Y,m as y,y as ee,g as ae,o as v}from"./OScbCsOj.js";import{_ as se}from"./DlAUqK2U.js";import"./C0FcKQV0.js";const te={class:"multi-container"},le={key:0,class:"setup-screen glass-panel"},ne={class:"mode-grid"},oe={key:1,class:"setup-screen glass-panel"},ie={class:"matchmaking-box"},ue={class:"category-badge"},re={class:"status-msg"},ve={key:2,class:"setup-screen glass-panel"},de={class:"ready-box"},ce={class:"vs-header"},pe={class:"player-info"},me={class:"player-info"},fe={key:0,class:"selected-map"},ye={class:"map-name"},ge={class:"map-meta"},he={key:3,class:"setup-screen glass-panel"},Te={class:"result-box"},_e={class:"duel-res"},Ce={class:"res-item"},Ee={class:"prog-bar"},be={class:"res-item"},Ae={class:"prog-bar"},Ie={key:0,class:"match-meta"},Me={key:4,class:"ingame-container"},we={class:"match-hud"},Se={class:"concurrent-progress"},ke={class:"p-bar"},Re={class:"p-bar"},Ne=j({__name:"multiplayer",setup(Oe){const $=ae(),{user:u,updateRating:H}=X(),i=l("MODESELECT"),g=l("Connecting to server..."),h=l(""),n=l(null),T=l(""),A=l(0),I=l(0),O=l(360),D=l(360),r=l(0),d=l(0),c=l({p1:0,p2:0}),_=l("draw"),M=l(null),P=l([]),x=l([]),p=l(180);let C=null;Z(()=>{}),q(()=>{clearInterval(C),clearInterval(E)});const S=l(null);let E=null;const k=J(()=>{if(u.value?._id)return u.value._id;let s=sessionStorage.getItem("umm_player_id");return s||(s="guest_"+Math.random().toString(36).substring(2,15),sessionStorage.setItem("umm_player_id",s)),s});async function R(s){T.value=s,i.value="MATCHMAKING",g.value="SCANNING FOR COMPETITORS...";try{const a=await $fetch("/api/matchmaking/find",{method:"POST",body:{category:s,rating:u.value?.rating||1e3,userId:k.value}});S.value=a.matchId,a.status==="ready"?L(a):E=N(async()=>{try{const t=await $fetch("/api/matchmaking/status",{method:"POST",body:{matchId:S.value,userId:k.value}});(t.status==="ready"||t.status==="playing")&&(clearInterval(E),L(t))}catch(t){console.error("Polling error",t)}},2e3)}catch(a){console.error("Matchmaking failed",a),g.value=`MATCHMAKING ERROR: ${a.statusMessage||a.message||"Server Error"}`,setTimeout(()=>i.value="MODESELECT",4e3);return}}async function L(s){if(n.value=s.map,h.value=s.opponent?.username||"GHOST",g.value="DOWNLOADING BATTLE TRACK...",n.value.audioData||n.value.audioUrl)try{let a=null;if(n.value.audioData?a=await(await fetch(n.value.audioData)).arrayBuffer():n.value.audioUrl&&(a=await(await fetch(n.value.audioUrl)).arrayBuffer()),a){const t=new(window.AudioContext||window.webkitAudioContext);M.value=await t.decodeAudioData(a)}}catch(a){console.warn("Could not auto-load audio, using silent buffer",a)}g.value="OPPONENT FOUND: SYNCHRONIZING...",await new Promise(a=>setTimeout(a,1e3)),i.value="READY"}async function B(){if(!n.value)return;T.value==="3m"?p.value=180:T.value==="10m"?p.value=600:T.value==="1h"&&(p.value=3600),P.value=n.value.beatTimes||[],x.value=n.value.sections||[];const s=new(window.AudioContext||window.webkitAudioContext),a=Math.max(1,s.sampleRate*(n.value.duration||120));M.value=s.createBuffer(1,a,s.sampleRate),i.value="PLAY",A.value=0,I.value=0,r.value=0,d.value=0,clearInterval(C),C=N(()=>{p.value--,p.value<=0&&V()},1e3),clearInterval(E),E=N(async()=>{try{const t=await $fetch("/api/matchmaking/status",{method:"POST",body:{matchId:S.value,userId:k.value,progress:A.value,y:O.value}});t.opponent&&(I.value=t.opponent.progress,d.value=t.opponent.bestProgress||t.opponent.progress,D.value=t.opponent.y,d.value>=100&&b("opponent"))}catch{}},200)}function F(s){A.value=s.progress,s.progress>r.value&&(r.value=s.progress),O.value=s.y,r.value>=100?b("player"):d.value>=100&&b("opponent")}function K(s){s?.outcome==="fail"||r.value>=100&&b("player")}function V(){clearInterval(C);let s="draw";r.value>d.value?s="player":r.value<d.value&&(s="opponent"),b(s)}function b(s){if(clearInterval(C),_.value=s,c.value.p1=r.value,c.value.p2=d.value,u.value&&!u.value.isGuest&&(s==="player"||s==="opponent")){const a=u.value.rating||1e3,t=s==="player"?25:-15,f=Math.max(0,a+t);H(f,{opponent:h.value,winner:s==="player"?u.value.username:h.value,myScore:c.value.p1,opponentScore:c.value.p2,date:new Date,ratingChange:t})}i.value="RESULT"}function z(s){const a=Math.floor(s/60),t=s%60;return`${a}:${t<10?"0":""}${t}`}function U(){$.push("/")}return(s,a)=>{const t=W;return v(),m("div",te,[a[16]||(a[16]=e("div",{class:"background-anim"},null,-1)),i.value==="MODESELECT"?(v(),m("div",le,[a[8]||(a[8]=e("h1",{class:"glow-text"},"BATTLE CATEGORY",-1)),e("div",ne,[e("div",{class:"mode-card",onClick:a[0]||(a[0]=f=>R("3m"))},[...a[5]||(a[5]=[e("div",{class:"mode-icon"},"âš¡",-1),e("h3",null,"SPRINT",-1),e("p",null,"3 MINUTE MATCH",-1)])]),e("div",{class:"mode-card",onClick:a[1]||(a[1]=f=>R("10m"))},[...a[6]||(a[6]=[e("div",{class:"mode-icon"},"âš”ï¸",-1),e("h3",null,"STANDARD",-1),e("p",null,"10 MINUTE MATCH",-1)])]),e("div",{class:"mode-card",onClick:a[2]||(a[2]=f=>R("1h"))},[...a[7]||(a[7]=[e("div",{class:"mode-icon"},"ðŸŒŒ",-1),e("h3",null,"ENDURANCE",-1),e("p",null,"1 HOUR MATCH",-1)])])]),e("button",{onClick:U,class:"back-btn-simple"},"BACK TO MENU")])):i.value==="MATCHMAKING"?(v(),m("div",oe,[e("div",ie,[a[9]||(a[9]=e("h1",{class:"glow-text"},"SEARCHING_OPPONENT",-1)),e("div",ue,o(T.value)+" CLASS",1),a[10]||(a[10]=Q('<div class="radar" data-v-c743d19b><div class="radar-line" data-v-c743d19b></div><div class="pings" data-v-c743d19b><div class="ping" style="top:20%;left:30%;" data-v-c743d19b></div><div class="ping" style="top:70%;left:80%;" data-v-c743d19b></div></div></div>',1)),e("p",re,o(g.value),1),e("button",{onClick:a[3]||(a[3]=f=>i.value="MODESELECT"),class:"cancel-btn"},"CANCEL")])])):i.value==="READY"?(v(),m("div",ve,[e("div",de,[e("div",ce,[e("div",pe,[a[11]||(a[11]=e("div",{class:"avatar"},"â—†",-1)),e("span",null,o(G(u)?.username||"GUEST"),1)]),a[13]||(a[13]=e("div",{class:"vs-badge"},"VS",-1)),e("div",me,[a[12]||(a[12]=e("div",{class:"avatar opponent"},"â—‡",-1)),e("span",null,o(h.value),1)])]),n.value?(v(),m("div",fe,[a[14]||(a[14]=e("h2",{class:"map-label"},"SELECTED_MAP",-1)),e("h1",ye,o(n.value.title),1),e("p",ge,"DIFF: "+o(n.value.difficulty)+" | BY: "+o(n.value.creatorName),1)])):w("",!0),e("button",{onClick:B,class:"battle-btn"},"BATTLE START")])])):i.value==="RESULT"?(v(),m("div",he,[e("div",Te,[e("h1",{class:Y(["victory-text",{loss:_.value==="opponent",draw:_.value==="draw"}])},o(_.value==="player"?"VICTORY":_.value==="opponent"?"DEFEAT":"DRAW"),3),e("div",_e,[e("div",Ce,[e("span",null,o(G(u)?.username||"YOU"),1),e("div",Ee,[e("div",{class:"fill",style:y({width:c.value.p1+"%"})},null,4)]),e("span",null,o(c.value.p1.toFixed(1))+"%",1)]),e("div",be,[e("span",null,o(h.value),1),e("div",Ae,[e("div",{class:"fill enemy",style:y({width:c.value.p2+"%"})},null,4)]),e("span",null,o(c.value.p2.toFixed(1))+"%",1)])]),p.value<=0?(v(),m("div",Ie,[...a[15]||(a[15]=[e("span",{class:"timeout-badge"},"TIME OUT RESULT",-1)])])):w("",!0),e("button",{onClick:a[4]||(a[4]=f=>i.value="MODESELECT"),class:"action-btn"},"REMATCH"),e("button",{onClick:U,class:"action-btn secondary"},"EXIT")])])):i.value==="PLAY"?(v(),m("div",Me,[e("div",we,[e("div",{class:Y(["timer-display",{critical:p.value<30}])},o(z(p.value)),3),e("div",Se,[e("div",ke,[e("div",{class:"fill",style:y({width:r.value+"%"})},null,4),e("div",{class:"current-marker",style:y({left:A.value+"%"})},null,4)]),e("div",Re,[e("div",{class:"fill enemy",style:y({width:d.value+"%"})},null,4),e("div",{class:"current-marker enemy",style:y({left:I.value+"%"})},null,4)])])]),M.value?(v(),ee(t,{key:0,audioBuffer:M.value,obstacles:P.value,sections:x.value,loadMap:n.value,multiplayerMode:!0,opponentY:D.value,opponentProgress:I.value,onRetry:B,onExit:K,onProgressUpdate:F},null,8,["audioBuffer","obstacles","sections","loadMap","opponentY","opponentProgress"])):w("",!0)])):w("",!0)])}}}),Be=se(Ne,[["__scopeId","data-v-c743d19b"]]);export{Be as default};
