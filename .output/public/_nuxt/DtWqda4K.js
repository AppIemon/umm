import{e as ge,r as h,h as ye,j as he,i as ce,c as D,o as k,a,k as Q,n as te,F as de,l as fe,t as V,s as ue,d as z,x as be,f as Se,y as Ae,b as ke,m as ve,p as _e,v as De,z as Me,g as Ce,A as xe}from"./DdPwfpQH.js";import{_ as we}from"./DlAUqK2U.js";import{_ as Ie}from"./C9Qrg4RW.js";import{G as pe}from"./BK6mPTWH.js";import{t as Te,M as Ee,s as $e,C as Be}from"./CUbsk6PR.js";const Le="ImpossibleTimingDB",Z="recent_songs",Re=2,me=20,Oe=()=>{const H=()=>new Promise((y,d)=>{const f=indexedDB.open(Le,Re);f.onerror=()=>d("IndexedDB error"),f.onupgradeneeded=M=>{const A=M.target.result;if(!A.objectStoreNames.contains(Z)){const w=A.createObjectStore(Z,{keyPath:"id"});w.createIndex("name","name",{unique:!1}),w.createIndex("addedAt","addedAt",{unique:!1})}A.objectStoreNames.contains("songs")||A.createObjectStore("songs",{keyPath:"id"})},f.onsuccess=M=>{y(M.target.result)}});return{addSong:async y=>{const d=await H();return new Promise(async(f,M)=>{try{const w=d.transaction([Z],"readwrite").objectStore(Z),l=w.index("name").getAll(y.name);l.onsuccess=async()=>{const $=l.result;for(const T of $)w.delete(T.id);const _={id:crypto.randomUUID(),name:y.name,blob:y,addedAt:Date.now()};w.add(_);const O=w.index("addedAt").getAll();O.onsuccess=()=>{const T=O.result;if(T.length>me){const U=T.sort((N,q)=>N.addedAt-q.addedAt).slice(0,T.length-me);for(const N of U)w.delete(N.id)}},f(_)},l.onerror=()=>M("Error checking duplicates")}catch(A){M(A)}})},getSongs:async()=>{const y=await H();return new Promise((d,f)=>{const w=y.transaction([Z],"readonly").objectStore(Z).getAll();w.onsuccess=()=>{const B=w.result.sort((l,$)=>$.addedAt-l.addedAt);d(B)},w.onerror=()=>f("Error fetching songs")})},deleteSong:async y=>{const d=await H();return new Promise((f,M)=>{const B=d.transaction([Z],"readwrite").objectStore(Z).delete(y);B.onsuccess=()=>f(),B.onerror=()=>M("Error deleting song")})},clearAll:async()=>{const y=await H();return new Promise((d,f)=>{const w=y.transaction([Z],"readwrite").objectStore(Z).clear();w.onsuccess=()=>d(),w.onerror=()=>f("Error clearing songs")})}}},Fe={class:"song-selector"},Ue={class:"tabs"},Ne={key:0,class:"tab-content"},Pe={class:"sample-list"},qe=["onClick"],je={class:"sample-info"},Ge={class:"sample-name"},ze={class:"sample-meta"},Ve={key:0,class:"loading-indicator"},Ye={key:1,class:"tab-content"},He={key:0},Je={key:1,class:"highlight"},Xe={key:2,class:"tab-content"},Ke={class:"youtube-guide"},Ze={class:"guide-steps"},Qe={class:"step"},We={class:"step-content"},et={key:3,class:"tab-content"},tt={key:0,class:"storage-list"},at=["onClick"],ot={class:"song-info"},nt={class:"name"},st={class:"date"},lt=["onClick"],it={key:1,class:"empty-state"},rt=["disabled"],ut=ge({__name:"SongSelector",emits:["select"],setup(H,{emit:se}){const P=se,g=h("samples"),S=h(null),y=h(null),d=h(null),{addSong:f,getSongs:M,deleteSong:A,clearAll:w}=Oe(),B=h([]),l=h(null),$=h([{id:"1",name:"Electronic Future Beats",genre:"Electronic",duration:"2:30",url:"/api/samples?id=1"},{id:"2",name:"Synthwave Retro",genre:"Synthwave",duration:"2:00",url:"/api/samples?id=2"},{id:"3",name:"Epic Cinematic",genre:"Cinematic",duration:"2:45",url:"/api/samples?id=3"}]),_=h(null),O=h(null),T=ye(()=>g.value==="youtube"||O.value?!1:d.value||l.value||_.value);async function x(){try{B.value=await M()}catch(v){console.error("Failed to load recent songs:",v)}}function U(v){const s=new Date(v),F=new Date().getTime()-s.getTime(),j=Math.floor(F/6e4),oe=Math.floor(F/36e5),n=Math.floor(F/864e5);return j<1?"ë°©ê¸ˆ ì „":j<60?`${j}ë¶„ ì „`:oe<24?`${oe}ì‹œê°„ ì „`:n<7?`${n}ì¼ ì „`:s.toLocaleDateString()}async function N(v){_.value=v,l.value=null,d.value=null,O.value=v.id;try{const s=await fetch(v.url);if(!s.ok)throw new Error("Failed to load sample");const p=await s.blob(),F=new File([p],v.name+".mp3",{type:"audio/mpeg"});d.value=F,S.value=F}catch(s){console.error("Failed to load sample:",s),_.value=null}finally{O.value=null}}function q(v){l.value=v,d.value=null,_.value=null}async function m(v){try{await A(v),await x(),l.value?.id===v&&(l.value=null)}catch(s){console.error("Failed to delete song:",s)}}async function J(){if(X())try{await w(),B.value=[],l.value=null}catch(v){console.error("Failed to clear songs:",v)}}he(x),ce(g,v=>{v==="storage"&&x()});function ie(){y.value?.click()}function ae(v){const s=v.target;s.files?.[0]&&ee(s.files[0])}function Y(v){v.dataTransfer?.files?.[0]&&ee(v.dataTransfer.files[0])}async function ee(v){S.value=v,d.value=v,l.value=null,_.value=null;try{await f(v)}catch(s){console.error("Failed to save to recent songs:",s)}}async function X(){if(g.value==="storage"&&l.value){const v=new File([l.value.blob],l.value.name,{type:l.value.blob.type||"audio/mpeg"});P("select",v)}else d.value&&P("select",d.value)}return(v,s)=>(k(),D("div",Fe,[a("div",Ue,[a("button",{class:te({active:g.value==="samples"}),onClick:s[0]||(s[0]=p=>g.value="samples")},"SAMPLES",2),a("button",{class:te({active:g.value==="upload"}),onClick:s[1]||(s[1]=p=>g.value="upload")},"UPLOAD",2),a("button",{class:te({active:g.value==="youtube"}),onClick:s[2]||(s[2]=p=>g.value="youtube")},"GUIDE",2),a("button",{class:te({active:g.value==="storage"}),onClick:s[3]||(s[3]=p=>g.value="storage")},"RECENT",2)]),g.value==="samples"?(k(),D("div",Ne,[s[6]||(s[6]=a("p",{class:"section-desc"},"CC0 ë¬´ë£Œ ìŒì•… - ì €ì‘ê¶Œ ê±±ì • ì—†ì´ ë°”ë¡œ í”Œë ˆì´!",-1)),a("div",Pe,[(k(!0),D(de,null,fe($.value,p=>(k(),D("div",{key:p.id,class:te(["sample-item",{selected:_.value?.id===p.id,loading:O.value===p.id}]),onClick:F=>N(p)},[a("div",je,[a("span",Ge,V(p.name),1),a("span",ze,V(p.genre)+" â€¢ "+V(p.duration),1)]),O.value===p.id?(k(),D("span",Ve,"â—†")):Q("",!0)],10,qe))),128))])])):g.value==="upload"?(k(),D("div",Ye,[a("div",{class:"drop-zone",onDragover:s[4]||(s[4]=ue(()=>{},["prevent"])),onDrop:ue(Y,["prevent"]),onClick:ie},[S.value?(k(),D("p",Je,V(S.value.name),1)):(k(),D("p",He,"DROP FILE HERE"))],32),a("input",{type:"file",ref_key:"fileInput",ref:y,accept:"audio/*",style:{display:"none"},onChange:ae},null,544)])):g.value==="youtube"?(k(),D("div",Xe,[a("div",Ke,[s[11]||(s[11]=a("h3",{class:"guide-title"},"ğŸµ YouTube MP3 ë³€í™˜ ê°€ì´ë“œ",-1)),s[12]||(s[12]=a("p",{class:"guide-desc"},[z("ì €ì‘ê¶Œ ë³´í˜¸ë¥¼ ìœ„í•´ ì§ì ‘ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤."),a("br"),z("ì•„ë˜ ë°©ë²•ìœ¼ë¡œ MP3 íŒŒì¼ì„ ì¤€ë¹„í•´ì£¼ì„¸ìš”.")],-1)),a("div",Ze,[s[10]||(s[10]=be('<div class="step" data-v-161105ae><span class="step-num" data-v-161105ae>1</span><div class="step-content" data-v-161105ae><strong data-v-161105ae>YouTube ì˜ìƒ URL ë³µì‚¬</strong><p data-v-161105ae>ì›í•˜ëŠ” ìŒì•… ì˜ìƒì˜ ì£¼ì†Œë¥¼ ë³µì‚¬í•˜ì„¸ìš”</p></div></div><div class="step" data-v-161105ae><span class="step-num" data-v-161105ae>2</span><div class="step-content" data-v-161105ae><strong data-v-161105ae>MP3 ë³€í™˜ ì‚¬ì´íŠ¸ ì´ìš©</strong><p data-v-161105ae>ì•„ë˜ ì‚¬ì´íŠ¸ì—ì„œ MP3ë¡œ ë³€í™˜í•˜ì„¸ìš”</p><div class="converter-links" data-v-161105ae><a href="https://y2mate.com" target="_blank" rel="noopener" class="converter-link" data-v-161105ae><span class="link-icon" data-v-161105ae>ğŸ”—</span> Y2Mate </a><a href="https://ytmp3.cc" target="_blank" rel="noopener" class="converter-link" data-v-161105ae><span class="link-icon" data-v-161105ae>ğŸ”—</span> YTMP3 </a><a href="https://loader.to" target="_blank" rel="noopener" class="converter-link" data-v-161105ae><span class="link-icon" data-v-161105ae>ğŸ”—</span> Loader.to </a></div></div></div>',2)),a("div",Qe,[s[9]||(s[9]=a("span",{class:"step-num"},"3",-1)),a("div",We,[s[7]||(s[7]=a("strong",null,"MP3 íŒŒì¼ ì—…ë¡œë“œ",-1)),s[8]||(s[8]=a("p",null,"ë‹¤ìš´ë¡œë“œí•œ MP3 íŒŒì¼ì„ UPLOAD íƒ­ì—ì„œ ì—…ë¡œë“œí•˜ì„¸ìš”",-1)),a("button",{class:"go-upload-btn",onClick:s[5]||(s[5]=p=>g.value="upload")},"UPLOAD íƒ­ìœ¼ë¡œ ì´ë™ â†’")])])]),s[13]||(s[13]=a("div",{class:"warning-box"},[a("span",{class:"warning-icon"},"âš ï¸"),a("p",null,[z("ì´ìƒí•œ ìŠ¤íŒ¸ ì‚¬ì´íŠ¸ê°€ ë‚˜ì˜¬ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ìë™ìœ¼ë¡œ ì—´ë¦¬ëŠ” ì‚¬ì´íŠ¸ëŠ” ë°”ë¡œ ë‹«ì•„ì£¼ì„¸ìš”."),a("br"),z("2ë²ˆì •ë„ ë‹«ìœ¼ë©´ ë‹¤ìš´ë¡œë“œê°€ ë©ë‹ˆë‹¤.")])],-1))])])):g.value==="storage"?(k(),D("div",et,[s[15]||(s[15]=a("p",{class:"section-desc"},"ìµœê·¼ ì‚¬ìš©í•œ ë…¸ë˜ (ìµœëŒ€ 20ê³¡)",-1)),B.value.length>0?(k(),D("div",tt,[(k(!0),D(de,null,fe(B.value,p=>(k(),D("div",{key:p.id,class:te(["storage-item",{selected:l.value?.id===p.id}]),onClick:F=>q(p)},[a("div",ot,[a("span",nt,V(p.name),1),a("span",st,V(U(p.addedAt)),1)]),a("button",{class:"delete-btn",onClick:ue(F=>m(p.id),["stop"])},"âœ•",8,lt)],10,at))),128))])):(k(),D("div",it,[...s[14]||(s[14]=[a("p",{class:"empty-icon"},"ğŸ“",-1),a("p",{class:"empty-msg"},"ìµœê·¼ ì‚¬ìš©í•œ ë…¸ë˜ê°€ ì—†ìŠµë‹ˆë‹¤",-1),a("p",{class:"empty-hint"},"UPLOAD íƒ­ì—ì„œ ë…¸ë˜ë¥¼ ì¶”ê°€í•˜ë©´ ì—¬ê¸°ì— ê¸°ë¡ë©ë‹ˆë‹¤",-1)])])),B.value.length>0?(k(),D("button",{key:2,class:"clear-all-btn",onClick:J}," ì „ì²´ ì‚­ì œ ")):Q("",!0)])):Q("",!0),a("button",{class:"confirm-btn",disabled:!T.value,onClick:X}," SELECT ",8,rt)]))}}),ct=Object.assign(we(ut,[["__scopeId","data-v-161105ae"]]),{__name:"SongSelector"}),dt=()=>{const H=h(null);return{analyzeAudio:async(P,g,S)=>{S&&S({step:"ì˜¤ë””ì˜¤ í—¤ë”ë¥¼ ì½ëŠ” ì¤‘...",percent:5}),H.value||(H.value=new(window.AudioContext||window.webkitAudioContext));const y=await P.arrayBuffer();S&&S({step:"ì˜¤ë””ì˜¤ ë°ì´í„°ë¥¼ ë””ì½”ë”©í•˜ëŠ” ì¤‘...",percent:15});const d=await H.value.decodeAudioData(y),f=d.getChannelData(0),M=d.sampleRate,A=Math.floor(M/150);S&&S({step:"ìµœê³  ìŒëŸ‰ì„ íŒŒì•…í•˜ê³  ìˆìŠµë‹ˆë‹¤...",percent:25});let w=0;for(let n=0;n<f.length;n+=A){const c=Math.abs(f[n]||0);c>w&&(w=c)}w<.01&&(w=.1);const B=.45-(g-1)/29*.35,l=w*B,$=.35-(g-1)/29*.3;S&&S({step:"ë¹„íŠ¸ íŒ¨í„´ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...",percent:35});const _=[];let O=0;const T=new Float32Array(f.length);for(let n=0;n<f.length;n++)T[n]=Math.abs(f[n]||0);const x=Math.floor(M*.03);let U=0;for(let n=0;n<Math.min(x,T.length);n++)U+=T[n];const N=f.length/A;let q=0;for(let n=0;n<f.length;n+=A){q++;const c=n/M;U/x>l&&c-O>$&&(_.push(c),O=c);const E=Math.min(n+A,f.length);for(let L=n;L<E;L++){U-=T[L];const e=L+x;e<T.length&&(U+=T[e])}if(S&&q%Math.floor(N/10)===0){const L=q/N*35;S({step:"ë¹„íŠ¸ íŒ¨í„´ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...",percent:Math.floor(35+L)})}}S&&S({step:"ì¥ì• ë¬¼ì„ ìµœì  ë°°ì¹˜í•˜ê³  ìˆìŠµë‹ˆë‹¤...",percent:75});const m=[];for(let n=0;n<_.length;n++){const c=_[n];if(c!==void 0&&(m.push(c),n<_.length-1)){const C=_[n+1];if(C===void 0)continue;const E=C-c;E>$*2.5&&m.push(c+E/2),E>$*4&&(m.push(c+E/3),m.push(c+E*2/3))}}if(m.sort((n,c)=>n-c),m.length<30){const n=$*1.2;for(let c=0;c<d.duration;c+=n)m.some(E=>Math.abs(E-c)<$*.8)||m.push(c);m.sort((c,C)=>c-C)}S&&S({step:"BPMì„ ë¶„ì„í•˜ëŠ” ì¤‘...",percent:80});let J=120;if(_.length>=4){const n=[];for(let c=1;c<Math.min(_.length,50);c++){const C=_[c]-_[c-1];C>.2&&C<2&&n.push(C)}if(n.length>0){n.sort((E,L)=>E-L);const C=60/n[Math.floor(n.length/2)];J=Math.round(C/5)*5,J=Math.max(60,Math.min(200,J))}}const ae=60/J*4;console.log(`[AudioAnalyzer] Detected BPM: ${J}, Measure Length: ${ae.toFixed(3)}s`),S&&S({step:"ê³¡ì˜ ë¶„ìœ„ê¸° ë³€í™”ë¥¼ ê°ì§€í•˜ëŠ” ì¤‘...",percent:85});const Y=[],ee=M,X=[];for(let n=0;n<f.length;n+=ee){let c=0;const C=Math.min(f.length,n+ee);for(let E=n;E<C;E++){const L=f[E]??0;c+=L*L}X.push(Math.sqrt(c/(C-n||1)))}const v=6;let s=0,p=X[0]||.001,F=0,j=0;for(let n=0;n<X.length;n++){const c=X[n]??0;F+=c,j++;const C=n-s,E=Math.abs(c-p)/p;if(C>=v&&(E>.4||C>=15)){const L=F/j;Y.push({startTime:s,endTime:n,intensity:L}),s=n,F=0,j=0,p=L||.001}}if(s<X.length){const n=j>0?F/j:0;Y.push({startTime:s,endTime:d.duration,intensity:n})}const oe=Math.max(...Y.map(n=>n.intensity),.001);return Y.forEach(n=>{n.intensity=n.intensity/oe}),S&&S({step:"ë§µ ìƒì„±ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!",percent:100}),{buffer:d,obstacles:m,sections:Y,duration:d.duration,bpm:J,measureLength:ae}}}},ft={class:"play-page"},vt={key:0,class:"setup-container"},pt={key:0,class:"processing-overlay"},mt={class:"loader-content"},gt={class:"progress-bar"},yt={key:0,class:"time-left"},ht={key:1},wt={key:2,class:"failure-log"},bt={class:"fail-tag"},St={key:1,class:"desc"},At={key:2,class:"desc map-notice"},kt={class:"difficulty-select"},_t={class:"diff-header"},Dt={class:"slider-container"},Mt={key:2,class:"mode-modal-overlay"},Ct={class:"mode-modal glass-panel"},xt={class:"mode-options"},It={key:0,class:"rec-badge"},Tt="umm_audio_db",ne="audio_files",Et=ge({__name:"play",setup(H){const se=Ce(),P=h("upload"),g=h(null),{analyzeAudio:S}=dt(),y=h(null),d=h([]),f=h([]),M=h(!1),A=h({step:"",percent:0}),w=h(0),B=h(0),l=h(null),$=h(null),_=h(null),{user:O}=Se(),T=Me(),x=h(!1),U=h(!1),N=h(!1),q=h(!1),m=h(10),J=ye(()=>m.value<8?"EASY":m.value<16?"NORMAL":m.value<24?"HARD":"IMPOSSIBLE"),ie=e=>e<8?"#00ff88":e<16?"#ffff00":e<24?"#ff8800":"#ff0000",ae=e=>e<8?30:e<16?60:e<24?90:1/0,Y=async e=>{if(x.value=!1,U.value=e==="practice",N.value=e==="tutorial",e==="tutorial"){if(localStorage.setItem("umm_guide_seen","true"),q.value=!1,l.value&&(!l.value.autoplayLog||l.value.autoplayLog.length===0)){console.log("[Tutorial] Generating AI path for existing map...");const t=new pe({difficulty:l.value.difficulty||5,density:1,portalFrequency:.15});l.value.engineObstacles&&(t.obstacles=l.value.engineObstacles.map(o=>({...o}))),l.value.enginePortals&&(t.portals=l.value.enginePortals.map(o=>({...o}))),t.totalLength=(l.value.duration||120)*t.baseSpeed+1e3,t.computeAutoplayLog(200,360)&&t.autoplayLog.length>0&&(l.value.autoplayLog=t.autoplayLog,console.log("[Tutorial] AI Path Generated with",t.autoplayLog.length,"points"))}P.value="play"}else P.value="play"},ee=async e=>{if("type"in e&&e.type==="storage"){const i=e.data;if(l.value=i.mapData,d.value=i.mapData.beatTimes,f.value=i.mapData.sections,m.value=i.mapData.difficulty,i.mapData.audioData){const o=new(window.AudioContext||window.webkitAudioContext),u=await(await fetch(i.mapData.audioData)).arrayBuffer();y.value=await o.decodeAudioData(u),x.value=!0}else if(i.mapData._id){console.log("Loading recent map audio from IndexedDB...",i.mapData._id);try{const o=await L(i.mapData._id);if(o){const r=new(window.AudioContext||window.webkitAudioContext),u=await o.arrayBuffer();y.value=await r.decodeAudioData(u),x.value=!0}else alert("ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (IDB Miss)")}catch(o){console.error(o)}}else alert("ì˜¤ë””ì˜¤ ë°ì´í„°ê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");return}const t=e;g.value=t,M.value=!0,w.value=Date.now(),p.value=!1;try{const i=new(window.AudioContext||window.webkitAudioContext),o=await S(t,m.value,I=>{if(A.value=I,I.percent>5){const le=(Date.now()-w.value)/1e3,re=le/(I.percent/100);B.value=Math.max(0,re-le)}});y.value=o.buffer,d.value=o.obstacles,f.value=o.sections;const r=ae(m.value),u=Math.min(o.duration,r),b=o.obstacles.filter(I=>I<=u),W=o.sections.filter(I=>I.start<=u),G=new pe({difficulty:m.value,density:1,portalFrequency:.15}),R=Date.now()+Math.floor(Math.random()*1e6);let K=!1;for(let I=0;;I++){const le=I===0?"AIê°€ ë§µì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...":`ë§µ ë³´ì • ì¤‘... (${I+1}íšŒì°¨)`;if(A.value={step:le,percent:0},G.generateMap(b,W,u,R+I,!1,I,o.bpm,o.measureLength),K=await G.computeAutoplayLogAsync(200,360,re=>{A.value.percent=Math.floor(re*100)}),K){A.value.step="ë§µ ì €ì¥ ì¤‘...",$.value=null;break}if(G.validationFailureInfo&&($.value={x:Math.floor(G.validationFailureInfo.x),y:Math.floor(G.validationFailureInfo.y),rawObstacles:G.validationFailureInfo.nearObstacles},xe(()=>F())),I>5e3)break}if(K)l.value={title:t.name.substring(0,100),difficulty:m.value,seed:R,engineObstacles:G.obstacles,enginePortals:G.portals,autoplayLog:G.autoplayLog,duration:u,beatTimes:b,sections:W,bpm:o.bpm,measureLength:o.measureLength,audioData:null},await j(l.value),X(l.value),A.value.step="ì¤€ë¹„ ì™„ë£Œ!";else throw new Error("ì§€ë‚˜ê°ˆ ìˆ˜ ìˆëŠ” ë§µì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");setTimeout(()=>{M.value=!1,x.value=!0},500)}catch(i){console.error(i),M.value=!1,alert(i.message||"ì˜¤ë””ì˜¤ ë¶„ì„ ë˜ëŠ” ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤")}},X=async e=>{const t=JSON.parse(localStorage.getItem("umm_recent_maps")||"[]"),i={id:Date.now(),name:e.title,timestamp:Date.now(),mapData:{...e,audioData:null}};t.unshift(i),localStorage.setItem("umm_recent_maps",JSON.stringify(t.slice(0,10)))},v=()=>{P.value="play"},s=()=>{sessionStorage.getItem("umm_is_test")?(sessionStorage.removeItem("umm_is_test"),se.push("/editor")):(P.value="upload",x.value=!1,U.value=!1,N.value=!1)},p=h(!1),F=()=>{if(!_.value||!$.value)return;const e=_.value.getContext("2d");if(!e)return;const{x:t,y:i,rawObstacles:o}=$.value,r=_.value.width,u=_.value.height;e.fillStyle="#050510",e.fillRect(0,0,r,u);const b=.5,W=t-r/2/b,G=360-u/2/b;e.strokeStyle="rgba(255,255,255,0.05)";for(let R=0;R<r;R+=20)e.beginPath(),e.moveTo(R,0),e.lineTo(R,u),e.stroke();o.forEach(R=>{e.save(),e.translate((R.x-W)*b,(R.y-G)*b),R.angle&&e.rotate(R.angle*Math.PI/180),e.fillStyle=R.type==="spike"?"#ff4444":"#555",e.strokeStyle="#ff00ff",e.lineWidth=1;const K=R.width*b,I=R.height*b;R.type==="spike"?(e.beginPath(),R.y>300?(e.moveTo(0,I),e.lineTo(K/2,0),e.lineTo(K,I)):(e.moveTo(0,0),e.lineTo(K/2,I),e.lineTo(K,0)),e.fill(),e.stroke()):(e.fillRect(0,0,K,I),e.strokeRect(0,0,K,I)),e.restore()}),e.fillStyle="#fff",e.shadowBlur=10,e.shadowColor="#00ffff",e.beginPath(),e.arc((t-W)*b,(i-G)*b,5,0,Math.PI*2),e.fill()},j=async e=>{if(!p.value&&O.value&&!(U.value||N.value)&&!(!g.value&&!l.value?.audioUrl))try{const t={title:(g.value?.name||l.value?.title||"Unknown Map").substring(0,100),difficulty:e.difficulty,seed:d.value.length*777+Math.floor(e.duration*100),beatTimes:d.value,sections:f.value,engineObstacles:e.engineObstacles,enginePortals:e.enginePortals,autoplayLog:e.autoplayLog,duration:e.duration,creatorName:O.value?.username||"Guest",isShared:!1};let i=null,o=!1;g.value&&y.value?(t.audioUrl=`/audio/${g.value.name}`,console.log(`[Audio] Trimming audio from ${y.value.duration}s to ${e.duration}s`),i=await Te(y.value,e.duration),i.length>Ee?(console.log(`[Audio] Trimmed audio (${(i.length/1024/1024).toFixed(2)}MB) exceeds limit, will use chunked upload`),o=!0):t.audioData=i):l.value?.audioUrl&&(t.audioUrl=l.value.audioUrl,l.value.audioData&&l.value.audioData.length<100*1024*1024&&(t.audioData=l.value.audioData)),o&&(t.audioData=null,t.audioChunks=[]);const r=await $fetch("/api/maps",{method:"POST",body:t});if(p.value=!0,console.log(`[Database] Map successfully saved. ID: ${r._id}`),l.value&&(l.value._id=r._id),o&&i){console.log("[Audio] Starting chunked upload...");const u=$e(i,Be);for(let b=0;b<u.length;b++)console.log(`[Audio] Uploading chunk ${b+1}/${u.length}...`),await $fetch(`/api/maps/${r._id}/audio-chunk`,{method:"POST",body:{chunkIndex:b,chunkData:u[b],totalChunks:u.length}});console.log(`[Audio] All ${u.length} chunks uploaded successfully!`)}if(!t.audioData&&!o&&g.value){console.log("Saving original audio to local IndexedDB for fast auto-load...");try{await E(r._id,g.value),console.log("Audio successfully saved to local IndexedDB!")}catch(u){console.error("Failed to save to IndexedDB",u)}}}catch(t){console.error("Failed to save map auto-registration:",t)}},oe=async e=>{if(!l.value?._id||(!U.value&&!N.value&&e.score>(l.value.bestScore||0)&&(l.value.bestScore=e.score),U.value)||!O.value)return;const t=N.value?"tutorial_mode":l.value?._id;if(t)try{(await $fetch(`/api/maps/${t}/record`,{method:"POST",body:{score:e.score,progress:e.progress,username:O.value?.username||"Guest"}})).updated&&console.log(`[Record] New best record: ${e.score}`)}catch(i){console.error("Failed to update record:",i)}},n=async e=>{l.value=e,d.value=e.beatTimes||[],f.value=e.sections||[],m.value=e.difficulty||10;const t=new(window.AudioContext||window.webkitAudioContext),i=t.createBuffer(1,Math.max(1,t.sampleRate*(e.duration||10)),t.sampleRate);y.value=i,x.value=!0},c=async()=>{localStorage.getItem("umm_guide_seen")||(q.value=!0,x.value=!0);const t=sessionStorage.getItem("umm_load_map");if(t)try{const o=JSON.parse(t);if(sessionStorage.removeItem("umm_load_map"),l.value=o,d.value=o.beatTimes,f.value=o.sections,m.value=o.difficulty,o.audioData){const r=new(window.AudioContext||window.webkitAudioContext),b=await(await fetch(o.audioData)).arrayBuffer();y.value=await r.decodeAudioData(b),x.value=!0;return}else if(o.audioUrl){console.log("Map session data found with audioUrl. Trying to load...");try{const r=new(window.AudioContext||window.webkitAudioContext),u=await fetch(o.audioUrl);if(u.ok){const b=await u.arrayBuffer();y.value=await r.decodeAudioData(b),x.value=!0;return}}catch(r){console.warn("Failed to load audioUrl, falling back to silent",r)}await n(o);return}else{await n(o);return}}catch(o){console.error("Failed to parse session map:",o)}const i=T.query.map||T.query.mapId;if(i)try{M.value=!0;const o=await $fetch(`/api/maps/${i}`);if(o)if(l.value=o,d.value=o.beatTimes,f.value=o.sections,m.value=o.difficulty,o.audioData||o.audioUrl)try{let r=null;if(o.audioData&&(console.log("Loading audio from Base64 Data..."),r=await(await fetch(o.audioData)).arrayBuffer()),!r){console.log("Checking local IndexedDB for audio...");try{const u=await L(o._id);u&&(console.log("Found audio in local DB!"),r=await u.arrayBuffer())}catch(u){console.warn("IndexedDB check failed",u)}}if(!r&&o.audioUrl){console.log("Loading audio from URL:",o.audioUrl);try{const u=await fetch(o.audioUrl);u.ok?r=await u.arrayBuffer():console.warn("Audio URL fetch failed:",u.status)}catch(u){console.warn("Audio URL fetch error",u)}}if(r){const u=new(window.AudioContext||window.webkitAudioContext);y.value=await u.decodeAudioData(r),x.value=!0}else console.log("Could not find audio source. Prompting user."),alert(`ì˜¤ë””ì˜¤ íŒŒì¼ì„ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ì„œë²„/ë¡œì»¬ ì €ì¥ì†Œ ì—†ìŒ)
ì›ë³¸ ìŒì•… íŒŒì¼ì„ ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.`)}catch(r){console.warn("Auto-load failed, waiting for user file",r),alert("ì˜¤ë””ì˜¤ ë¡œë”© ì‹¤íŒ¨. íŒŒì¼ì„ ìˆ˜ë™ìœ¼ë¡œ ì„ íƒí•´ì£¼ì„¸ìš”.")}else await n(o)}catch(o){console.error("Failed to load map:",o)}finally{M.value=!1}};he(c),ce(()=>T.query.map,e=>{e&&c()}),ce(()=>T.query.mapId,e=>{e&&c()});const C=()=>new Promise((e,t)=>{const i=indexedDB.open(Tt,1);i.onupgradeneeded=o=>{const r=o.target.result;r.objectStoreNames.contains(ne)||r.createObjectStore(ne)},i.onsuccess=o=>e(o.target.result),i.onerror=o=>t(o)}),E=async(e,t)=>{const i=await C();return new Promise((o,r)=>{const W=i.transaction(ne,"readwrite").objectStore(ne).put(t,e);W.onsuccess=()=>o(),W.onerror=()=>r(W.error)})},L=async e=>{const t=await C();return new Promise((i,o)=>{const b=t.transaction(ne,"readonly").objectStore(ne).get(e);b.onsuccess=()=>i(b.result),b.onerror=()=>o(b.error)})};return(e,t)=>{const i=ct,o=Ie;return k(),D("div",ft,[t[20]||(t[20]=a("div",{class:"background-anim"},null,-1)),P.value==="upload"?(k(),D("div",vt,[M.value?(k(),D("div",pt,[a("div",mt,[t[6]||(t[6]=a("div",{class:"wave-loader"},"â—†",-1)),a("h2",null,V(A.value.step||"ë§µ ìƒì„± ì¤‘..."),1),a("div",gt,[a("div",{class:"fill",style:ve({width:A.value.percent+"%",animation:"none"})},null,4)]),B.value>0?(k(),D("p",yt,"ì˜ˆìƒ ë‚¨ì€ ì‹œê°„: ì•½ "+V(Math.ceil(B.value))+"ì´ˆ",1)):A.value.percent>0?(k(),D("p",ht,"ê±°ì˜ ë‹¤ ë˜ì—ˆìŠµë‹ˆë‹¤...")):Q("",!0),$.value?(k(),D("div",wt,[a("span",bt,"CRITICAL BLOCKAGE AT "+V($.value.x),1),a("canvas",{ref_key:"failCanvas",ref:_,width:"300",height:"150",class:"fail-preview"},null,512),t[5]||(t[5]=a("div",{class:"fail-details"}," AI failed to find a path through this section. ",-1))])):Q("",!0)])])):Q("",!0),t[12]||(t[12]=a("div",{class:"header-icon"},"â—†",-1)),t[13]||(t[13]=a("h1",{class:"title"},"ULTRA MUSIC MANIA",-1)),l.value?(k(),D("p",At,[t[7]||(t[7]=z(" ë¡œë“œëœ ë§µ: ",-1)),a("strong",null,V(l.value.title),1),t[8]||(t[8]=a("br",null,null,-1)),t[9]||(t[9]=z(" ê²Œì„ì„ ì‹œì‘í•˜ë ¤ë©´ ì´ ë§µì— ì‚¬ìš©ëœ ë…¸ë˜ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”. ",-1))])):(k(),D("p",St,"ìŒì•… íŒŒì¼ì„ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ ë§µì´ ìƒì„±ë©ë‹ˆë‹¤")),ke(i,{onSelect:ee}),a("div",kt,[a("div",_t,[t[10]||(t[10]=a("label",null,"ë‚œì´ë„ ì„¤ì •:",-1)),a("span",{class:"diff-value",style:ve({color:ie(m.value)})},V(J.value)+" ("+V(m.value)+") ",5)]),a("div",Dt,[_e(a("input",{type:"range",min:"1",max:"30","onUpdate:modelValue":t[0]||(t[0]=r=>m.value=r),class:"diff-slider"},null,512),[[De,m.value,void 0,{number:!0}]]),t[11]||(t[11]=a("div",{class:"slider-marks"},[a("span",null,"EASY"),a("span",null,"NORMAL"),a("span",null,"HARD"),a("span",null,"INSANE")],-1))])]),a("button",{class:"help-btn",onClick:t[1]||(t[1]=r=>e.showGuide=!0)},"?")])):Q("",!0),P.value==="play"?(k(),Ae(o,{key:1,audioBuffer:y.value,obstacles:d.value,sections:f.value,loadMap:l.value,difficulty:m.value,practiceMode:U.value,tutorialMode:N.value,onRetry:v,onExit:s,onMapReady:j,onRecordUpdate:oe},null,8,["audioBuffer","obstacles","sections","loadMap","difficulty","practiceMode","tutorialMode"])):Q("",!0),x.value?(k(),D("div",Mt,[a("div",Ct,[t[19]||(t[19]=a("h2",null,"SELECT GAME MODE",-1)),a("div",xt,[a("button",{onClick:t[2]||(t[2]=r=>Y("practice")),class:"mode-btn practice"},[...t[14]||(t[14]=[a("div",{class:"mode-icon"},"ğŸ› ï¸",-1),a("h3",null,"PRACTICE MODE",-1),a("p",null,[z("ì²´í¬í¬ì¸íŠ¸ ì‚¬ìš© ê°€ëŠ¥"),a("br"),z("ê¸°ë¡ ë¯¸ì €ì¥")],-1)])]),a("button",{onClick:t[3]||(t[3]=r=>Y("normal")),class:"mode-btn normal"},[...t[15]||(t[15]=[a("div",{class:"mode-icon"},"ğŸµ",-1),a("h3",null,"NORMAL MODE",-1),a("p",null,[z("í‘œì¤€ í”Œë ˆì´"),a("br"),z("ë­í‚¹ ê¸°ë¡ ì €ì¥")],-1)])]),a("button",{onClick:t[4]||(t[4]=r=>Y("tutorial")),class:te(["mode-btn tutorial",{recommended:q.value}])},[t[16]||(t[16]=a("div",{class:"mode-icon"},"ğŸ“",-1)),q.value?(k(),D("div",It,"RECOMMENDED")):Q("",!0),t[17]||(t[17]=a("h3",null,"TUTORIAL MODE",-1)),t[18]||(t[18]=a("p",null,[z("ê²Œì„ ê°€ì´ë“œ"),a("br"),z("ê¸°ì´ˆ ë°°ìš°ê¸°")],-1))],2)])])])):Q("",!0)])}}}),Ft=we(Et,[["__scopeId","data-v-cf2a24b9"]]);export{Ft as default};
