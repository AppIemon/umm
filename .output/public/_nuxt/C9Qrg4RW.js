import{e as it,r as u,h as Se,j as Ye,C as De,i as ot,c as v,a as s,k as p,n as st,m as se,t as _,p as nt,v as rt,o as f}from"./DdPwfpQH.js";import{G as ut}from"./BK6mPTWH.js";import{_ as ct}from"./DlAUqK2U.js";const dt={class:"game-wrapper"},vt={class:"game-container"},ft={class:"hud"},ht={class:"hud-top-left"},pt={class:"game-actions"},gt={class:"title-container"},yt={key:0,class:"game-title"},mt={key:1,class:"game-title tutorial"},wt={class:"progress-bar-container"},Mt={class:"progress-text"},Tt={class:"score-container"},St={class:"score-val"},xt={class:"speed-indicator"},kt={key:0,class:"mini-badge"},Pt={key:1,class:"mini-badge"},Ct={key:2,class:"autoplay-badge"},_t={key:3,class:"autoplay-badge tutorial"},At={key:4,class:"autoplay-badge practice"},Bt={key:0,class:"status-overlay fail"},Rt={class:"status-content"},It={key:0,class:"new-best-text"},Ot={class:"status-sub"},Et={class:"status-stats"},Lt={key:1,class:"status-overlay win"},Nt={class:"status-content"},Gt={class:"status-stats"},Xt={class:"video-save-section"},Ut=["disabled"],Yt={key:0},Dt={key:1},Ht={key:1,class:"save-success"},Wt={key:0,class:"rating-vote pointer-events-auto"},Vt={class:"rating-controls"},Ft={class:"rating-value"},Jt={key:1,class:"rating-done"},zt={key:2,class:"overlay countdown-overlay"},$t={class:"countdown-text"},Kt={key:3,class:"validation-status"},jt={class:"mini-progress"},qt={key:4,class:"checkpoint-indicator"},Zt={key:5,class:"controls-hint"},Qt={key:0},He=.1,bt=it({__name:"GameCanvas",props:{audioBuffer:{},obstacles:{},sections:{},autoRetry:{type:Boolean},loadMap:{},isViewOnly:{type:Boolean},multiplayerMode:{type:Boolean},difficulty:{},opponentY:{},opponentProgress:{},practiceMode:{type:Boolean},tutorialMode:{type:Boolean}},emits:["retry","exit","complete","map-ready","progress-update","record-update"],setup(x,{emit:We}){const o=x,E=We,A=u(null),a=u(new ut),y=u(!1),L=u(!1),B=u(0),H=u(0),W=u(""),N=u(0),V=u(null),xe=u(0),ne=u(!1),re=u(!1),X=u(o.difficulty||10),K=u(!1),ue=u(!1),U=u(0),ce=u(!1),j=u(15),q=u(!1),Z=u(!1),Q=u(!1);let Y=null,b=[];const Ve=async()=>{if(!(!o.loadMap?._id||q.value))try{await $fetch(`/api/maps/${o.loadMap._id}/rate`,{method:"POST",body:{rating:j.value}}),q.value=!0}catch{alert("Failed to submit rating.")}},Fe=()=>{if(A.value)try{b=[],Z.value=!1;const e=A.value.captureStream(30);if(c&&h)try{const r=c.createMediaStreamDestination();h.connect(r),r.stream.getAudioTracks().forEach(R=>e.addTrack(R))}catch{console.log("[Recording] Audio capture not available, video only")}const l={mimeType:"video/webm;codecs=vp9"};MediaRecorder.isTypeSupported(l.mimeType)||(l.mimeType="video/webm"),Y=new MediaRecorder(e,l),Y.ondataavailable=r=>{r.data&&r.data.size>0&&b.push(r.data)},Y.start(100),console.log("[Recording] Started")}catch(e){console.error("[Recording] Failed to start:",e)}},ke=()=>{Y&&Y.state!=="inactive"&&(Y.stop(),console.log("[Recording] Stopped"))},Je=async()=>{if(b.length===0){alert("ÎÖπÌôîÎêú ÏòÅÏÉÅÏù¥ ÏóÜÏäµÎãàÎã§. Îã§Ïãú ÌîåÎ†àÏù¥Ìï¥Ï£ºÏÑ∏Ïöî.");return}Q.value=!0;try{const e=new Blob(b,{type:"video/webm"}),l=o.loadMap?.title||"gameplay",r=new Date().toISOString().slice(0,19).replace(/[:-]/g,""),m=`UMM_${l}_${r}.webm`,R=URL.createObjectURL(e),O=document.createElement("a");O.href=R,O.download=m,document.body.appendChild(O),O.click(),document.body.removeChild(O),URL.revokeObjectURL(R),Z.value=!0,console.log("[Recording] Saved:",m)}catch(e){console.error("[Recording] Save failed:",e),alert("ÏòÅÏÉÅ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.")}finally{Q.value=!1}},I=u(0),ee=u(!1),de=u(0),F=u(!1);let ve=null;const fe=u(360),he=u(0);let c=null,h=null;const M=u([]);let pe=null,ge=null,te=!1,Pe,ae=0;const k=u(!1),ze=Se(()=>{const e=a.value.speedMultiplier;return e<.6?"#aa5500":e<.8?"#ff8800":e<1.1?"#4488ff":e<1.5?"#44ff44":e<1.8?"#ff44ff":"#ff4444"}),$e=Se(()=>{const e=a.value.speedMultiplier;return e<.6?"0.25x":e<.8?"0.5x":e<1.1?"1x":e<1.5?"2x":e<1.8?"3x":"4x"});Se(()=>X.value<8?"EASY":X.value<16?"NORMAL":X.value<24?"HARD":"IMPOSSIBLE");const Ke=async()=>{if(!c)return;const e=async l=>{try{const m=await(await fetch(l)).arrayBuffer();return await c.decodeAudioData(m)}catch(r){return console.error(`Failed to load sfx: ${l}`,r),null}};pe||(pe=await e("/audio/click_down.mp3")),ge||(ge=await e("/audio/click_up.mp3"))},Ce=(e,l=.5)=>{if(!(!c||!e))try{const r=c.createBufferSource(),m=c.createGain();r.buffer=e,m.gain.value=l,r.connect(m),m.connect(c.destination),r.start()}catch{}},ye=()=>{if(!o.audioBuffer||!A.value)return;le(),c||(c=new(window.AudioContext||window.webkitAudioContext)),c.state==="suspended"&&c.resume(),Ke();const e=o.multiplayerMode?!1:a.value.isAutoplay;a.value.setMapConfig({density:1,portalFrequency:.15,difficulty:X.value}),a.value.reset(),a.value.isAutoplay=e,K.value=e,o.loadMap?(a.value.loadMapData(o.loadMap),X.value=o.loadMap.difficulty,F.value=!0,o.tutorialMode&&o.loadMap.autoplayLog&&o.loadMap.autoplayLog.length>0&&(a.value.isAutoplay=!0,K.value=!0,console.log("[Tutorial] Using saved autoplayLog, length:",o.loadMap.autoplayLog.length)),o.loadMap.bestScore?U.value=Math.min(100,o.loadMap.bestScore/10):U.value=0):(a.value.generateMap(o.obstacles,o.sections,o.audioBuffer.duration,void 0,!1),o.tutorialMode&&(a.value.isAutoplay=!0,K.value=!0),Qe()),y.value=!1,L.value=!1,W.value="",N.value=0,H.value=0,B.value=0,ne.value=!1,te=!1,E("progress-update",{progress:0,ghostProgress:0}),E("progress-update",{progress:0,ghostProgress:0}),M.value.length===0?(ie(),Ae()):(M.value=[],ie(),Ae()),xe.value++},je=()=>{ue.value||(E("map-ready",{difficulty:X.value,engineObstacles:a.value.obstacles,enginePortals:a.value.portals,autoplayLog:a.value.autoplayLog,duration:o.audioBuffer.duration}),ue.value=!0)},qe=()=>{je()},_e=()=>{if(!o.practiceMode||y.value)return;const e={x:a.value.playerX,y:a.value.playerY,velocity:a.value.velocity,isHolding:a.value.isHolding,cameraX:a.value.cameraX,isGravityInverted:a.value.isGravityInverted,speedMultiplier:a.value.speedMultiplier,isMini:a.value.isMini,waveAngle:a.value.waveAngle,score:a.value.score,progress:a.value.progress,startTimeOffset:(c?.currentTime||0)-a.value.startTime,obstacles:JSON.parse(JSON.stringify(a.value.obstacles)),portals:JSON.parse(JSON.stringify(a.value.portals)),timestamp:Date.now()};M.value.push(e);const l=A.value?.getContext("2d");l&&(l.save(),l.fillStyle="#00ff00",l.font="bold 30px Arial",l.fillText("CHECKPOINT SET!",A.value.width/2,100),l.restore()),console.log("Checkpoint set at",checkpoint.progress+"%")},Ze=()=>{if(M.value.length===0||!o.practiceMode)return;const e=M.value[M.value.length-1];if(a.value.playerX=e.x,a.value.playerY=e.y,a.value.velocity=e.velocity,a.value.isHolding=e.isHolding,a.value.cameraX=e.cameraX,a.value.isGravityInverted=e.isGravityInverted,a.value.speedMultiplier=e.speedMultiplier,a.value.isMini=e.isMini,a.value.waveAngle=e.waveAngle,a.value.score=e.score,a.value.progress=e.progress,a.value.obstacles=JSON.parse(JSON.stringify(e.obstacles)),a.value.portals=JSON.parse(JSON.stringify(e.portals)),y.value=!1,L.value=!1,W.value="",k.value=!0,a.value.isDead=!1,a.value.isPlaying=!0,h)try{h.stop()}catch{}if(c&&o.audioBuffer){h=c.createBufferSource(),h.buffer=o.audioBuffer,h.connect(c.destination);const l=e.startTimeOffset;a.value.startTime=c.currentTime-l,h.start(0,l),ae=c.currentTime}me()},Qe=async()=>{if(!o.multiplayerMode){if(a.value.autoplayLog.length>0){F.value=!0;return}F.value=!1,ee.value=!0,de.value=0;for(let e=0;;e++)try{if(e>0&&(console.log(`[Validation] Retry ${e+1}: Regenerating map with updated offsets...`),a.value.generateMap(o.obstacles,o.sections,o.audioBuffer.duration,void 0,!1,e)),await a.value.computeAutoplayLogAsync(a.value.playerX,a.value.playerY,r=>{de.value=r*100})){console.log(`[Validation] Path found on Attempt ${e+1}!`),F.value=!0;break}else if(e>100){console.error("[Validation] Safeguard triggered: Stopped after 100 failed retries.");break}}catch(l){console.error("Background validation error:",l);break}ee.value=!1}},Ae=()=>{V.value="GO!",setTimeout(()=>{V.value=null,be()},400)},be=()=>{if(!c||!o.audioBuffer)return;h=c.createBufferSource(),h.buffer=o.audioBuffer,h.connect(c.destination),h.onended=()=>{!y.value&&k.value&&Re()};const e=c.currentTime+.05;h.start(e),a.value.isPlaying=!0,a.value.startTime=e,k.value=!0,ae=c.currentTime,Fe(),me()},le=()=>{if(k.value=!1,ve&&clearTimeout(ve),h){try{h.stop()}catch{}h.disconnect(),h=null}if(c){try{c.close()}catch{}c=null}cancelAnimationFrame(Pe)},J=e=>{if(e){const l=e.target;if(l&&(l.tagName==="INPUT"||l.tagName==="BUTTON"||l.closest(".no-prevent-default")))return;e.preventDefault()}!k.value||a.value.isAutoplay||a.value.setHolding(!0)},z=e=>{if(e){const l=e.target;if(l&&(l.tagName==="INPUT"||l.tagName==="BUTTON"||l.closest(".no-prevent-default")))return;e.preventDefault()}a.value.isAutoplay||a.value.setHolding(!1)},Be=e=>{e.code==="KeyC"&&o.practiceMode?_e():e.code==="KeyX"&&o.practiceMode&&M.value.length>0&&M.value.pop()};Ye(()=>{window.addEventListener("keydown",Be)}),De(()=>{window.removeEventListener("keydown",Be),le()});const et=()=>{if(y.value=!0,W.value=a.value.failReason||"CRASHED",N.value=a.value.getProgress(),k.value=!1,N.value>U.value?(U.value=N.value,ce.value=!0):ce.value=!1,h)try{h.stop()}catch{}ke(),E("record-update",{score:B.value,progress:H.value});const e=()=>{y.value&&(ie(),requestAnimationFrame(e))};e(),ve=setTimeout(()=>{y.value&&(o.practiceMode&&M.value.length>0?Ze():ye())},o.practiceMode?1e3:3e3)},Re=()=>{if(L.value=!0,k.value=!1,B.value=Math.floor(B.value+1e3),N.value=100,h)try{h.stop()}catch{}ke(),E("record-update",{score:B.value,progress:100}),E("complete",{score:B.value})},me=()=>{!k.value&&!y.value&&!L.value||(tt(),ie(),k.value&&(Pe=requestAnimationFrame(me)))},tt=()=>{if(!c)return;const e=c.currentTime,l=e-a.value.startTime;let r=e-ae;if(ae=e,r>.1&&(r=.1),r<0&&(r=0),a.value.update(r,l),I.value=l,a.value.isAutoplay&&(a.value.isHolding&&!te?Ce(pe,1.2):!a.value.isHolding&&te&&Ce(ge,.6),te=a.value.isHolding),B.value=a.value.score,H.value=a.value.progress,ne.value=a.value.isGravityInverted,re.value=a.value.isMini,a.value.isDead&&!y.value?et():!a.value.isPlaying&&k.value&&!y.value&&!L.value&&Re(),o.multiplayerMode&&a.value.totalLength>0){const m=a.value.playerX/a.value.totalLength*100;E("progress-update",{progress:Math.min(100,m),y:a.value.playerY,ghostProgress:o.opponentProgress||0});const R=o.opponentY!==void 0?o.opponentY:360,O=o.opponentProgress||0;fe.value+=(R-fe.value)*He,he.value+=(O-he.value)*He}},ie=()=>{const e=A.value?.getContext("2d");if(!e||!A.value)return;const l=A.value.width,r=A.value.height,m=e.createLinearGradient(0,0,0,r);m.addColorStop(0,"#0a0a1a"),m.addColorStop(.5,"#151530"),m.addColorStop(1,"#0a0a1a"),e.fillStyle=m,e.fillRect(0,0,l,r),e.save(),e.strokeStyle="rgba(80, 80, 180, 0.08)",e.lineWidth=1;const R=40,O=-a.value.cameraX%R;for(let t=O;t<l;t+=R)e.beginPath(),e.moveTo(t,0),e.lineTo(t,r),e.stroke();for(let t=0;t<r;t+=R)e.beginPath(),e.moveTo(0,t),e.lineTo(l,t),e.stroke();e.restore(),e.save(),e.translate(-a.value.cameraX,0);const we=a.value.isGravityInverted?"#ffff00":"#ff00ff",Me=a.value.isGravityInverted?"#ffff00":"#00ffff";if(e.fillStyle=we,e.globalAlpha=.15,e.fillRect(a.value.cameraX,0,l,a.value.minY),e.globalAlpha=1,e.fillStyle=Me,e.globalAlpha=.15,e.fillRect(a.value.cameraX,a.value.maxY,l,r-a.value.maxY),e.globalAlpha=1,e.strokeStyle=we,e.lineWidth=3,e.shadowBlur=15,e.shadowColor=we,e.beginPath(),e.moveTo(a.value.cameraX,a.value.minY),e.lineTo(a.value.cameraX+l,a.value.minY),e.stroke(),e.strokeStyle=Me,e.shadowColor=Me,e.beginPath(),e.moveTo(a.value.cameraX,a.value.maxY),e.lineTo(a.value.cameraX+l,a.value.maxY),e.stroke(),e.shadowBlur=0,a.value.portals.forEach(t=>{if(t.x+t.width<a.value.cameraX-50||t.x>a.value.cameraX+l+50)return;e.save(),t.angle&&(e.translate(t.x+t.width/2,t.y+t.height/2),e.rotate(t.angle*Math.PI/180),e.translate(-(t.x+t.width/2),-(t.y+t.height/2)));const T=a.value.getPortalColor(t.type),i=a.value.getPortalSymbol(t.type),n=t.type==="mini_pink"||t.type==="mini_green";if(e.globalAlpha=t.activated?.3:1,e.fillStyle=T,e.shadowBlur=20,e.shadowColor=T,n){const d=t.x+t.width/2,S=t.y+t.height/2,w=t.width/2,P=t.height/2,C=8;e.beginPath();for(let g=0;g<=C*2;g++){const D=Math.PI*2*g/(C*2)-Math.PI/2,Ge=g%2===0?1:.6,Xe=d+Math.cos(D)*w*Ge,Ue=S+Math.sin(D)*P*Ge;g===0?e.moveTo(Xe,Ue):e.lineTo(Xe,Ue)}e.closePath(),e.fill()}else e.beginPath(),e.roundRect(t.x,t.y,t.width,t.height,12),e.fill(),e.fillStyle="rgba(255,255,255,0.4)",e.beginPath(),e.roundRect(t.x+6,t.y+6,t.width-12,t.height-12,8),e.fill();e.shadowBlur=0,e.fillStyle="#000",e.font="bold 18px Outfit",e.textAlign="center",e.textBaseline="middle",e.fillText(i,t.x+t.width/2,t.y+t.height/2),e.restore()}),a.value.obstacles.forEach(t=>{if(t.x+t.width<a.value.cameraX-50||t.x>a.value.cameraX+l+50)return;if(e.save(),t.angle!==void 0&&t.angle!==0&&(e.translate(t.x+t.width/2,t.y+t.height/2),e.rotate(t.angle*Math.PI/180),e.translate(-(t.x+t.width/2),-(t.y+t.height/2))),t.type==="spike"||t.type==="mini_spike"){const i=t.type==="mini_spike";e.fillStyle=i?"#ff6666":"#ff4444",e.shadowBlur=i?8:12,e.shadowColor="#ff4444",e.beginPath(),t.y>300?(e.moveTo(t.x,t.y+t.height),e.lineTo(t.x+t.width/2,t.y),e.lineTo(t.x+t.width,t.y+t.height)):(e.moveTo(t.x,t.y),e.lineTo(t.x+t.width/2,t.y+t.height),e.lineTo(t.x+t.width,t.y)),e.closePath(),e.fill()}else if(t.type==="block")e.fillStyle="#444",e.shadowBlur=5,e.shadowColor="#666",e.fillRect(t.x,t.y,t.width,t.height),e.fillStyle="#555",e.fillRect(t.x+2,t.y+2,t.width-4,t.height-4);else if(t.type==="saw"){const i=t.x+t.width/2,n=t.y+t.height/2,d=t.width/2;e.fillStyle="#ffaa00",e.shadowBlur=20,e.shadowColor="#ffaa00",e.beginPath(),e.arc(i,n,d,0,Math.PI*2),e.fill(),e.fillStyle="#ff6600";const S=10,w=I.value*8;for(let P=0;P<S;P++){const C=Math.PI*2*P/S+w,g=i+Math.cos(C)*d*.75,D=n+Math.sin(C)*d*.75;e.beginPath(),e.arc(g,D,d*.15,0,Math.PI*2),e.fill()}e.fillStyle="#cc8800",e.beginPath(),e.arc(i,n,d*.25,0,Math.PI*2),e.fill()}else if(t.type==="spike_ball"){const i=t.x+t.width/2,n=t.y+t.height/2,d=t.width/2;e.fillStyle="#666",e.shadowBlur=15,e.shadowColor="#444";const S=8,w=I.value*3;e.fillStyle="#444";for(let C=0;C<S;C++){const g=Math.PI*2*C/S+w;e.beginPath();const D=i+Math.cos(g)*d*1.2,Ne=n+Math.sin(g)*d*1.2;e.moveTo(i+Math.cos(g-.2)*d*.8,n+Math.sin(g-.2)*d*.8),e.lineTo(D,Ne),e.lineTo(i+Math.cos(g+.2)*d*.8,n+Math.sin(g+.2)*d*.8),e.fill()}const P=e.createRadialGradient(i-d*.3,n-d*.3,d*.1,i,n,d);P.addColorStop(0,"#888"),P.addColorStop(1,"#222"),e.fillStyle=P,e.beginPath(),e.arc(i,n,d*.8,0,Math.PI*2),e.fill()}else if(t.type==="laser"){const i=t.y+t.height/2,n=Math.sin(I.value*15)*5+10;e.strokeStyle="#ff3333",e.lineWidth=2,e.shadowBlur=Math.max(0,n),e.shadowColor="#ff0000",e.beginPath(),e.moveTo(t.x,i),e.lineTo(t.x+t.width,i),e.stroke(),e.strokeStyle="#ffffff",e.lineWidth=1,e.shadowBlur=0,e.beginPath(),e.moveTo(t.x,i),e.lineTo(t.x+t.width,i),e.stroke(),e.fillStyle="#777",e.fillRect(t.x,t.y,8,t.height),e.fillRect(t.x+t.width-8,t.y,8,t.height)}else if(t.type==="v_laser"){const i=t.x+t.width/2,n=Math.sin(I.value*15)*5+10;e.strokeStyle="#ff3333",e.lineWidth=2,e.shadowBlur=Math.max(0,n),e.shadowColor="#ff0000",e.beginPath(),e.moveTo(i,t.y),e.lineTo(i,t.y+t.height),e.stroke(),e.strokeStyle="#ffffff",e.lineWidth=1,e.shadowBlur=0,e.beginPath(),e.moveTo(i,t.y),e.lineTo(i,t.y+t.height),e.stroke(),e.fillStyle="#777",e.fillRect(t.x,t.y,t.width,8),e.fillRect(t.x,t.y+t.height-8,t.width,8)}else if(t.type==="slope"){e.fillStyle="#444",e.shadowBlur=10,e.shadowColor="#666";const i=t.angle>0;e.beginPath(),i?(e.moveTo(t.x,t.y),e.lineTo(t.x+t.width,t.y),e.lineTo(t.x+(t.angle>0?0:t.width),t.y+t.height)):(e.moveTo(t.x,t.y+t.height),e.lineTo(t.x+t.width,t.y+t.height),e.lineTo(t.x+(t.angle<0?t.width:0),t.y)),e.closePath(),e.fill(),e.strokeStyle="rgba(255,255,255,0.2)",e.lineWidth=2,e.stroke()}else if(t.type==="mine"){const i=t.x+t.width/2,n=t.y+t.height/2,d=t.width/2,S=Math.sin(I.value*10)*.1+.9;e.fillStyle="#ff3333",e.shadowBlur=10,e.shadowColor="#ff0000",e.beginPath();for(let w=0;w<6;w++){const P=Math.PI/3*w+I.value*2,C=i+Math.cos(P)*d*S,g=n+Math.sin(P)*d*S;w===0?e.moveTo(C,g):e.lineTo(C,g)}e.closePath(),e.fill(),e.fillStyle="#550000",e.beginPath(),e.arc(i,n,d*.4,0,Math.PI*2),e.fill()}else if(t.type==="orb"){const i=t.x+t.width/2,n=t.y+t.height/2,d=t.width/2,S=Math.sin(I.value*5)*.1+1,w=e.createRadialGradient(i,n,d*.1,i,n,d*S);w.addColorStop(0,"#ffffff"),w.addColorStop(.4,"#aa44ff"),w.addColorStop(.8,"#4400cc"),w.addColorStop(1,"rgba(68, 0, 204, 0)"),e.fillStyle=w,e.globalCompositeOperation="lighter",e.beginPath(),e.arc(i,n,d*S,0,Math.PI*2),e.fill(),e.globalCompositeOperation="source-over"}e.restore()}),a.value.isAutoplay&&a.value.aiPredictedPath.length>1){e.save(),e.beginPath(),e.moveTo(a.value.aiPredictedPath[0].x,a.value.aiPredictedPath[0].y);for(let t=1;t<a.value.aiPredictedPath.length;t++)e.lineTo(a.value.aiPredictedPath[t].x,a.value.aiPredictedPath[t].y);e.strokeStyle="rgba(0, 255, 255, 0.15)",e.lineWidth=12,e.lineCap="round",e.lineJoin="round",e.stroke(),e.strokeStyle="rgba(0, 255, 255, 0.6)",e.lineWidth=3,e.stroke(),e.restore()}if(a.value.trail.length>1){e.beginPath(),e.moveTo(a.value.trail[0].x,a.value.trail[0].y);for(let T=1;T<a.value.trail.length;T++){const i=a.value.trail[T];i&&e.lineTo(i.x,i.y)}const t=a.value.isGravityInverted?"rgba(255, 255, 0, 0.6)":"rgba(0, 255, 255, 0.6)";e.strokeStyle=t,e.lineWidth=14,e.lineCap="round",e.lineJoin="round",e.shadowBlur=20,e.shadowColor=a.value.isGravityInverted?"#ffff00":"#00ffff",e.stroke(),e.shadowBlur=0}if(o.multiplayerMode){const T=he.value/100*a.value.totalLength,i=fe.value;e.save(),e.fillStyle="rgba(255, 0, 255, 0.8)",e.shadowBlur=20,e.shadowColor="#ff00ff";const n=35;e.translate(T,i),e.beginPath(),e.moveTo(n/2,0),e.lineTo(-n/3,-n/3),e.lineTo(-n/6,0),e.lineTo(-n/3,n/3),e.closePath(),e.fill(),e.fillStyle="white",e.font="bold 16px Outfit",e.textAlign="center",e.fillText("OPPONENT",0,-30),e.restore()}a.value.particles.forEach(t=>{e.fillStyle=t.color,e.globalAlpha=Math.max(0,t.life),e.beginPath(),e.arc(t.x,t.y,4,0,Math.PI*2),e.fill()}),e.globalAlpha=1,o.practiceMode&&M.value.forEach((t,T)=>{e.save();const i=15,n=T===M.value.length-1;e.translate(t.x,t.y),e.beginPath(),e.moveTo(0,-i),e.lineTo(i,0),e.lineTo(0,i),e.lineTo(-i,0),e.closePath(),n?(e.fillStyle="#00ff00",e.shadowBlur=15,e.shadowColor="#00ff00"):e.fillStyle="rgba(0, 255, 0, 0.4)",e.fill(),e.strokeStyle="#fff",e.lineWidth=2,e.stroke(),e.restore()});const Oe=a.value.playerX,Ee=a.value.playerY,$=a.value.playerSize,Le=a.value.isHolding?-1:1,at=a.value.isGravityInverted?-Le:Le,lt=Math.atan2(at,1);e.save(),e.translate(Oe,Ee),e.rotate(lt);const Te=a.value.isGravityInverted?"#ffff00":a.value.isHolding?"#00ffff":"#ff00ff";e.shadowBlur=25,e.shadowColor=Te;const G=$*1.2;e.beginPath(),e.moveTo(G,0),e.lineTo(-G*.5,-G*.6),e.lineTo(-G*.15,0),e.lineTo(-G*.5,G*.6),e.closePath();const oe=e.createLinearGradient(-G,0,G,0);oe.addColorStop(0,Te),oe.addColorStop(.5,"#ffffff"),oe.addColorStop(1,Te),e.fillStyle=oe,e.fill(),e.strokeStyle="#fff",e.lineWidth=1.5,e.stroke(),e.restore(),e.shadowBlur=0,a.value.showHitboxes&&(e.strokeStyle="#00ff00",e.lineWidth=2,e.strokeRect(Oe-$,Ee-$,$*2,$*2),e.strokeStyle="#ff0000",a.value.obstacles.forEach(t=>{if(t.x+t.width<a.value.cameraX-50||t.x>a.value.cameraX+l+100)return;const T=a.value.getObstacleStateAt(t,I.value),i=T.y,n=T.angle;e.save(),n!==0?(e.translate(t.x+t.width/2,i+t.height/2),e.rotate(n*Math.PI/180),e.strokeRect(-t.width/2,-t.height/2,t.width,t.height)):e.strokeRect(t.x,i,t.width,t.height),e.restore()})),e.restore()},Ie=()=>{if(document.hidden&&k.value){if(h)try{h.stop()}catch{}k.value=!1,y.value=!0,W.value="Ìè¨Ïª§Ïä§ Ïù¥ÌÉàÎ°ú Ï§ëÎã®Îê®"}};return Ye(()=>{window.addEventListener("keydown",e=>{e.repeat||(e.code==="Space"||e.code==="ArrowUp"||e.code==="KeyW")&&J(e)}),window.addEventListener("keyup",e=>{(e.code==="Space"||e.code==="ArrowUp"||e.code==="KeyW")&&z(e)}),window.addEventListener("mousedown",J),window.addEventListener("mouseup",z),window.addEventListener("touchstart",J,{passive:!1}),window.addEventListener("touchend",z,{passive:!1}),document.addEventListener("visibilitychange",Ie),ye()}),De(()=>{le(),window.removeEventListener("mousedown",J),window.removeEventListener("mouseup",z),window.removeEventListener("touchstart",J),window.removeEventListener("touchend",z),document.removeEventListener("visibilitychange",Ie)}),ot(()=>o.audioBuffer,()=>{le(),ye()}),(e,l)=>(f(),v("div",dt,[s("div",vt,[s("canvas",{ref_key:"canvas",ref:A,width:"1280",height:"720"},null,512),s("div",ft,[s("div",ht,[s("div",pt,[!x.multiplayerMode&&!x.loadMap&&F.value&&!ue.value?(f(),v("button",{key:0,onClick:qe,class:"hud-action-btn save"}," SAVE MAP ")):p("",!0),s("button",{onClick:l[0]||(l[0]=r=>E("exit",{progress:N.value,score:B.value,outcome:y.value?"fail":"win"})),class:"hud-action-btn exit"},"ÎÇòÍ∞ÄÍ∏∞"),x.practiceMode&&!y.value?(f(),v("button",{key:1,onClick:_e,class:"hud-action-btn checkpoint"},"SET CP (C)")):p("",!0)]),s("div",gt,[s("div",{class:st(["wave-icon",{inverted:ne.value}])},"‚ñ∂",2),x.tutorialMode?(f(),v("h1",mt,"TUTORIAL")):(f(),v("h1",yt,"ULTRA MUSIC MANIA"))]),s("div",wt,[s("div",{class:"progress-bar",style:se({width:H.value+"%"})},null,4),U.value>0?(f(),v("div",{key:0,class:"best-record-marker",style:se({left:U.value+"%"})},[...l[2]||(l[2]=[s("div",{class:"marker-line"},null,-1),s("span",{class:"marker-text"},"BEST",-1)])],4)):p("",!0),s("span",Mt,_(Math.floor(H.value))+"%",1)])]),s("div",Tt,[l[3]||(l[3]=s("div",{class:"score-label"},"SCORE",-1)),s("div",St,_(Math.floor(B.value)),1)]),s("div",xt,[s("span",{style:se({color:ze.value})},_($e.value),5),re.value?(f(),v("span",kt,"MINI")):p("",!0),re.value?(f(),v("span",Pt,"MINI")):p("",!0),K.value&&!x.tutorialMode?(f(),v("span",Ct,"AUTO MODE")):p("",!0),x.tutorialMode?(f(),v("span",_t,"TUTORIAL")):p("",!0),x.practiceMode?(f(),v("span",At,"PRACTICE")):p("",!0)]),y.value?(f(),v("div",Bt,[s("div",Rt,[l[5]||(l[5]=s("h1",{class:"status-text fail"},"CRASHED",-1)),ce.value?(f(),v("p",It,"üéâ NEW BEST! "+_(N.value)+"%",1)):p("",!0),s("p",Ot,_(W.value),1),s("div",Et,[s("span",null,_(N.value)+"% PROGRESS",1),l[4]||(l[4]=s("span",{class:"stat-divider"},"|",-1)),s("span",null,"ATTEMPT "+_(xe.value),1)])])])):p("",!0),L.value?(f(),v("div",Lt,[s("div",Nt,[l[8]||(l[8]=s("h1",{class:"status-text win"},"COMPLETE!",-1)),l[9]||(l[9]=s("p",{class:"status-sub"},"Î™®Îì† Ïû•Ïï†Î¨ºÏùÑ ÎèåÌååÌñàÏäµÎãàÎã§",-1)),s("div",Gt,[s("span",null,"SCORE "+_(Math.floor(B.value)),1)]),s("div",Xt,[Z.value?p("",!0):(f(),v("button",{key:0,onClick:Je,class:"save-video-btn",disabled:Q.value},[Q.value?(f(),v("span",Yt,"üíæ Ï†ÄÏû• Ï§ë...")):(f(),v("span",Dt,"üé¨ ÏòÅÏÉÅ Ï†ÄÏû•"))],8,Ut)),Z.value?(f(),v("p",Ht,"‚úÖ ÏòÅÏÉÅÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!")):p("",!0),l[6]||(l[6]=s("p",{class:"save-hint"},"ÌÅ¥Î¶¨Ïñ¥ Ïû•Î©¥ÏùÑ ÎèôÏòÅÏÉÅÏúºÎ°ú Ï†ÄÏû•Ìï©ÎãàÎã§",-1))]),x.loadMap&&x.loadMap._id&&!q.value?(f(),v("div",Wt,[l[7]||(l[7]=s("p",{class:"rating-label"},"RATE THIS MAP (1-30)",-1)),s("div",Vt,[nt(s("input",{type:"range",min:"1",max:"30","onUpdate:modelValue":l[1]||(l[1]=r=>j.value=r),class:"rating-slider"},null,512),[[rt,j.value,void 0,{number:!0}]]),s("span",Ft,_(j.value),1)]),s("button",{onClick:Ve,class:"submit-rating-btn"},"SUBMIT VOTE")])):q.value?(f(),v("div",Jt," THANK YOU FOR VOTING! ")):p("",!0)])])):p("",!0),V.value?(f(),v("div",zt,[s("div",$t,_(V.value),1)])):p("",!0),ee.value&&!y.value&&!L.value?(f(),v("div",Kt,[l[10]||(l[10]=s("div",{class:"status-msg"},"OPTIMIZING MAP...",-1)),s("div",jt,[s("div",{class:"fill",style:se({width:de.value+"%"})},null,4)])])):p("",!0),x.practiceMode&&M.value.length>0?(f(),v("div",qt," CPs: "+_(M.value.length)+" (Last: "+_(Math.floor(M.value[M.value.length-1].progress))+"%) ",1)):p("",!0),!V.value&&!y.value&&!L.value&&!ee.value?(f(),v("div",Zt,[l[11]||(l[11]=s("span",null,"ÌÅ¥Î¶≠/Ïä§ÌéòÏù¥Ïä§ Ïú†ÏßÄ = ÏúÑÎ°ú | Ìï¥Ï†ú = ÏïÑÎûòÎ°ú",-1)),x.practiceMode?(f(),v("span",Qt," | [C] Ï≤¥ÌÅ¨Ìè¨Ïù∏Ìä∏ | [X] ÏµúÍ∑º ÏÇ≠Ï†ú")):p("",!0)])):p("",!0)])])]))}}),la=Object.assign(ct(bt,[["__scopeId","data-v-a61d5f91"]]),{__name:"GameCanvas"});export{la as _};
