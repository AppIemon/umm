import{e as re,r as m,j as ce,i as se,c as v,o as d,a as o,k as R,n as K,F as le,l as ne,t as T,s as ie,p as ve,v as pe,q as me,b as ue,T as ye,w as he,d as P,f as ge,x as _e,h as we,y as be,m as fe,z as ke,A as Se}from"./CeYHdBDP.js";import{_ as de}from"./DlAUqK2U.js";import{_ as De}from"./DPyj6_7V.js";import{G as Ce}from"./DQ3TTau0.js";const xe={class:"song-selector"},Ae={class:"tabs"},Ie={key:0,class:"tab-content"},Me={class:"sample-list"},Te=["onClick"],Be={class:"sample-info"},$e={class:"sample-name"},Ee={class:"sample-meta"},Le={key:0,class:"loading-indicator"},Re={key:1,class:"tab-content"},Fe={key:0},Oe={key:1,class:"highlight"},Ue={key:2,class:"tab-content"},Ne={class:"youtube-input-container"},Ge=["disabled"],ze=["disabled"],je={key:0,class:"error-msg"},Pe={key:1,class:"youtube-preview"},Ve={class:"highlight"},qe={key:3,class:"tab-content"},Ye={key:0,class:"storage-list"},Je=["onClick"],Ke={class:"name"},He={class:"date"},We={key:1,class:"empty-msg"},Qe=["disabled"],Xe=re({__name:"SongSelector",emits:["select"],setup(H,{emit:$}){const A=$,y=m("samples"),n=m(null),C=m(null),h=m(null),w=m([{id:"1",name:"Electronic Future Beats",genre:"Electronic",duration:"2:30",url:"/api/samples?id=1"},{id:"2",name:"Synthwave Retro",genre:"Synthwave",duration:"2:00",url:"/api/samples?id=2"},{id:"3",name:"Epic Cinematic",genre:"Cinematic",duration:"2:45",url:"/api/samples?id=3"}]),g=m(null),b=m(null);async function S(f){g.value=f,i.value=null,h.value=null,b.value=f.id;try{const u=await fetch(f.url);if(!u.ok)throw new Error("Failed to load sample");const c=await u.blob(),E=new File([c],f.name+".mp3",{type:"audio/mpeg"});h.value=E,n.value=E}catch(u){console.error("Failed to load sample:",u),g.value=null}finally{b.value=null}}const G=m([]),i=m(null);function B(){const f=localStorage.getItem("umm_recent_maps");if(f)try{G.value=JSON.parse(f).sort((u,c)=>c.timestamp-u.timestamp)}catch(u){console.error(u)}}ce(B),se(y,f=>{f==="storage"&&B()});function I(f){i.value=f,h.value=null,g.value=null}const N=m(""),x=m(!1),z=m("");async function _(){if(N.value){x.value=!0,z.value="",n.value=null,h.value=null,g.value=null;try{const f=await fetch("/api/youtube",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:N.value})});if(!f.ok){const F=await f.json();throw new Error(F.message||"Failed to download")}const u=f.headers.get("content-disposition");let c="youtube_audio.mp3";if(u){const F=u.match(/filename\*=UTF-8''(.+)/);F&&F[1]&&(c=decodeURIComponent(F[1]))}const E=await f.blob(),Q=new File([E],c,{type:E.type||"audio/mpeg"});O(Q)}catch(f){console.error(f),z.value=f.message||"Failed to load YouTube video"}finally{x.value=!1}}}function W(){C.value?.click()}function J(f){const u=f.target;u.files?.[0]&&O(u.files[0])}function L(f){f.dataTransfer?.files?.[0]&&O(f.dataTransfer.files[0])}function O(f){n.value=f,h.value=f,i.value=null,g.value=null}async function te(){y.value==="storage"&&i.value?A("select",{type:"storage",data:i.value}):h.value&&A("select",h.value)}return(f,u)=>(d(),v("div",xe,[o("div",Ae,[o("button",{class:K({active:y.value==="samples"}),onClick:u[0]||(u[0]=c=>y.value="samples")},"SAMPLES",2),o("button",{class:K({active:y.value==="upload"}),onClick:u[1]||(u[1]=c=>y.value="upload")},"UPLOAD",2),o("button",{class:K({active:y.value==="youtube"}),onClick:u[2]||(u[2]=c=>y.value="youtube")},"YOUTUBE",2),o("button",{class:K({active:y.value==="storage"}),onClick:u[3]||(u[3]=c=>y.value="storage")},"STORAGE",2)]),y.value==="samples"?(d(),v("div",Ie,[u[6]||(u[6]=o("p",{class:"section-desc"},"CC0 ë¬´ë£Œ ìŒì•… - ì €ì‘ê¶Œ ê±±ì • ì—†ì´ ë°”ë¡œ í”Œë ˆì´!",-1)),o("div",Me,[(d(!0),v(le,null,ne(w.value,c=>(d(),v("div",{key:c.id,class:K(["sample-item",{selected:g.value?.id===c.id,loading:b.value===c.id}]),onClick:E=>S(c)},[o("div",Be,[o("span",$e,T(c.name),1),o("span",Ee,T(c.genre)+" â€¢ "+T(c.duration),1)]),b.value===c.id?(d(),v("span",Le,"â—†")):R("",!0)],10,Te))),128))])])):y.value==="upload"?(d(),v("div",Re,[o("div",{class:"drop-zone",onDragover:u[4]||(u[4]=ie(()=>{},["prevent"])),onDrop:ie(L,["prevent"]),onClick:W},[n.value?(d(),v("p",Oe,T(n.value.name),1)):(d(),v("p",Fe,"DROP FILE HERE"))],32),o("input",{type:"file",ref_key:"fileInput",ref:C,accept:"audio/*",style:{display:"none"},onChange:J},null,544)])):y.value==="youtube"?(d(),v("div",Ue,[o("div",Ne,[ve(o("input",{"onUpdate:modelValue":u[5]||(u[5]=c=>N.value=c),type:"text",placeholder:"Paste YouTube URL here...",onKeyup:me(_,["enter"]),disabled:x.value},null,40,Ge),[[pe,N.value]]),o("button",{class:"fetch-btn",onClick:_,disabled:!N.value||x.value},T(x.value?"LOADING...":"LOAD"),9,ze)]),z.value?(d(),v("p",je,T(z.value),1)):R("",!0),n.value&&y.value==="youtube"?(d(),v("div",Pe,[o("p",Ve,"Loaded: "+T(n.value.name),1)])):R("",!0)])):y.value==="storage"?(d(),v("div",qe,[G.value.length>0?(d(),v("div",Ye,[(d(!0),v(le,null,ne(G.value,c=>(d(),v("div",{key:c.id,class:K(["storage-item",{selected:i.value?.id===c.id}]),onClick:E=>I(c)},[o("span",Ke,T(c.name),1),o("span",He,T(new Date(c.timestamp).toLocaleDateString()),1)],10,Je))),128))])):(d(),v("p",We,"NO RECENT DATA FOUND"))])):R("",!0),o("button",{class:"confirm-btn",disabled:!h.value&&!i.value&&!g.value||x.value||b.value,onClick:te}," SELECT ",8,Qe)]))}}),Ze=Object.assign(de(Xe,[["__scopeId","data-v-cebb9462"]]),{__name:"SongSelector"}),et=()=>{const H=m(null);return{analyzeAudio:async(A,y,n)=>{n&&n({step:"ì˜¤ë””ì˜¤ í—¤ë”ë¥¼ ì½ëŠ” ì¤‘...",percent:5}),H.value||(H.value=new(window.AudioContext||window.webkitAudioContext));const C=await A.arrayBuffer();n&&n({step:"ì˜¤ë””ì˜¤ ë°ì´í„°ë¥¼ ë””ì½”ë”©í•˜ëŠ” ì¤‘...",percent:15});const h=await H.value.decodeAudioData(C),w=h.getChannelData(0),g=h.sampleRate,b=Math.floor(g/150);n&&n({step:"ìµœê³  ìŒëŸ‰ì„ íŒŒì•…í•˜ê³  ìˆìŠµë‹ˆë‹¤...",percent:25});let S=0;for(let s=0;s<w.length;s+=b){const e=Math.abs(w[s]||0);e>S&&(S=e)}S<.01&&(S=.1);const G=.45-(y-1)/29*.35,i=S*G,B=.35-(y-1)/29*.3;n&&n({step:"ë¹„íŠ¸ íŒ¨í„´ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...",percent:35});const I=[];let N=0;const x=new Float32Array(w.length);for(let s=0;s<w.length;s++)x[s]=Math.abs(w[s]||0);const z=Math.floor(g*.03);let _=0;for(let s=0;s<Math.min(z,x.length);s++)_+=x[s];const W=w.length/b;let J=0;for(let s=0;s<w.length;s+=b){J++;const e=s/g;_/z>i&&e-N>B&&(I.push(e),N=e);const l=Math.min(s+b,w.length);for(let a=s;a<l;a++){_-=x[a];const r=a+z;r<x.length&&(_+=x[r])}if(n&&J%Math.floor(W/10)===0){const a=J/W*35;n({step:"ë¹„íŠ¸ íŒ¨í„´ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...",percent:Math.floor(35+a)})}}n&&n({step:"ì¥ì• ë¬¼ì„ ìµœì  ë°°ì¹˜í•˜ê³  ìˆìŠµë‹ˆë‹¤...",percent:75});const L=[];for(let s=0;s<I.length;s++){const e=I[s];if(e!==void 0&&(L.push(e),s<I.length-1)){const t=I[s+1];if(t===void 0)continue;const l=t-e;l>B*2.5&&L.push(e+l/2),l>B*4&&(L.push(e+l/3),L.push(e+l*2/3))}}if(L.sort((s,e)=>s-e),L.length<30){const s=B*1.2;for(let e=0;e<h.duration;e+=s)L.some(l=>Math.abs(l-e)<B*.8)||L.push(e);L.sort((e,t)=>e-t)}n&&n({step:"BPMì„ ë¶„ì„í•˜ëŠ” ì¤‘...",percent:80});let O=120;if(I.length>=4){const s=[];for(let e=1;e<Math.min(I.length,50);e++){const t=I[e]-I[e-1];t>.2&&t<2&&s.push(t)}if(s.length>0){s.sort((l,a)=>l-a);const t=60/s[Math.floor(s.length/2)];O=Math.round(t/5)*5,O=Math.max(60,Math.min(200,O))}}const f=60/O*4;console.log(`[AudioAnalyzer] Detected BPM: ${O}, Measure Length: ${f.toFixed(3)}s`),n&&n({step:"ê³¡ì˜ ë¶„ìœ„ê¸° ë³€í™”ë¥¼ ê°ì§€í•˜ëŠ” ì¤‘...",percent:85});const u=[],c=g,E=[];for(let s=0;s<w.length;s+=c){let e=0;const t=Math.min(w.length,s+c);for(let l=s;l<t;l++){const a=w[l]??0;e+=a*a}E.push(Math.sqrt(e/(t-s||1)))}const Q=6;let F=0,X=E[0]||.001,q=0,Y=0;for(let s=0;s<E.length;s++){const e=E[s]??0;q+=e,Y++;const t=s-F,l=Math.abs(e-X)/X;if(t>=Q&&(l>.4||t>=15)){const a=q/Y;u.push({startTime:F,endTime:s,intensity:a}),F=s,q=0,Y=0,X=a||.001}}if(F<E.length){const s=Y>0?q/Y:0;u.push({startTime:F,endTime:h.duration,intensity:s})}const ae=Math.max(...u.map(s=>s.intensity),.001);return u.forEach(s=>{s.intensity=s.intensity/ae}),n&&n({step:"ë§µ ìƒì„±ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!",percent:100}),{buffer:h,obstacles:L,sections:u,duration:h.duration,bpm:O,measureLength:f}}}},tt={class:"guide-modal"},at={class:"guide-content"},ot={class:"step-image"},st={key:0,class:"demo-box input-demo"},lt={key:1,class:"demo-box portal-demo"},nt={key:2,class:"demo-box tips-demo"},it={class:"step-text"},ut={class:"guide-footer"},rt={class:"dots"},ct=["onClick"],dt={class:"buttons"},ft=re({__name:"GameGuide",props:{modelValue:{type:Boolean}},emits:["update:modelValue","close"],setup(H,{emit:$}){const A=$,y=m(!0),n=m(0),C=[{title:"ê¸°ë³¸ ì¡°ì‘",desc:"ìŠ¤í˜ì´ìŠ¤ë°”ë‚˜ ë§ˆìš°ìŠ¤ ì™¼ìª½ ë²„íŠ¼ì„ ê¸¸ê²Œ ëˆ„ë¥´ë©´ ìœ„ë¡œ ì˜¬ë¼ê°€ê³ , ë–¼ë©´ ì•„ë˜ë¡œ ë‚´ë ¤ì˜µë‹ˆë‹¤. íŒŒë„ì²˜ëŸ¼ ë¦¬ë“¬ì„ íƒ€ë³´ì„¸ìš”!"},{title:"í¬íƒˆ ì‹œìŠ¤í…œ",desc:"ë‹¤ì–‘í•œ í¬íƒˆì„ í†µê³¼í•˜ë©´ ì†ë„ê°€ ë¹¨ë¼ì§€ê±°ë‚˜, ì¤‘ë ¥ì´ ë°˜ëŒ€ë¡œ ë°”ë€Œê±°ë‚˜, ê¸°ì²´ê°€ ì‘ì•„ì§‘ë‹ˆë‹¤. ë³€í™”ì— ë¹ ë¥´ê²Œ ì ì‘í•˜ì„¸ìš”!"},{title:"ìƒì¡´ ì „ëµ",desc:"ìŒì•…ì˜ ë¹„íŠ¸ì— ë§ì¶° ì¥ì• ë¬¼ì´ ë“±ì¥í•©ë‹ˆë‹¤. ëˆˆìœ¼ë¡œë§Œ ë³´ì§€ ë§ê³ , ê·€ë¡œ ë“¤ìœ¼ë©° ë¦¬ë“¬ì„ íƒ€ë©´ ë” ì‰½ê²Œ í”¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."}],h=()=>{n.value<C.length-1?n.value++:g()},w=()=>{n.value>0&&n.value--},g=()=>{y.value=!1,A("update:modelValue",!1),A("close"),localStorage.setItem("umm_guide_seen","true")};return ce(()=>{}),(b,S)=>y.value?(d(),v("div",{key:0,class:"guide-overlay",onClick:ie(g,["self"])},[o("div",tt,[o("div",{class:"guide-header"},[S[0]||(S[0]=o("h2",null,"â˜… GAME GUIDE â˜…",-1)),o("button",{class:"close-btn",onClick:g},"Ã—")]),o("div",at,[ue(ye,{name:"slide-fade",mode:"out-in"},{default:he(()=>[(d(),v("div",{key:n.value,class:"step-container"},[o("div",ot,[n.value===0?(d(),v("div",st,[...S[1]||(S[1]=[o("div",{class:"key-icon space"},"SPACE",-1),o("div",{class:"key-icon mouse"},"CLICK",-1),o("p",null,[P("ëˆ„ë¥´ê³  ìˆìœ¼ë©´ "),o("strong",null,"ìƒìŠ¹"),o("br"),P("ë–¼ë©´ "),o("strong",null,"í•˜ê°•")],-1)])])):R("",!0),n.value===1?(d(),v("div",lt,[...S[2]||(S[2]=[o("div",{class:"portal-row"},[o("span",{class:"p-icon speed"},">>"),o("span",null,"ì†ë„ ë³€í™”")],-1),o("div",{class:"portal-row"},[o("span",{class:"p-icon gravity"},"âŸ³"),o("span",null,"ì¤‘ë ¥ ë°˜ì „")],-1),o("div",{class:"portal-row"},[o("span",{class:"p-icon mini"},"â—†"),o("span",null,"ë¯¸ë‹ˆ ëª¨ë“œ")],-1)])])):R("",!0),n.value===2?(d(),v("div",nt,[...S[3]||(S[3]=[o("div",{class:"tip-item"},[P("âš¡ "),o("strong",null,"ë¶‰ì€ìƒ‰"),P("ì€ ì¥ì• ë¬¼ì…ë‹ˆë‹¤. í”¼í•˜ì„¸ìš”!")],-1),o("div",{class:"tip-item"},[P("ğŸµ "),o("strong",null,"ë°•ì"),P("ì— ë§ì¶° ì›€ì§ì´ëŠ”ê²Œ ì¤‘ìš”í•©ë‹ˆë‹¤.")],-1),o("div",{class:"tip-item"},[P("â˜… "),o("strong",null,"100%"),P(" ì™„ì£¼ì— ë„ì „í•˜ì„¸ìš”!")],-1)])])):R("",!0)]),o("div",it,[o("h3",null,T(C[n.value].title),1),o("p",null,T(C[n.value].desc),1)])]))]),_:1})]),o("div",ut,[o("div",rt,[(d(),v(le,null,ne(C,(G,i)=>o("span",{key:i,class:K({active:i===n.value}),onClick:B=>n.value=i},null,10,ct)),64))]),o("div",dt,[n.value>0?(d(),v("button",{key:0,class:"btn prev",onClick:w},"ì´ì „")):R("",!0),n.value<C.length-1?(d(),v("button",{key:1,class:"btn next",onClick:h},"ë‹¤ìŒ")):(d(),v("button",{key:2,class:"btn start",onClick:g},"ì‹œì‘í•˜ê¸°!"))])])])])):R("",!0)}}),vt=Object.assign(de(ft,[["__scopeId","data-v-e65ae73c"]]),{__name:"GameGuide"}),pt={class:"play-page"},mt={key:0,class:"setup-container"},yt={key:0,class:"processing-overlay"},ht={class:"loader-content"},gt={class:"progress-bar"},_t={key:0,class:"time-left"},wt={key:1},bt={key:2,class:"failure-log"},kt={class:"fail-tag"},St={key:1,class:"desc"},Dt={key:2,class:"desc map-notice"},Ct={class:"difficulty-select"},xt={class:"diff-header"},At={class:"slider-container"},It="umm_audio_db",Z="audio_files",Mt=re({__name:"play",setup(H){const $=m("upload"),A=m(null),y=m(!1),{analyzeAudio:n}=et(),C=m(null),h=m([]),w=m([]),g=m(!1),b=m({step:"",percent:0}),S=m(0),G=m(0),i=m(null),B=m(null),I=m(null),{user:N}=ge(),x=ke(),z=_e(),_=m(10),W=we(()=>_.value<8?"EASY":_.value<16?"NORMAL":_.value<24?"HARD":"IMPOSSIBLE"),J=e=>e<8?"#00ff88":e<16?"#ffff00":e<24?"#ff8800":"#ff0000",L=e=>e<8?30:e<16?60:e<24?90:1/0,O=async e=>{if("type"in e&&e.type==="storage"){const l=e.data;if(i.value=l.mapData,h.value=l.mapData.beatTimes,w.value=l.mapData.sections,_.value=l.mapData.difficulty,l.mapData.audioData){const a=new(window.AudioContext||window.webkitAudioContext),p=await(await fetch(l.mapData.audioData)).arrayBuffer();C.value=await a.decodeAudioData(p),$.value="play"}else if(l.mapData._id){console.log("Loading recent map audio from IndexedDB...",l.mapData._id);try{const a=await s(l.mapData._id);if(a){const r=new(window.AudioContext||window.webkitAudioContext),p=await a.arrayBuffer();C.value=await r.decodeAudioData(p),$.value="play"}else alert("ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (IDB Miss)")}catch(a){console.error(a)}}else alert("ì˜¤ë””ì˜¤ ë°ì´í„°ê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");return}const t=e;A.value=t,g.value=!0,S.value=Date.now(),c.value=!1;try{const l=new(window.AudioContext||window.webkitAudioContext),a=await n(t,_.value,k=>{if(b.value=k,k.percent>5){const ee=(Date.now()-S.value)/1e3,oe=ee/(k.percent/100);G.value=Math.max(0,oe-ee)}});C.value=a.buffer,h.value=a.obstacles,w.value=a.sections;const r=L(_.value),p=Math.min(a.duration,r),D=a.obstacles.filter(k=>k<=p),V=a.sections.filter(k=>k.start<=p),U=new Ce({difficulty:_.value,density:1,portalFrequency:.15}),M=Date.now()+Math.floor(Math.random()*1e6);let j=!1;for(let k=0;;k++){const ee=k===0?"AIê°€ ë§µì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...":`ë§µ ë³´ì • ì¤‘... (${k+1}íšŒì°¨)`;if(b.value={step:ee,percent:0},U.generateMap(D,V,p,M+k,!1,k,a.bpm,a.measureLength),j=await U.computeAutoplayLogAsync(200,360,oe=>{b.value.percent=Math.floor(oe*100)}),j){b.value.step="ë§µ ì €ì¥ ì¤‘...",B.value=null;break}if(U.validationFailureInfo&&(B.value={x:Math.floor(U.validationFailureInfo.x),y:Math.floor(U.validationFailureInfo.y),rawObstacles:U.validationFailureInfo.nearObstacles},Se(()=>E())),k>100)break}if(j)i.value={title:t.name.substring(0,100),difficulty:_.value,seed:M,engineObstacles:U.obstacles,enginePortals:U.portals,autoplayLog:U.autoplayLog,duration:p,beatTimes:D,sections:V,bpm:a.bpm,measureLength:a.measureLength,audioData:null},await Q(i.value),te(i.value),b.value.step="ì¤€ë¹„ ì™„ë£Œ!";else throw new Error("ì§€ë‚˜ê°ˆ ìˆ˜ ìˆëŠ” ë§µì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");setTimeout(()=>{g.value=!1,$.value="play"},500)}catch(l){console.error(l),g.value=!1,alert(l.message||"ì˜¤ë””ì˜¤ ë¶„ì„ ë˜ëŠ” ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤")}},te=async e=>{const t=JSON.parse(localStorage.getItem("umm_recent_maps")||"[]"),l={id:Date.now(),name:e.title,timestamp:Date.now(),mapData:{...e,audioData:null}};t.unshift(l),localStorage.setItem("umm_recent_maps",JSON.stringify(t.slice(0,10)))},f=()=>{$.value="play"},u=()=>{sessionStorage.getItem("umm_is_test")?(sessionStorage.removeItem("umm_is_test"),z.push("/editor")):$.value="upload"},c=m(!1),E=()=>{if(!I.value||!B.value)return;const e=I.value.getContext("2d");if(!e)return;const{x:t,y:l,rawObstacles:a}=B.value,r=I.value.width,p=I.value.height;e.fillStyle="#050510",e.fillRect(0,0,r,p);const D=.5,V=t-r/2/D,U=360-p/2/D;e.strokeStyle="rgba(255,255,255,0.05)";for(let M=0;M<r;M+=20)e.beginPath(),e.moveTo(M,0),e.lineTo(M,p),e.stroke();a.forEach(M=>{e.save(),e.translate((M.x-V)*D,(M.y-U)*D),M.angle&&e.rotate(M.angle*Math.PI/180),e.fillStyle=M.type==="spike"?"#ff4444":"#555",e.strokeStyle="#ff00ff",e.lineWidth=1;const j=M.width*D,k=M.height*D;M.type==="spike"?(e.beginPath(),M.y>300?(e.moveTo(0,k),e.lineTo(j/2,0),e.lineTo(j,k)):(e.moveTo(0,0),e.lineTo(j/2,k),e.lineTo(j,0)),e.fill(),e.stroke()):(e.fillRect(0,0,j,k),e.strokeRect(0,0,j,k)),e.restore()}),e.fillStyle="#fff",e.shadowBlur=10,e.shadowColor="#00ffff",e.beginPath(),e.arc((t-V)*D,(l-U)*D,5,0,Math.PI*2),e.fill()},Q=async e=>{if(!c.value&&!(!A.value&&!i.value?.audioUrl))try{const t={title:(A.value?.name||i.value?.title||"Unknown Map").substring(0,100),difficulty:e.difficulty,seed:h.value.length*777+Math.floor(e.duration*100),beatTimes:h.value,sections:w.value,engineObstacles:e.engineObstacles,enginePortals:e.enginePortals,autoplayLog:e.autoplayLog,duration:e.duration,creatorName:N.value?.username||"Guest",isShared:!1};if(A.value)if(t.audioUrl=`/audio/${A.value.name}`,A.value.size<4.5*1024*1024){const a=new FileReader,r=new Promise(p=>{a.onload=()=>p(a.result),a.readAsDataURL(A.value)});t.audioData=await r}else console.log("Audio file too large for server (>4.5MB). Will attempt local IndexedDB backup.");else i.value?.audioUrl&&(t.audioUrl=i.value.audioUrl,i.value.audioData&&i.value.audioData.length<100*1024*1024&&(t.audioData=i.value.audioData));const l=await $fetch("/api/maps",{method:"POST",body:t});if(c.value=!0,console.log(`[Database] Map successfully saved. ID: ${l._id}`),i.value&&(i.value._id=l._id),!t.audioData&&A.value){console.log("Large file detected. Saving audio to local IndexedDB for auto-load...");try{await ae(l._id,A.value),console.log("Audio successfully saved to local IndexedDB!")}catch(a){console.error("Failed to save to IndexedDB",a),alert("ì˜¤ë””ì˜¤ íŒŒì¼ì´ ë„ˆë¬´ ì»¤ì„œ ì„œë²„ ë° ë¡œì»¬ ë°±ì—…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}}}catch(t){console.error("Failed to save map auto-registration:",t)}},F=async e=>{if(i.value?._id){e.score>(i.value.bestScore||0)&&(i.value.bestScore=e.score);try{(await $fetch(`/api/maps/${i.value._id}/record`,{method:"POST",body:{score:e.score,username:N.value?.username||"Guest"}})).updated&&console.log(`[Record] New best record: ${e.score}`)}catch(t){console.error("Failed to update record:",t)}}},X=async e=>{i.value=e,h.value=e.beatTimes,w.value=e.sections,_.value=e.difficulty;const t=new(window.AudioContext||window.webkitAudioContext),l=t.createBuffer(1,Math.max(1,t.sampleRate*(e.duration||10)),t.sampleRate);C.value=l,$.value="play"},q=async()=>{localStorage.getItem("umm_guide_seen")||(y.value=!0);const t=sessionStorage.getItem("umm_load_map");if(t)try{const a=JSON.parse(t);if(sessionStorage.removeItem("umm_load_map"),i.value=a,h.value=a.beatTimes,w.value=a.sections,_.value=a.difficulty,a.audioData){const r=new(window.AudioContext||window.webkitAudioContext),D=await(await fetch(a.audioData)).arrayBuffer();C.value=await r.decodeAudioData(D),$.value="play";return}else if(a.audioUrl)console.log("Map session data found but missing audioData. Waiting for user file.");else{await X(a);return}}catch(a){console.error("Failed to parse session map:",a)}const l=x.query.map||x.query.mapId;if(l)try{g.value=!0;const a=await $fetch(`/api/maps/${l}`);if(a)if(i.value=a,h.value=a.beatTimes,w.value=a.sections,_.value=a.difficulty,a.audioData||a.audioUrl)try{let r=null;if(a.audioData&&(console.log("Loading audio from Base64 Data..."),r=await(await fetch(a.audioData)).arrayBuffer()),!r){console.log("Checking local IndexedDB for audio...");try{const p=await s(a._id);p&&(console.log("Found audio in local DB!"),r=await p.arrayBuffer())}catch(p){console.warn("IndexedDB check failed",p)}}if(!r&&a.audioUrl){console.log("Loading audio from URL:",a.audioUrl);try{const p=await fetch(a.audioUrl);p.ok?r=await p.arrayBuffer():console.warn("Audio URL fetch failed:",p.status)}catch(p){console.warn("Audio URL fetch error",p)}}if(r){const p=new(window.AudioContext||window.webkitAudioContext);C.value=await p.decodeAudioData(r),$.value="play"}else console.log("Could not find audio source. Prompting user."),alert(`ì˜¤ë””ì˜¤ íŒŒì¼ì„ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ì„œë²„/ë¡œì»¬ ì €ì¥ì†Œ ì—†ìŒ)
ì›ë³¸ ìŒì•… íŒŒì¼ì„ ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.`)}catch(r){console.warn("Auto-load failed, waiting for user file",r),alert("ì˜¤ë””ì˜¤ ë¡œë”© ì‹¤íŒ¨. íŒŒì¼ì„ ìˆ˜ë™ìœ¼ë¡œ ì„ íƒí•´ì£¼ì„¸ìš”.")}else await X(a)}catch(a){console.error("Failed to load map:",a)}finally{g.value=!1}};ce(q),se(()=>x.query.map,e=>{e&&q()}),se(()=>x.query.mapId,e=>{e&&q()});const Y=()=>new Promise((e,t)=>{const l=indexedDB.open(It,1);l.onupgradeneeded=a=>{const r=a.target.result;r.objectStoreNames.contains(Z)||r.createObjectStore(Z)},l.onsuccess=a=>e(a.target.result),l.onerror=a=>t(a)}),ae=async(e,t)=>{const l=await Y();return new Promise((a,r)=>{const V=l.transaction(Z,"readwrite").objectStore(Z).put(t,e);V.onsuccess=()=>a(),V.onerror=()=>r(V.error)})},s=async e=>{const t=await Y();return new Promise((l,a)=>{const D=t.transaction(Z,"readonly").objectStore(Z).get(e);D.onsuccess=()=>l(D.result),D.onerror=()=>a(D.error)})};return(e,t)=>{const l=Ze,a=De;return d(),v("div",pt,[t[12]||(t[12]=o("div",{class:"background-anim"},null,-1)),$.value==="upload"?(d(),v("div",mt,[g.value?(d(),v("div",yt,[o("div",ht,[t[4]||(t[4]=o("div",{class:"wave-loader"},"â—†",-1)),o("h2",null,T(b.value.step||"ë§µ ìƒì„± ì¤‘..."),1),o("div",gt,[o("div",{class:"fill",style:fe({width:b.value.percent+"%",animation:"none"})},null,4)]),G.value>0?(d(),v("p",_t,"ì˜ˆìƒ ë‚¨ì€ ì‹œê°„: ì•½ "+T(Math.ceil(G.value))+"ì´ˆ",1)):b.value.percent>0?(d(),v("p",wt,"ê±°ì˜ ë‹¤ ë˜ì—ˆìŠµë‹ˆë‹¤...")):R("",!0),B.value?(d(),v("div",bt,[o("span",kt,"CRITICAL BLOCKAGE AT "+T(B.value.x),1),o("canvas",{ref_key:"failCanvas",ref:I,width:"300",height:"150",class:"fail-preview"},null,512),t[3]||(t[3]=o("div",{class:"fail-details"}," AI failed to find a path through this section. ",-1))])):R("",!0)])])):R("",!0),t[10]||(t[10]=o("div",{class:"header-icon"},"â—†",-1)),t[11]||(t[11]=o("h1",{class:"title"},"ULTRA MUSIC MANIA",-1)),i.value?(d(),v("p",Dt,[t[5]||(t[5]=P(" ë¡œë“œëœ ë§µ: ",-1)),o("strong",null,T(i.value.title),1),t[6]||(t[6]=o("br",null,null,-1)),t[7]||(t[7]=P(" ê²Œì„ì„ ì‹œì‘í•˜ë ¤ë©´ ì´ ë§µì— ì‚¬ìš©ëœ ë…¸ë˜ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”. ",-1))])):(d(),v("p",St,"ìŒì•… íŒŒì¼ì„ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ ë§µì´ ìƒì„±ë©ë‹ˆë‹¤")),ue(l,{onSelect:O}),o("div",Ct,[o("div",xt,[t[8]||(t[8]=o("label",null,"ë‚œì´ë„ ì„¤ì •:",-1)),o("span",{class:"diff-value",style:fe({color:J(_.value)})},T(W.value)+" ("+T(_.value)+") ",5)]),o("div",At,[ve(o("input",{type:"range",min:"1",max:"30","onUpdate:modelValue":t[0]||(t[0]=r=>_.value=r),class:"diff-slider"},null,512),[[pe,_.value,void 0,{number:!0}]]),t[9]||(t[9]=o("div",{class:"slider-marks"},[o("span",null,"EASY"),o("span",null,"NORMAL"),o("span",null,"HARD"),o("span",null,"INSANE")],-1))])]),o("button",{class:"help-btn",onClick:t[1]||(t[1]=r=>y.value=!0)},"?")])):R("",!0),$.value==="play"?(d(),be(a,{key:1,audioBuffer:C.value,obstacles:h.value,sections:w.value,loadMap:i.value,difficulty:_.value,onRetry:f,onExit:u,onMapReady:Q,onRecordUpdate:F},null,8,["audioBuffer","obstacles","sections","loadMap","difficulty"])):R("",!0),ue(vt,{modelValue:y.value,"onUpdate:modelValue":t[2]||(t[2]=r=>y.value=r),onClose:e.handleGuideClose},null,8,["modelValue","onClose"])])}}}),Lt=de(Mt,[["__scopeId","data-v-ece9c540"]]);export{Lt as default};
