import{_ as oe}from"./Ckrqg4E4.js";import{e as le,f as ne,r,h as p,j as re,C as ue,c as l,a as e,k as y,F as f,l as g,p as H,v as G,t as n,n as _,y as ie,g as ce,o}from"./BrYDLEIV.js";import{s as V}from"./AEqb8BeY.js";import{_ as de}from"./DlAUqK2U.js";import"./DR3fCXgQ.js";const ve={class:"multi-container"},me={key:0,class:"setup-screen glass-panel lobby-panel"},pe={class:"lobby-actions"},ye={class:"room-list"},_e={key:0,class:"no-rooms"},he=["onClick"],fe={class:"room-info"},ge={class:"room-title"},be={class:"room-meta-row"},Ie={class:"room-host"},Re={class:"room-time"},Oe={class:"room-status-badge"},ke={key:1,class:"setup-screen glass-panel"},Te={class:"form-container"},Ce={class:"form-group"},Pe={class:"form-group"},Ee={class:"form-group"},xe={class:"duration-opts"},Me={class:"action-row"},we={key:2,class:"setup-screen glass-panel room-view"},Ae={class:"room-header-title"},Se={class:"room-header-meta"},Le={class:"player-grid"},Be={class:"player-name"},$e={key:0,class:"me-badge"},Ye={key:1,class:"host-badge"},Fe={key:0,class:"host-controls"},Ue=["disabled"],Ne={key:0,class:"hint-text"},He={key:1,class:"guest-controls"},Ge={key:3,class:"ingame-container"},Ve={key:0,class:"result-overlay"},je={class:"result-box glass-panel"},We={class:"victory-text"},De={class:"result-list"},Xe={class:"rank"},ze={class:"name"},Ke={class:"score"},qe={class:"match-hud"},Je={class:"leaderboard-hud"},Qe={class:"lb-rank"},Ze={class:"lb-name"},es={class:"lb-score"},ss=le({__name:"multiplayer",setup(ts){const j=ce(),{user:L}=ne(),u=r("LOBBY"),T=r([]),b=r("New Room"),I=r(4),v=r(60),i=r(null),d=r(null),c=p(()=>L.value?._id||sessionStorage.getItem("umm_player_id")||"guest_"+Math.random().toString(36).substr(2,9)),B=p(()=>i.value?.hostId===c.value),R=r(null),O=r(null),C=r([]),$=r([]),m=r(0),P=r(null),E=r(null),x=r(0),Y=r(360),M=r([]);re(()=>{!L.value?._id&&!sessionStorage.getItem("umm_player_id")&&sessionStorage.setItem("umm_player_id",c.value),w()}),ue(()=>{k()});function k(){P.value&&clearInterval(P.value),E.value&&clearInterval(E.value)}async function W(){playerClearCount.value++;try{await $fetch("/api/rooms/clear",{method:"POST",body:{roomId:d.value,userId:c.value}})}catch{}await D()}async function D(){currentMapIndex.value++;try{const t=await $fetch("/api/rooms/next-map",{method:"POST",body:{roomId:d.value,userId:c.value,mapIndex:currentMapIndex.value}});t.map&&(R.value=t.map,C.value=t.map.beatTimes||[],$.value=t.map.sections||[],bestPlayerProgress.value=0,playerProgress.value=0)}catch(t){console.error("Failed to load next map",t)}}async function w(){try{const t=await $fetch("/api/rooms/index");T.value=t.rooms}catch(t){console.error("Failed to fetch rooms",t)}}async function X(){if(b.value)try{const t=await $fetch("/api/rooms/create",{method:"POST",body:{title:b.value,maxPlayers:I.value,duration:v.value,userId:c.value}});t.success&&(d.value=t.roomId,u.value="ROOM",U())}catch{alert("Failed to create room")}}async function z(t){try{const s=await $fetch("/api/rooms/join",{method:"POST",body:{roomId:t,userId:c.value}});s.success&&(d.value=s.roomId,u.value="ROOM",U())}catch(s){alert("Cannot join room: "+(s.statusMessage||"Error"))}}async function F(){k(),d.value=null,i.value=null,u.value="LOBBY",w()}function U(){k(),E.value=V(async()=>{if(d.value)try{const t={userId:c.value};u.value==="PLAY"&&(t.progress=x.value,t.y=Y.value),u.value==="PLAY"&&await $fetch(`/api/rooms/${d.value}/update`,{method:"POST",body:t});const s=await $fetch(`/api/rooms/${d.value}/status`,{params:{userId:c.value}});i.value=s.room,M.value=s.room.players||[],u.value==="ROOM"&&s.room.status==="playing"&&q(s.room)}catch(t){console.error("Poll error",t)}},1e3)}async function K(){if(!(!B.value||!d.value))try{await $fetch(`/api/rooms/${d.value}/start`,{method:"POST",body:{userId:c.value}})}catch{alert("Failed to start")}}async function q(t){if(t.map){R.value=t.map,m.value=t.duration,O.value=null;try{const s=new(window.AudioContext||window.webkitAudioContext),S=s.sampleRate*m.value;O.value=s.createBuffer(1,S,s.sampleRate)}catch{}C.value=R.value.engineObstacles||[],u.value="PLAY",P.value=V(()=>{m.value--,m.value<=0&&Z()},1e3)}}function J(t){x.value=t.progress,Y.value=t.y}function Q(t){(t?.outcome==="complete"||x.value>=100)&&W(),t?.outcome}function Z(){k(),u.value="RESULT"}function ee(){j.push("/")}function se(t){return`${Math.floor(t/60)}:${(t%60).toString().padStart(2,"0")}`}const te=p(()=>[...M.value].sort((t,s)=>s.progress-t.progress).slice(0,3)),A=p(()=>[...M.value].sort((t,s)=>s.progress-t.progress)),N=p(()=>A.value.find(t=>t.userId!==c.value)),ae=p(()=>A.value[0]?.userId===c.value);return(t,s)=>{const S=oe;return o(),l("div",ve,[s[14]||(s[14]=e("div",{class:"background-anim"},null,-1)),u.value==="LOBBY"?(o(),l("div",me,[s[7]||(s[7]=e("h1",{class:"glow-text"},"MULTIPLAYER LOBBY",-1)),e("div",pe,[e("button",{onClick:s[0]||(s[0]=a=>u.value="CREATE"),class:"create-btn"},"CREATE ROOM"),e("button",{onClick:w,class:"refresh-btn"},"REFRESH")]),e("div",ye,[T.value.length===0?(o(),l("div",_e,"NO ROOMS AVAILABLE")):(o(!0),l(f,{key:1},g(T.value,a=>(o(),l("div",{key:a._id,class:"room-card",onClick:h=>z(a._id)},[e("div",fe,[e("h3",ge,n(a.title),1),e("div",be,[e("span",Ie,"HOST: "+n(a.host),1),e("span",Re,"TIME: "+n(a.duration)+"s",1)])]),e("div",Oe,n(a.currentPlayers)+" / "+n(a.maxPlayers),1)],8,he))),128))]),e("button",{onClick:ee,class:"back-btn-simple"},"BACK TO MENU")])):u.value==="CREATE"?(o(),l("div",ke,[s[10]||(s[10]=e("h1",{class:"glow-text"},"CREATE ROOM",-1)),e("div",Te,[e("div",Ce,[s[8]||(s[8]=e("label",null,"ROOM TITLE",-1)),H(e("input",{"onUpdate:modelValue":s[1]||(s[1]=a=>b.value=a),class:"input-field",placeholder:"Enter room name",maxlength:"20"},null,512),[[G,b.value]])]),e("div",Pe,[e("label",null,"MAX PLAYERS: "+n(I.value),1),H(e("input",{type:"range","onUpdate:modelValue":s[2]||(s[2]=a=>I.value=a),min:"2",max:"10",class:"range-slider"},null,512),[[G,I.value,void 0,{number:!0}]])]),e("div",Ee,[s[9]||(s[9]=e("label",null,"DURATION",-1)),e("div",xe,[e("button",{class:_({active:v.value===60}),onClick:s[3]||(s[3]=a=>v.value=60)},"1m",2),e("button",{class:_({active:v.value===180}),onClick:s[4]||(s[4]=a=>v.value=180)},"3m",2),e("button",{class:_({active:v.value===600}),onClick:s[5]||(s[5]=a=>v.value=600)},"10m",2)])])]),e("div",Me,[e("button",{onClick:X,class:"confirm-btn"},"CREATE"),e("button",{onClick:s[6]||(s[6]=a=>u.value="LOBBY"),class:"cancel-btn"},"CANCEL")])])):u.value==="ROOM"?(o(),l("div",we,[e("h2",Ae,n(i.value?.title),1),e("div",Se,[e("span",null,"TIME: "+n(i.value?.duration)+"s",1),e("span",null,"PLAYERS: "+n(i.value?.players.length)+" / "+n(i.value?.maxPlayers),1)]),e("div",Le,[(o(!0),l(f,null,g(i.value?.players,a=>(o(),l("div",{key:a.userId,class:_(["player-card-lg",{host:a.isHost}])},[s[11]||(s[11]=e("div",{class:"avatar-lg"},"â—†",-1)),e("div",Be,n(a.username),1),a.userId===c.value?(o(),l("span",$e,"YOU")):y("",!0),a.isHost?(o(),l("span",Ye,"HOST")):y("",!0)],2))),128)),(o(!0),l(f,null,g(i.value?i.value.maxPlayers-i.value.players.length:0,a=>(o(),l("div",{key:`placeholder-${a}`,class:"player-card-lg empty"},[...s[12]||(s[12]=[e("div",{class:"avatar-lg empty"},"+",-1),e("div",{class:"player-name"},"EMPTY",-1)])]))),128))]),B.value?(o(),l("div",Fe,[e("button",{onClick:K,class:"start-btn",disabled:!i.value||i.value.players.length<1},"START GAME",8,Ue),i.value&&i.value.players.length<2?(o(),l("p",Ne,"Waiting for players...")):y("",!0)])):(o(),l("div",He,[...s[13]||(s[13]=[e("div",{class:"loading-spinner"},null,-1),e("p",{class:"waiting-text"},"WAITING FOR HOST TO START...",-1)])])),e("button",{onClick:F,class:"leave-btn"},"LEAVE ROOM")])):u.value==="PLAY"||u.value==="RESULT"?(o(),l("div",Ge,[u.value==="RESULT"?(o(),l("div",Ve,[e("div",je,[e("h1",We,n(ae.value?"VICTORY":"FINISH"),1),e("div",De,[(o(!0),l(f,null,g(A.value,(a,h)=>(o(),l("div",{key:a.userId,class:_(["result-row",{winner:h===0,me:a.userId===c.value}])},[e("span",Xe,"#"+n(h+1),1),e("span",ze,n(a.username),1),e("span",Ke,n(a.progress.toFixed(1))+"% ("+n(a.clearCount||0)+" Wins)",1)],2))),128))]),e("button",{onClick:F,class:"action-btn"},"EXIT TO LOBBY")])])):y("",!0),e("div",qe,[e("div",{class:_(["timer-display",{critical:m.value<30}])},n(se(m.value)),3),e("div",Je,[(o(!0),l(f,null,g(te.value,(a,h)=>(o(),l("div",{key:a.userId,class:"lb-item"},[e("span",Qe,"#"+n(h+1),1),e("span",Ze,n(a.username),1),e("span",es,n(a.progress.toFixed(0))+"%",1)]))),128))])]),O.value?(o(),ie(S,{key:1,audioBuffer:O.value,obstacles:C.value,sections:$.value,loadMap:R.value,multiplayerMode:!0,opponentY:N.value?.y||360,opponentProgress:N.value?.progress||0,onExit:Q,onProgressUpdate:J},null,8,["audioBuffer","obstacles","sections","loadMap","opponentY","opponentProgress"])):y("",!0)])):y("",!0)])}}}),us=de(ss,[["__scopeId","data-v-8247a87a"]]);export{us as default};
