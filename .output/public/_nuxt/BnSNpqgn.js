import{e as nt,r as n,h as ie,j as He,C as Ye,i as rt,c as u,a as o,k as p,n as ut,m as ne,t as b,p as ct,v as dt,o as c}from"./Cgo8w6rr.js";import{G as vt,d as ft}from"./DGfNucPJ.js";import{_ as pt}from"./DlAUqK2U.js";const gt={class:"game-wrapper"},ht={class:"game-container"},yt={class:"hud"},mt={class:"hud-top-left"},wt={class:"game-actions"},Tt={class:"title-container"},Mt={key:0,class:"game-title"},bt={key:1,class:"game-title tutorial"},kt={class:"progress-bar-container"},St={class:"progress-text"},Pt={class:"score-container"},_t={class:"score-val"},xt={class:"speed-indicator"},Ct={key:0,class:"mini-badge"},At={key:1,class:"mini-badge"},Et={key:2,class:"autoplay-badge"},Ot={key:3,class:"autoplay-badge tutorial"},Rt={key:4,class:"autoplay-badge practice"},It={key:0,class:"status-overlay fail"},Bt={class:"status-content"},Lt={key:0,class:"new-best-text"},Nt={class:"status-sub"},Dt={class:"status-stats"},Gt={key:1,class:"status-overlay win"},Xt={class:"status-content"},Ut={class:"status-stats"},Ht={class:"video-save-section"},Yt=["disabled"],Vt={key:0},Wt={key:1},Ft={key:1,class:"save-success"},zt={key:0,class:"rating-vote pointer-events-auto"},Jt={class:"rating-controls"},$t={class:"rating-value"},Kt={key:1,class:"rating-done"},jt={key:2,class:"overlay countdown-overlay"},qt={class:"countdown-text"},Zt={key:3,class:"validation-status"},Qt={class:"mini-progress"},ea={key:4,class:"checkpoint-indicator"},ta={key:5,class:"controls-hint"},aa={key:0,class:"tutorial-message-bubble"},la={key:1},sa={key:0},Ve=.1,oa=nt({__name:"GameCanvas",props:{audioBuffer:{},obstacles:{},sections:{},autoRetry:{type:Boolean},loadMap:{},isViewOnly:{type:Boolean},multiplayerMode:{type:Boolean},difficulty:{},opponentY:{},opponentProgress:{},practiceMode:{type:Boolean},tutorialMode:{type:Boolean},invincible:{type:Boolean}},emits:["retry","exit","complete","map-ready","progress-update","record-update"],setup(M,{emit:We}){const s=M,C=We,S=n(null),t=n(new vt),h=n(!1),P=n(!1),_=n(0),R=n(0),N=n(""),E=n(0),D=n(null),Se=n(0),re=n(!1),ue=n(!1),I=n(s.difficulty||10),F=n(!1),ce=n(!1),B=n(0),de=n(!1),z=n(15),J=n(!1),$=n(!1),K=n(!1);let L=null,j=[];const Fe=async()=>{if(!(!s.loadMap?._id||J.value))try{await $fetch(`/api/maps/${s.loadMap._id}/rate`,{method:"POST",body:{rating:z.value}}),J.value=!0}catch{alert("Failed to submit rating.")}},ze=()=>{if(S.value)try{j=[],$.value=!1;const e=S.value.captureStream(30);if(r&&d)try{const i=r.createMediaStreamDestination();d.connect(i),i.stream.getAudioTracks().forEach(x=>e.addTrack(x))}catch{console.log("[Recording] Audio capture not available, video only")}const l={mimeType:"video/webm;codecs=vp9"};MediaRecorder.isTypeSupported(l.mimeType)||(l.mimeType="video/webm"),L=new MediaRecorder(e,l),L.ondataavailable=i=>{i.data&&i.data.size>0&&j.push(i.data)},L.start(100),console.log("[Recording] Started")}catch(e){console.error("[Recording] Failed to start:",e)}},Pe=()=>{L&&L.state!=="inactive"&&(L.stop(),console.log("[Recording] Stopped"))},Je=async()=>{if(j.length===0){alert("ÎÖπÌôîÎêú ÏòÅÏÉÅÏù¥ ÏóÜÏäµÎãàÎã§. Îã§Ïãú ÌîåÎ†àÏù¥Ìï¥Ï£ºÏÑ∏Ïöî.");return}K.value=!0;try{const e=new Blob(j,{type:"video/webm"}),l=s.loadMap?.title||"gameplay",i=new Date().toISOString().slice(0,19).replace(/[:-]/g,""),m=`UMM_${l}_${i}.webm`,x=URL.createObjectURL(e),A=document.createElement("a");A.href=x,A.download=m,document.body.appendChild(A),A.click(),document.body.removeChild(A),URL.revokeObjectURL(x),$.value=!0,console.log("[Recording] Saved:",m)}catch(e){console.error("[Recording] Save failed:",e),alert("ÏòÅÏÉÅ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.")}finally{K.value=!1}},ve=n(0),q=n(!1),fe=n(0),G=n(!1);let pe=null;const ge=n(360),he=n(0);let r=null,d=null;const T=n([]);let Z=null,Q=null,ee=!1;const te=n(null);let ye=null;const _e=ie(()=>{if(te.value)return te.value;if(!s.loadMap?.messages)return null;const e=R.value,l=s.loadMap.messages.filter(i=>i.progress<=e);return l.length===0?null:l[l.length-1].text}),X=(e,l=3e3)=>{te.value=e,ye&&clearTimeout(ye),ye=setTimeout(()=>{te.value=null},l)};let xe,ae=0;const k=n(!1),$e=ie(()=>{const e=t.value.speedMultiplier;return e<.6?"#aa5500":e<.8?"#ff8800":e<1.1?"#4488ff":e<1.5?"#44ff44":e<1.8?"#ff44ff":"#ff4444"}),Ke=ie(()=>{const e=t.value.speedMultiplier;return e<.6?"0.25x":e<.8?"0.5x":e<1.1?"1x":e<1.5?"2x":e<1.8?"3x":"4x"});ie(()=>I.value<8?"EASY":I.value<16?"NORMAL":I.value<24?"HARD":"IMPOSSIBLE");const je=async()=>{if(!r)return;const e=async l=>{try{const m=await(await fetch(l)).arrayBuffer();return await r.decodeAudioData(m)}catch(i){return console.error(`Failed to load sfx: ${l}`,i),null}};Z||(Z=await e("/audio/click_down.mp3")),Q||(Q=await e("/audio/click_up.mp3"))},le=(e,l=.5)=>{if(!(!r||!e))try{const i=r.createBufferSource(),m=r.createGain();i.buffer=e,m.gain.value=l,i.connect(m),m.connect(r.destination),i.start()}catch{}},me=()=>{if(!s.audioBuffer||!S.value)return;se(),r||(r=new(window.AudioContext||window.webkitAudioContext)),r.state==="suspended"&&r.resume(),je();const e=s.multiplayerMode?!1:t.value.isAutoplay;t.value.setMapConfig({density:1,portalFrequency:.15,difficulty:I.value}),t.value.reset(),t.value.isAutoplay=e,F.value=e,s.loadMap?(t.value.loadMapData(s.loadMap),I.value=s.loadMap.difficulty,G.value=!0,s.tutorialMode&&s.loadMap.autoplayLog&&s.loadMap.autoplayLog.length>0&&(t.value.isAutoplay=!0,F.value=!0,console.log("[Tutorial] Using saved autoplayLog, length:",s.loadMap.autoplayLog.length)),s.loadMap.bestScore?B.value=Math.min(100,s.loadMap.bestScore/10):B.value=0):(t.value.generateMap(s.obstacles,s.sections,s.audioBuffer.duration,void 0,!1),s.tutorialMode&&(t.value.isAutoplay=!0,F.value=!0),et()),h.value=!1,P.value=!1,N.value="",E.value=0,R.value=0,_.value=0,re.value=!1,ee=!1,C("progress-update",{progress:0,ghostProgress:0}),C("progress-update",{progress:0,ghostProgress:0}),T.value.length===0?(Y(),Ae()):(T.value=[],Y(),Ae()),Se.value++},qe=()=>{ce.value||(C("map-ready",{difficulty:I.value,engineObstacles:t.value.obstacles,enginePortals:t.value.portals,autoplayLog:t.value.autoplayLog,duration:s.audioBuffer.duration}),ce.value=!0)},Ze=()=>{qe()},Ce=()=>{if(!s.practiceMode||h.value)return;const e={x:t.value.playerX,y:t.value.playerY,velocity:t.value.velocity,isHolding:t.value.isHolding,cameraX:t.value.cameraX,isGravityInverted:t.value.isGravityInverted,speedMultiplier:t.value.speedMultiplier,isMini:t.value.isMini,waveAngle:t.value.waveAngle,score:t.value.score,progress:t.value.progress,startTimeOffset:(r?.currentTime||0)-t.value.startTime,obstacles:JSON.parse(JSON.stringify(t.value.obstacles)),portals:JSON.parse(JSON.stringify(t.value.portals)),timestamp:Date.now()};T.value.push(e);const l=S.value?.getContext("2d");l&&(l.save(),l.fillStyle="#00ff00",l.font="bold 30px Arial",l.fillText("CHECKPOINT SET!",S.value.width/2,100),l.restore()),console.log("Checkpoint set at",checkpoint.progress+"%")},Qe=()=>{if(T.value.length===0||!s.practiceMode)return;const e=T.value[T.value.length-1];if(t.value.playerX=e.x,t.value.playerY=e.y,t.value.velocity=e.velocity,t.value.isHolding=e.isHolding,t.value.cameraX=e.cameraX,t.value.isGravityInverted=e.isGravityInverted,t.value.speedMultiplier=e.speedMultiplier,t.value.isMini=e.isMini,t.value.waveAngle=e.waveAngle,t.value.score=e.score,t.value.progress=e.progress,t.value.obstacles=JSON.parse(JSON.stringify(e.obstacles)),t.value.portals=JSON.parse(JSON.stringify(e.portals)),h.value=!1,P.value=!1,N.value="",k.value=!0,t.value.isDead=!1,t.value.isPlaying=!0,d)try{d.stop()}catch{}if(r&&s.audioBuffer){d=r.createBufferSource(),d.buffer=s.audioBuffer,d.connect(r.destination);const l=e.startTimeOffset;t.value.startTime=r.currentTime-l,d.start(0,l),ae=r.currentTime}t.value.trail=[],we()},et=async()=>{if(!s.multiplayerMode){if(t.value.autoplayLog.length>0){G.value=!0;return}G.value=!1,q.value=!0,fe.value=0;for(let e=0;;e++)try{if(e>0&&(console.log(`[Validation] Retry ${e+1}: Regenerating map with updated offsets...`),t.value.generateMap(s.obstacles,s.sections,s.audioBuffer.duration,void 0,!1,e)),await t.value.computeAutoplayLogAsync(t.value.playerX,t.value.playerY,i=>{fe.value=i*100})){console.log(`[Validation] Path found on Attempt ${e+1}!`),G.value=!0;break}else if(e>100){console.error("[Validation] Safeguard triggered: Stopped after 100 failed retries.");break}}catch(l){console.error("Background validation error:",l);break}q.value=!1}},Ae=()=>{D.value="GO!",setTimeout(()=>{D.value=null,tt()},400)},tt=()=>{if(!r||!s.audioBuffer)return;d=r.createBufferSource(),d.buffer=s.audioBuffer,d.connect(r.destination),d.onended=()=>{!h.value&&k.value&&Oe()};const e=r.currentTime+.05;d.start(e),t.value.isPlaying=!0,t.value.startTime=e,k.value=!0,ae=r.currentTime,ze(),we()},se=()=>{if(k.value=!1,pe&&clearTimeout(pe),d){try{d.stop()}catch{}d.disconnect(),d=null}if(r){try{r.close()}catch{}r=null}cancelAnimationFrame(xe)},U=e=>{if(e){const l=e.target;if(l&&(l.tagName==="INPUT"||l.tagName==="BUTTON"||l.closest(".no-prevent-default")))return;e.preventDefault()}!k.value||t.value.isAutoplay||(t.value.isHolding||le(Z,1.5),t.value.setHolding(!0))},H=e=>{if(e){const l=e.target;if(l&&(l.tagName==="INPUT"||l.tagName==="BUTTON"||l.closest(".no-prevent-default")))return;e.preventDefault()}t.value.isAutoplay||(t.value.isHolding&&le(Q,1),t.value.setHolding(!1))},Ee=e=>{e.code==="KeyC"&&s.practiceMode?Ce():e.code==="KeyX"&&s.practiceMode&&T.value.length>0&&T.value.pop()};He(()=>{window.addEventListener("keydown",Ee),t.value.onPortalActivation=e=>{if(s.tutorialMode)switch(e){case"gravity_yellow":case"gravity_blue":X("GRAVITY SWITCHED! ‚Üï");break;case"speed_2":case"speed_3":case"speed_4":X("SPEED UP! ‚è©");break;case"speed_0.5":case"speed_0.25":X("SLOW DOWN! ‚è™");break;case"mini_pink":X("MINI MODE: TIGHT SPACES! ‚ú®");break;case"mini_green":X("NORMAL SIZE RESTORED");break}}}),Ye(()=>{window.removeEventListener("keydown",Ee),se()});const at=()=>{if(h.value=!0,N.value=t.value.failReason||"CRASHED",E.value=t.value.getProgress(),k.value=!1,E.value>B.value?(B.value=E.value,de.value=!0):de.value=!1,d)try{d.stop()}catch{}setTimeout(()=>{Pe(),C("record-update",{score:_.value,progress:R.value})},3e3);const e=()=>{h.value&&(Y(),requestAnimationFrame(e))};e(),pe=setTimeout(()=>{h.value&&(s.practiceMode&&T.value.length>0?Qe():me())},s.practiceMode?1e3:3e3)},Oe=()=>{if(P.value=!0,k.value=!1,_.value=Math.floor(_.value+1e3),E.value=100,d)try{d.stop()}catch{}setTimeout(()=>{Pe(),C("record-update",{score:_.value,progress:100})},3e3),C("complete",{score:_.value});const e=()=>{P.value&&(Y(),requestAnimationFrame(e))};e()},we=()=>{!k.value&&!h.value&&!P.value||(lt(),Y(),k.value&&(xe=requestAnimationFrame(we)))},lt=()=>{if(!r)return;const e=r.currentTime,l=e-t.value.startTime;let i=e-ae;if(ae=e,i>.1&&(i=.1),i<0&&(i=0),t.value.update(i,l),ve.value=l,t.value.isAutoplay&&s.tutorialMode&&(t.value.isHolding&&!ee?le(Z,1.5):!t.value.isHolding&&ee&&le(Q,1),ee=t.value.isHolding),_.value=t.value.score,R.value=t.value.progress,re.value=t.value.isGravityInverted,ue.value=t.value.isMini,t.value.isDead?s.invincible?(t.value.isDead=!1,t.value.isPlaying=!0):h.value||at():!t.value.isPlaying&&k.value&&!h.value&&!P.value&&Oe(),(s.multiplayerMode||s.tutorialMode)&&t.value.totalLength>0){const m=t.value.playerX/t.value.totalLength*100;C("progress-update",{progress:Math.min(100,m),y:t.value.playerY,ghostProgress:s.opponentProgress||0});const x=s.opponentY!==void 0?s.opponentY:360,A=s.opponentProgress||0;ge.value+=(x-ge.value)*Ve,he.value+=(A-he.value)*Ve}},Y=()=>{const e=S.value?.getContext("2d");if(!e||!S.value)return;const l=S.value.width,i=S.value.height,m=e.createLinearGradient(0,0,0,i);m.addColorStop(0,"#0a0a1a"),m.addColorStop(.5,"#151530"),m.addColorStop(1,"#0a0a1a"),e.fillStyle=m,e.fillRect(0,0,l,i),e.save(),e.strokeStyle="rgba(80, 80, 180, 0.08)",e.lineWidth=1;const x=40,A=-t.value.cameraX%x;for(let a=A;a<l;a+=x)e.beginPath(),e.moveTo(a,0),e.lineTo(a,i),e.stroke();for(let a=0;a<i;a+=x)e.beginPath(),e.moveTo(0,a),e.lineTo(l,a),e.stroke();e.restore(),e.save(),e.translate(-t.value.cameraX,0);const Te=t.value.isGravityInverted?"#ffff00":"#ff00ff",Me=t.value.isGravityInverted?"#ffff00":"#00ffff";if(e.fillStyle=Te,e.globalAlpha=.15,e.fillRect(t.value.cameraX,0,l,t.value.minY),e.globalAlpha=1,e.fillStyle=Me,e.globalAlpha=.15,e.fillRect(t.value.cameraX,t.value.maxY,l,i-t.value.maxY),e.globalAlpha=1,e.strokeStyle=Te,e.lineWidth=3,e.shadowBlur=15,e.shadowColor=Te,e.beginPath(),e.moveTo(t.value.cameraX,t.value.minY),e.lineTo(t.value.cameraX+l,t.value.minY),e.stroke(),e.strokeStyle=Me,e.shadowColor=Me,e.beginPath(),e.moveTo(t.value.cameraX,t.value.maxY),e.lineTo(t.value.cameraX+l,t.value.maxY),e.stroke(),e.shadowBlur=0,t.value.portals.forEach(a=>{if(a.x+a.width<t.value.cameraX-50||a.x>t.value.cameraX+l+50)return;e.save(),a.angle&&(e.translate(a.x+a.width/2,a.y+a.height/2),e.rotate(a.angle*Math.PI/180),e.translate(-(a.x+a.width/2),-(a.y+a.height/2)));const w=t.value.getPortalColor(a.type),v=t.value.getPortalSymbol(a.type),y=a.type==="mini_pink"||a.type==="mini_green";if(e.globalAlpha=a.activated?.3:1,e.fillStyle=w,e.shadowBlur=20,e.shadowColor=w,y){const g=a.x+a.width/2,f=a.y+a.height/2,ke=a.width/2,it=a.height/2,Ne=8;e.beginPath();for(let W=0;W<=Ne*2;W++){const De=Math.PI*2*W/(Ne*2)-Math.PI/2,Ge=W%2===0?1:.6,Xe=g+Math.cos(De)*ke*Ge,Ue=f+Math.sin(De)*it*Ge;W===0?e.moveTo(Xe,Ue):e.lineTo(Xe,Ue)}e.closePath(),e.fill()}else e.beginPath(),e.roundRect(a.x,a.y,a.width,a.height,12),e.fill(),e.fillStyle="rgba(255,255,255,0.4)",e.beginPath(),e.roundRect(a.x+6,a.y+6,a.width-12,a.height-12,8),e.fill();e.shadowBlur=0,e.fillStyle="#000",e.font="bold 18px Outfit",e.textAlign="center",e.textBaseline="middle",e.fillText(v,a.x+a.width/2,a.y+a.height/2),e.restore()}),t.value.obstacles.forEach(a=>{a.x+a.width<t.value.cameraX-50||a.x>t.value.cameraX+l+50||(e.save(),ft(e,a,a.x,a.y,ve.value),e.restore())}),t.value.isAutoplay&&t.value.aiPredictedPath.length>1){e.save(),e.beginPath(),e.moveTo(t.value.aiPredictedPath[0].x,t.value.aiPredictedPath[0].y);for(let a=1;a<t.value.aiPredictedPath.length;a++)e.lineTo(t.value.aiPredictedPath[a].x,t.value.aiPredictedPath[a].y);e.strokeStyle="rgba(0, 255, 255, 0.15)",e.lineWidth=12,e.lineCap="round",e.lineJoin="round",e.stroke(),e.strokeStyle="rgba(0, 255, 255, 0.6)",e.lineWidth=3,e.stroke(),e.restore()}if(t.value.trail.length>1){e.beginPath(),e.moveTo(t.value.trail[0].x,t.value.trail[0].y);for(let w=1;w<t.value.trail.length;w++){const v=t.value.trail[w];v&&e.lineTo(v.x,v.y)}const a=t.value.isGravityInverted?"rgba(255, 255, 0, 0.6)":"rgba(0, 255, 255, 0.6)";e.strokeStyle=a,e.lineWidth=14,e.lineCap="round",e.lineJoin="round",e.stroke(),e.shadowBlur=0}if(s.multiplayerMode){const w=he.value/100*t.value.totalLength,v=ge.value;e.save(),e.fillStyle="rgba(255, 0, 255, 0.8)",e.shadowBlur=20,e.shadowColor="#ff00ff";const y=35;e.translate(w,v),e.beginPath(),e.moveTo(y/2,0),e.lineTo(-y/3,-y/3),e.lineTo(-y/6,0),e.lineTo(-y/3,y/3),e.closePath(),e.fill(),e.fillStyle="white",e.font="bold 16px Outfit",e.textAlign="center",e.fillText("OPPONENT",0,-30),e.restore()}if(t.value.particles.forEach(a=>{e.fillStyle=a.color,e.globalAlpha=Math.max(0,a.life),e.beginPath(),e.arc(a.x,a.y,4,0,Math.PI*2),e.fill()}),e.globalAlpha=1,e.globalAlpha=1,t.value.boss.active){const a=t.value.boss;e.save(),e.translate(a.x,a.y),e.shadowBlur=40,e.shadowColor="#ff0000",e.fillStyle="#440000",e.beginPath();const w=60;for(let v=0;v<8;v++){const y=Math.PI*2*v/8;e.lineTo(Math.cos(y)*w,Math.sin(y)*w)}e.fill(),e.fillStyle="#ff0000",e.beginPath(),e.arc(0,0,20,0,Math.PI*2),e.fill(),e.restore(),a.projectiles.forEach(v=>{e.save(),e.translate(v.x,v.y),e.fillStyle="#ffff00",e.shadowBlur=10,e.shadowColor="#ffaa00",e.beginPath(),e.arc(0,0,15,0,Math.PI*2),e.fill(),e.restore()})}s.practiceMode&&T.value.forEach((a,w)=>{e.save();const v=15,y=w===T.value.length-1;e.translate(a.x,a.y),e.beginPath(),e.moveTo(0,-v),e.lineTo(v,0),e.lineTo(0,v),e.lineTo(-v,0),e.closePath(),y?(e.fillStyle="#00ff00",e.shadowBlur=15,e.shadowColor="#00ff00"):e.fillStyle="rgba(0, 255, 0, 0.4)",e.fill(),e.strokeStyle="#fff",e.lineWidth=2,e.stroke(),e.restore()});const Ie=t.value.playerX,Be=t.value.playerY,V=t.value.playerSize,Le=t.value.isHolding?-1:1,st=t.value.isGravityInverted?-Le:Le,ot=Math.atan2(st,1);e.save(),e.translate(Ie,Be),e.rotate(ot);const be=t.value.isGravityInverted?"#ffff00":t.value.isHolding?"#00ffff":"#ff00ff";e.shadowBlur=25,e.shadowColor=be;const O=V*1.2;e.beginPath(),e.moveTo(O,0),e.lineTo(-O*.5,-O*.6),e.lineTo(-O*.15,0),e.lineTo(-O*.5,O*.6),e.closePath();const oe=e.createLinearGradient(-O,0,O,0);oe.addColorStop(0,be),oe.addColorStop(.5,"#ffffff"),oe.addColorStop(1,be),e.fillStyle=oe,e.fill(),e.strokeStyle="#fff",e.lineWidth=1.5,e.stroke(),e.restore(),e.shadowBlur=0,t.value.showHitboxes&&(e.strokeStyle="#00ff00",e.lineWidth=2,e.strokeRect(Ie-V,Be-V,V*2,V*2),e.strokeStyle="#ff0000",t.value.obstacles.forEach(a=>{if(a.x+a.width<t.value.cameraX-50||a.x>t.value.cameraX+l+100)return;const w=t.value.getObstacleStateAt(a,ve.value),v=w.y,y=w.angle||0;e.save(),e.translate(a.x+a.width/2,v+a.height/2),y!==0&&e.rotate(y*Math.PI/180);const g=a.width/2,f=a.height/2;if(a.type==="slope")e.beginPath(),y>0?(e.moveTo(-g,f),e.lineTo(g,-f),e.lineTo(-g,-f)):(e.moveTo(g,f),e.lineTo(-g,-f),e.lineTo(g,-f)),e.closePath(),e.stroke();else if(a.type==="triangle"||a.type==="steep_triangle")e.beginPath(),e.moveTo(-g,f),e.lineTo(g,f),e.lineTo(g,-f),e.closePath(),e.stroke();else if(a.type==="spike"||a.type==="mini_spike"){const ke=a.y>360;e.beginPath(),ke?(e.moveTo(-g,f),e.lineTo(0,-f),e.lineTo(g,f)):(e.moveTo(-g,-f),e.lineTo(0,f),e.lineTo(g,-f)),e.closePath(),e.stroke()}else a.type==="saw"||a.type==="spike_ball"||a.type==="mine"||a.type==="orb"?(e.beginPath(),e.arc(0,0,g,0,Math.PI*2),e.stroke()):(a.type==="laser"||a.type,e.strokeRect(-g,-f,a.width,a.height));e.restore()})),e.restore(),(P.value||h.value)&&(e.save(),e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(0,0,l,i),e.restore()),t.value.isMeasureHighlight&&(e.save(),e.fillStyle="rgba(255, 255, 255, 0.15)",e.globalCompositeOperation="screen",e.fillRect(0,0,l,i),e.restore())},Re=()=>{if(document.hidden&&k.value){if(d)try{d.stop()}catch{}k.value=!1,h.value=!0,N.value="Ìè¨Ïª§Ïä§ Ïù¥ÌÉàÎ°ú Ï§ëÎã®Îê®"}};return He(()=>{window.addEventListener("keydown",e=>{e.repeat||(e.code==="Space"||e.code==="ArrowUp"||e.code==="KeyW")&&U(e)}),window.addEventListener("keyup",e=>{(e.code==="Space"||e.code==="ArrowUp"||e.code==="KeyW")&&H(e)}),window.addEventListener("mousedown",U),window.addEventListener("mouseup",H),window.addEventListener("touchstart",U,{passive:!1}),window.addEventListener("touchend",H,{passive:!1}),document.addEventListener("visibilitychange",Re),me()}),Ye(()=>{se(),window.removeEventListener("mousedown",U),window.removeEventListener("mouseup",H),window.removeEventListener("touchstart",U),window.removeEventListener("touchend",H),document.removeEventListener("visibilitychange",Re)}),rt(()=>s.audioBuffer,()=>{se(),me()}),(e,l)=>(c(),u("div",gt,[o("div",ht,[o("canvas",{ref_key:"canvas",ref:S,width:"1280",height:"720"},null,512),o("div",yt,[o("div",mt,[o("div",wt,[!M.multiplayerMode&&!M.loadMap&&G.value&&!ce.value?(c(),u("button",{key:0,onClick:Ze,class:"hud-action-btn save"}," SAVE MAP ")):p("",!0),o("button",{onClick:l[0]||(l[0]=i=>C("exit",{progress:E.value,score:_.value,outcome:h.value?"fail":"win"})),class:"hud-action-btn exit"},"ÎÇòÍ∞ÄÍ∏∞"),o("button",{onClick:l[1]||(l[1]=i=>C("change-mode")),class:"hud-action-btn mode-change"},"MODE"),M.practiceMode&&!h.value?(c(),u("button",{key:1,onClick:Ce,class:"hud-action-btn checkpoint"},"SET CP (C)")):p("",!0)]),o("div",Tt,[o("div",{class:ut(["wave-icon",{inverted:re.value}])},"‚ñ∂",2),M.tutorialMode?(c(),u("h1",bt,"TUTORIAL")):(c(),u("h1",Mt,"ULTRA MUSIC MANIA"))]),o("div",kt,[o("div",{class:"progress-bar",style:ne({width:R.value+"%"})},null,4),B.value>0?(c(),u("div",{key:0,class:"best-record-marker",style:ne({left:B.value+"%"})},[...l[3]||(l[3]=[o("div",{class:"marker-line"},null,-1),o("span",{class:"marker-text"},"BEST",-1)])],4)):p("",!0),o("span",St,b(Math.floor(R.value))+"%",1)])]),o("div",Pt,[l[4]||(l[4]=o("div",{class:"score-label"},"SCORE",-1)),o("div",_t,b(Math.floor(_.value)),1)]),o("div",xt,[o("span",{style:ne({color:$e.value})},b(Ke.value),5),ue.value?(c(),u("span",Ct,"MINI")):p("",!0),ue.value?(c(),u("span",At,"MINI")):p("",!0),F.value&&!M.tutorialMode?(c(),u("span",Et,"AUTO MODE")):p("",!0),M.tutorialMode?(c(),u("span",Ot,"TUTORIAL")):p("",!0),M.practiceMode?(c(),u("span",Rt,"PRACTICE")):p("",!0)]),h.value?(c(),u("div",It,[o("div",Bt,[l[6]||(l[6]=o("h1",{class:"status-text fail"},"CRASHED",-1)),de.value?(c(),u("p",Lt,"üéâ NEW BEST! "+b(E.value)+"%",1)):p("",!0),o("p",Nt,b(N.value),1),o("div",Dt,[o("span",null,b(E.value)+"% PROGRESS",1),l[5]||(l[5]=o("span",{class:"stat-divider"},"|",-1)),o("span",null,"ATTEMPT "+b(Se.value),1)])])])):p("",!0),P.value?(c(),u("div",Gt,[o("div",Xt,[l[9]||(l[9]=o("h1",{class:"status-text win"},"COMPLETE!",-1)),l[10]||(l[10]=o("p",{class:"status-sub"},"Î™®Îì† Ïû•Ïï†Î¨ºÏùÑ ÎèåÌååÌñàÏäµÎãàÎã§",-1)),o("div",Ut,[o("span",null,"SCORE "+b(Math.floor(_.value)),1)]),o("div",Ht,[$.value?p("",!0):(c(),u("button",{key:0,onClick:Je,class:"save-video-btn",disabled:K.value},[K.value?(c(),u("span",Vt,"üíæ Ï†ÄÏû• Ï§ë...")):(c(),u("span",Wt,"üé¨ ÏòÅÏÉÅ Ï†ÄÏû•"))],8,Yt)),$.value?(c(),u("p",Ft,"‚úÖ ÏòÅÏÉÅÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!")):p("",!0),l[7]||(l[7]=o("p",{class:"save-hint"},"ÌÅ¥Î¶¨Ïñ¥ Ïû•Î©¥ÏùÑ ÎèôÏòÅÏÉÅÏúºÎ°ú Ï†ÄÏû•Ìï©ÎãàÎã§",-1))]),M.loadMap&&M.loadMap._id&&!J.value?(c(),u("div",zt,[l[8]||(l[8]=o("p",{class:"rating-label"},"RATE THIS MAP (1-30)",-1)),o("div",Jt,[ct(o("input",{type:"range",min:"1",max:"30","onUpdate:modelValue":l[2]||(l[2]=i=>z.value=i),class:"rating-slider"},null,512),[[dt,z.value,void 0,{number:!0}]]),o("span",$t,b(z.value),1)]),o("button",{onClick:Fe,class:"submit-rating-btn"},"SUBMIT VOTE")])):J.value?(c(),u("div",Kt," THANK YOU FOR VOTING! ")):p("",!0)])])):p("",!0),D.value?(c(),u("div",jt,[o("div",qt,b(D.value),1)])):p("",!0),q.value&&!h.value&&!P.value?(c(),u("div",Zt,[l[11]||(l[11]=o("div",{class:"status-msg"},"OPTIMIZING MAP...",-1)),o("div",Qt,[o("div",{class:"fill",style:ne({width:fe.value+"%"})},null,4)])])):p("",!0),M.practiceMode&&T.value.length>0?(c(),u("div",ea," CPs: "+b(T.value.length)+" (Last: "+b(Math.floor(T.value[T.value.length-1].progress))+"%) ",1)):p("",!0),!D.value&&!h.value&&!P.value&&!q.value?(c(),u("div",ta,[M.tutorialMode&&_e.value?(c(),u("div",aa,b(_e.value),1)):(c(),u("div",la,[l[12]||(l[12]=o("span",null,"ÌÅ¥Î¶≠/Ïä§ÌéòÏù¥Ïä§ Ïú†ÏßÄ = ÏúÑÎ°ú | Ìï¥Ï†ú = ÏïÑÎûòÎ°ú",-1)),M.practiceMode?(c(),u("span",sa," | [C] Ï≤¥ÌÅ¨Ìè¨Ïù∏Ìä∏ | [X] ÏµúÍ∑º ÏÇ≠Ï†ú")):p("",!0)]))])):p("",!0)])])]))}}),ca=Object.assign(pt(oa,[["__scopeId","data-v-d47d29cf"]]),{__name:"GameCanvas"});export{ca as _};
