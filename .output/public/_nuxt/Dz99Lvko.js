import{_ as W}from"./DPyj6_7V.js";import{e as j,f as X,r as l,j as Z,D as q,h as J,c as m,a as e,k as w,B as Q,t as o,C as G,n as Y,m as g,y as ee,g as ae,o as v}from"./CeYHdBDP.js";import{_ as se}from"./DlAUqK2U.js";import"./DQ3TTau0.js";const R=globalThis.setInterval,te={class:"multi-container"},le={key:0,class:"setup-screen glass-panel"},ne={class:"mode-grid"},oe={key:1,class:"setup-screen glass-panel"},ie={class:"matchmaking-box"},ue={class:"category-badge"},re={class:"status-msg"},ve={key:2,class:"setup-screen glass-panel"},de={class:"ready-box"},ce={class:"vs-header"},pe={class:"player-info"},me={class:"player-info"},fe={key:0,class:"selected-map"},ye={class:"map-name"},ge={class:"map-meta"},Te={key:3,class:"setup-screen glass-panel"},_e={class:"result-box"},he={class:"duel-res"},Ee={class:"res-item"},Ce={class:"prog-bar"},be={class:"res-item"},Ae={class:"prog-bar"},Ie={key:0,class:"match-meta"},Me={key:4,class:"ingame-container"},we={class:"match-hud"},Se={class:"concurrent-progress"},ke={class:"p-bar"},Ne={class:"p-bar"},Re=j({__name:"multiplayer",setup(Oe){const $=ae(),{user:r,updateRating:H}=X(),i=l("MODESELECT"),T=l("Connecting to server..."),_=l(""),n=l(null),h=l(""),A=l(0),I=l(0),O=l(360),D=l(360),u=l(0),d=l(0),c=l({p1:0,p2:0}),E=l("draw"),M=l(null),P=l([]),x=l([]),p=l(180);let C=null;Z(()=>{}),q(()=>{clearInterval(C),clearInterval(b)});const S=l(null);let b=null;const k=J(()=>{if(r.value?._id)return r.value._id;let s=sessionStorage.getItem("umm_player_id");return s||(s="guest_"+Math.random().toString(36).substring(2,15),sessionStorage.setItem("umm_player_id",s)),s});async function N(s){h.value=s,i.value="MATCHMAKING",T.value="SCANNING FOR COMPETITORS...";try{const a=await $fetch("/api/matchmaking/find",{method:"POST",body:{category:s,rating:r.value?.rating||1e3,userId:k.value}});S.value=a.matchId,a.status==="ready"?L(a):b=R(async()=>{try{const t=await $fetch("/api/matchmaking/status",{method:"POST",body:{matchId:S.value,userId:k.value}});(t.status==="ready"||t.status==="playing")&&(clearInterval(b),L(t))}catch(t){console.error("Polling error",t)}},2e3)}catch(a){console.error("Matchmaking failed",a),T.value=`MATCHMAKING ERROR: ${a.statusMessage||a.message||"Server Error"}`,setTimeout(()=>i.value="MODESELECT",4e3);return}}async function L(s){if(n.value=s.map,_.value=s.opponent?.username||"GHOST",T.value="DOWNLOADING BATTLE TRACK...",n.value.audioData||n.value.audioUrl)try{let a=null;if(n.value.audioData?a=await(await fetch(n.value.audioData)).arrayBuffer():n.value.audioUrl&&(a=await(await fetch(n.value.audioUrl)).arrayBuffer()),a){const t=new(window.AudioContext||window.webkitAudioContext);M.value=await t.decodeAudioData(a)}}catch(a){console.warn("Could not auto-load audio, using silent buffer",a)}T.value="OPPONENT FOUND: SYNCHRONIZING...",await new Promise(a=>setTimeout(a,1e3)),i.value="READY"}async function B(){if(!n.value)return;h.value==="1m"?p.value=60:h.value==="3m"?p.value=180:h.value==="10m"&&(p.value=600),P.value=n.value.beatTimes||[],x.value=n.value.sections||[];const s=new(window.AudioContext||window.webkitAudioContext),a=Math.max(1,s.sampleRate*(n.value.duration||120));M.value=s.createBuffer(1,a,s.sampleRate),i.value="PLAY",A.value=0,I.value=0,u.value=0,d.value=0,clearInterval(C),C=R(()=>{p.value--,p.value<=0&&V()},1e3),clearInterval(b),b=R(async()=>{try{const t=await $fetch("/api/matchmaking/status",{method:"POST",body:{matchId:S.value,userId:k.value,progress:A.value,y:O.value}});t.opponent&&(I.value=t.opponent.progress,d.value=t.opponent.bestProgress||t.opponent.progress,D.value=t.opponent.y,d.value>=100&&f("opponent"))}catch{}},200)}function F(s){A.value=s.progress,s.progress>u.value&&(u.value=s.progress),O.value=s.y,u.value>=100?f("player"):d.value>=100&&f("opponent")}function K(s){s?.outcome==="fail"?f("opponent"):u.value>=100||u.value>=100&&f("player")}function V(){clearInterval(C);let s="draw";u.value>d.value?s="player":u.value<d.value&&(s="opponent"),f(s)}function f(s){if(clearInterval(C),E.value=s,c.value.p1=u.value,c.value.p2=d.value,r.value&&!r.value.isGuest&&(s==="player"||s==="opponent")){const a=r.value.rating||1e3,t=s==="player"?25:-15,y=Math.max(0,a+t);H(y,{opponent:_.value,winner:s==="player"?r.value.username:_.value,myScore:c.value.p1,opponentScore:c.value.p2,date:new Date,ratingChange:t})}i.value="RESULT"}function z(s){const a=Math.floor(s/60),t=s%60;return`${a}:${t<10?"0":""}${t}`}function U(){$.push("/")}return(s,a)=>{const t=W;return v(),m("div",te,[a[16]||(a[16]=e("div",{class:"background-anim"},null,-1)),i.value==="MODESELECT"?(v(),m("div",le,[a[8]||(a[8]=e("h1",{class:"glow-text"},"BATTLE CATEGORY",-1)),e("div",ne,[e("div",{class:"mode-card",onClick:a[0]||(a[0]=y=>N("1m"))},[...a[5]||(a[5]=[e("div",{class:"mode-icon"},"âš¡",-1),e("h3",null,"SPRINT",-1),e("p",null,"1 MINUTE MATCH",-1)])]),e("div",{class:"mode-card",onClick:a[1]||(a[1]=y=>N("3m"))},[...a[6]||(a[6]=[e("div",{class:"mode-icon"},"âš”ï¸",-1),e("h3",null,"STANDARD",-1),e("p",null,"3 MINUTE MATCH",-1)])]),e("div",{class:"mode-card",onClick:a[2]||(a[2]=y=>N("10m"))},[...a[7]||(a[7]=[e("div",{class:"mode-icon"},"ðŸŒŒ",-1),e("h3",null,"ENDURANCE",-1),e("p",null,"10 MINUTE MATCH",-1)])])]),e("button",{onClick:U,class:"back-btn-simple"},"BACK TO MENU")])):i.value==="MATCHMAKING"?(v(),m("div",oe,[e("div",ie,[a[9]||(a[9]=e("h1",{class:"glow-text"},"SEARCHING_OPPONENT",-1)),e("div",ue,o(h.value)+" CLASS",1),a[10]||(a[10]=Q('<div class="radar" data-v-6fda5ae6><div class="radar-line" data-v-6fda5ae6></div><div class="pings" data-v-6fda5ae6><div class="ping" style="top:20%;left:30%;" data-v-6fda5ae6></div><div class="ping" style="top:70%;left:80%;" data-v-6fda5ae6></div></div></div>',1)),e("p",re,o(T.value),1),e("button",{onClick:a[3]||(a[3]=y=>i.value="MODESELECT"),class:"cancel-btn"},"CANCEL")])])):i.value==="READY"?(v(),m("div",ve,[e("div",de,[e("div",ce,[e("div",pe,[a[11]||(a[11]=e("div",{class:"avatar"},"â—†",-1)),e("span",null,o(G(r)?.username||"GUEST"),1)]),a[13]||(a[13]=e("div",{class:"vs-badge"},"VS",-1)),e("div",me,[a[12]||(a[12]=e("div",{class:"avatar opponent"},"â—‡",-1)),e("span",null,o(_.value),1)])]),n.value?(v(),m("div",fe,[a[14]||(a[14]=e("h2",{class:"map-label"},"SELECTED_MAP",-1)),e("h1",ye,o(n.value.title),1),e("p",ge,"DIFF: "+o(n.value.difficulty)+" | BY: "+o(n.value.creatorName),1)])):w("",!0),e("button",{onClick:B,class:"battle-btn"},"BATTLE START")])])):i.value==="RESULT"?(v(),m("div",Te,[e("div",_e,[e("h1",{class:Y(["victory-text",{loss:E.value==="opponent",draw:E.value==="draw"}])},o(E.value==="player"?"VICTORY":E.value==="opponent"?"DEFEAT":"DRAW"),3),e("div",he,[e("div",Ee,[e("span",null,o(G(r)?.username||"YOU"),1),e("div",Ce,[e("div",{class:"fill",style:g({width:c.value.p1+"%"})},null,4)]),e("span",null,o(c.value.p1.toFixed(1))+"%",1)]),e("div",be,[e("span",null,o(_.value),1),e("div",Ae,[e("div",{class:"fill enemy",style:g({width:c.value.p2+"%"})},null,4)]),e("span",null,o(c.value.p2.toFixed(1))+"%",1)])]),p.value<=0?(v(),m("div",Ie,[...a[15]||(a[15]=[e("span",{class:"timeout-badge"},"TIME OUT RESULT",-1)])])):w("",!0),e("button",{onClick:a[4]||(a[4]=y=>i.value="MODESELECT"),class:"action-btn"},"REMATCH"),e("button",{onClick:U,class:"action-btn secondary"},"EXIT")])])):i.value==="PLAY"?(v(),m("div",Me,[e("div",we,[e("div",{class:Y(["timer-display",{critical:p.value<30}])},o(z(p.value)),3),e("div",Se,[e("div",ke,[e("div",{class:"fill",style:g({width:u.value+"%"})},null,4),e("div",{class:"current-marker",style:g({left:A.value+"%"})},null,4)]),e("div",Ne,[e("div",{class:"fill enemy",style:g({width:d.value+"%"})},null,4),e("div",{class:"current-marker enemy",style:g({left:I.value+"%"})},null,4)])])]),M.value?(v(),ee(t,{key:0,audioBuffer:M.value,obstacles:P.value,sections:x.value,loadMap:n.value,multiplayerMode:!0,opponentY:D.value,opponentProgress:I.value,onRetry:B,onExit:K,onProgressUpdate:F},null,8,["audioBuffer","obstacles","sections","loadMap","opponentY","opponentProgress"])):w("",!0)])):w("",!0)])}}}),Be=se(Re,[["__scopeId","data-v-6fda5ae6"]]);export{Be as default};
