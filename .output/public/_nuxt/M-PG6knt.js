import{_ as le}from"./CDLXmStr.js";import{e as ne,f as re,r,h as v,j as ue,C as ie,c as l,a as e,k as p,F as _,l as h,p as L,v as B,t as n,y as ce,n as Y,g as de,o}from"./OCD2nr9N.js";import{s as j}from"./C92kQu4n.js";import{_ as ve}from"./DlAUqK2U.js";import"./DP0Q2vyH.js";const me={class:"multi-container"},pe={key:0,class:"setup-screen glass-panel lobby-panel"},ye={class:"lobby-actions"},_e={class:"room-list"},he={key:0,class:"no-rooms"},fe=["onClick"],ge={class:"room-info"},be={class:"room-title"},Ie={class:"room-meta-row"},Re={class:"room-host"},Oe={class:"room-time"},Te={class:"room-status-badge"},ke={key:1,class:"setup-screen glass-panel"},Pe={class:"form-container"},Ee={class:"form-group"},xe={class:"form-group"},Ce={class:"form-group"},Me={class:"action-row"},we={key:2,class:"setup-screen glass-panel room-view"},Ae={class:"room-header-title"},Se={class:"room-header-meta"},Le={class:"player-grid"},Be={class:"player-name"},Ye={key:0,class:"me-badge"},$e={key:1,class:"host-badge"},Ue={key:0,class:"host-controls"},Fe=["disabled"],Ne={key:0,class:"hint-text"},Ge={key:1,class:"guest-controls"},He={key:3,class:"ingame-container"},Ve={key:0,class:"result-overlay"},je={class:"result-box glass-panel"},We={class:"victory-text"},De={class:"result-list"},Xe={class:"rank"},ze={class:"name"},Ke={class:"score"},qe={class:"match-hud"},Je={class:"leaderboard-hud"},Qe={class:"lb-rank"},Ze={class:"lb-name"},es={class:"lb-score"},ss=ne({__name:"multiplayer",setup(ts){const W=de(),{user:f}=re(),u=r("LOBBY"),T=r([]),g=r("New Room"),b=r(4),k=r(60),i=r(null),d=r(null),c=v(()=>f.value?._id||sessionStorage.getItem("umm_player_id")||"guest_"+Math.random().toString(36).substr(2,9)),$=v(()=>f.value?.displayName||f.value?.username||"Guest"),U=v(()=>i.value?.hostId===c.value),I=r(null),R=r(null),P=r([]),F=r([]),m=r(0),E=r(null),x=r(null),C=r(0),N=r(360),M=r([]);ue(()=>{!f.value?._id&&!sessionStorage.getItem("umm_player_id")&&sessionStorage.setItem("umm_player_id",c.value),w()}),ie(()=>{O()});function O(){E.value&&clearInterval(E.value),x.value&&clearInterval(x.value)}async function D(){playerClearCount.value++;try{await $fetch("/api/rooms/clear",{method:"POST",body:{roomId:d.value,userId:c.value}})}catch{}await X()}async function X(){currentMapIndex.value++;try{const t=await $fetch("/api/rooms/next-map",{method:"POST",body:{roomId:d.value,userId:c.value,mapIndex:currentMapIndex.value}});t.map&&(I.value=t.map,P.value=t.map.beatTimes||[],F.value=t.map.sections||[],bestPlayerProgress.value=0,playerProgress.value=0)}catch(t){console.error("Failed to load next map",t)}}async function w(){try{const t=await $fetch("/api/rooms/index");T.value=t.rooms}catch(t){console.error("Failed to fetch rooms",t)}}async function z(){if(g.value)try{const t=await $fetch("/api/rooms/create",{method:"POST",body:{title:g.value,maxPlayers:b.value,duration:k.value,userId:c.value,username:$.value}});t.success&&(d.value=t.roomId,u.value="ROOM",H())}catch{alert("Failed to create room")}}async function K(t){try{const s=await $fetch("/api/rooms/join",{method:"POST",body:{roomId:t,userId:c.value,username:$.value}});s.success&&(d.value=s.roomId,u.value="ROOM",H())}catch(s){alert("Cannot join room: "+(s.statusMessage||"Error"))}}async function G(){O(),d.value=null,i.value=null,u.value="LOBBY",w()}function H(){O(),x.value=j(async()=>{if(d.value)try{const t={userId:c.value};u.value==="PLAY"&&(t.progress=C.value,t.y=N.value),u.value==="PLAY"&&await $fetch(`/api/rooms/${d.value}/update`,{method:"POST",body:t});const s=await $fetch(`/api/rooms/${d.value}/status`,{params:{userId:c.value}});i.value=s.room,M.value=s.room.players||[],u.value==="ROOM"&&s.room.status==="playing"&&J(s.room)}catch(t){console.error("Poll error",t)}},1e3)}async function q(){if(!(!U.value||!d.value))try{await $fetch(`/api/rooms/${d.value}/start`,{method:"POST",body:{userId:c.value}})}catch{alert("Failed to start")}}async function J(t){if(t.map){I.value=t.map,m.value=t.duration,R.value=null;try{const s=new(window.AudioContext||window.webkitAudioContext),S=s.sampleRate*m.value;R.value=s.createBuffer(1,S,s.sampleRate)}catch{}P.value=I.value.engineObstacles||[],u.value="PLAY",E.value=j(()=>{m.value--,m.value<=0&&ee()},1e3)}}function Q(t){C.value=t.progress,N.value=t.y}function Z(t){(t?.outcome==="complete"||C.value>=100)&&D(),t?.outcome}function ee(){O(),u.value="RESULT"}function se(){W.push("/")}function te(t){return`${Math.floor(t/60)}:${(t%60).toString().padStart(2,"0")}`}const ae=v(()=>[...M.value].sort((t,s)=>s.progress-t.progress).slice(0,3)),A=v(()=>[...M.value].sort((t,s)=>s.progress-t.progress)),V=v(()=>A.value.find(t=>t.userId!==c.value)),oe=v(()=>A.value[0]?.userId===c.value);return(t,s)=>{const S=le;return o(),l("div",me,[s[13]||(s[13]=e("div",{class:"background-anim"},null,-1)),u.value==="LOBBY"?(o(),l("div",pe,[s[5]||(s[5]=e("h1",{class:"glow-text"},"MULTIPLAYER LOBBY",-1)),e("div",ye,[e("button",{onClick:s[0]||(s[0]=a=>u.value="CREATE"),class:"create-btn"},"CREATE ROOM"),e("button",{onClick:w,class:"refresh-btn"},"REFRESH")]),e("div",_e,[T.value.length===0?(o(),l("div",he,"NO ROOMS AVAILABLE")):(o(!0),l(_,{key:1},h(T.value,a=>(o(),l("div",{key:a._id,class:"room-card",onClick:y=>K(a._id)},[e("div",ge,[e("h3",be,n(a.title),1),e("div",Ie,[e("span",Re,"HOST: "+n(a.host),1),e("span",Oe,"TIME: "+n(a.duration)+"s",1)])]),e("div",Te,n(a.currentPlayers)+" / "+n(a.maxPlayers),1)],8,fe))),128))]),e("button",{onClick:se,class:"back-btn-simple"},"BACK TO MENU")])):u.value==="CREATE"?(o(),l("div",ke,[s[9]||(s[9]=e("h1",{class:"glow-text"},"CREATE ROOM",-1)),e("div",Pe,[e("div",Ee,[s[6]||(s[6]=e("label",null,"ROOM TITLE",-1)),L(e("input",{"onUpdate:modelValue":s[1]||(s[1]=a=>g.value=a),class:"input-field",placeholder:"Enter room name",maxlength:"20"},null,512),[[B,g.value]])]),e("div",xe,[e("label",null,"MAX PLAYERS: "+n(b.value),1),L(e("input",{type:"range","onUpdate:modelValue":s[2]||(s[2]=a=>b.value=a),min:"2",max:"10",class:"range-slider"},null,512),[[B,b.value,void 0,{number:!0}]])]),e("div",Ce,[s[7]||(s[7]=e("label",null,"DURATION (Seconds: 30 ~ 1800)",-1)),L(e("input",{type:"number","onUpdate:modelValue":s[3]||(s[3]=a=>k.value=a),class:"input-field",min:"30",max:"1800",step:"10"},null,512),[[B,k.value,void 0,{number:!0}]]),s[8]||(s[8]=e("div",{class:"duration-hint"},"30s (30sec) ~ 1800s (30min)",-1))])]),e("div",Me,[e("button",{onClick:z,class:"confirm-btn"},"CREATE"),e("button",{onClick:s[4]||(s[4]=a=>u.value="LOBBY"),class:"cancel-btn"},"CANCEL")])])):u.value==="ROOM"?(o(),l("div",we,[e("h2",Ae,n(i.value?.title),1),e("div",Se,[e("span",null,"TIME: "+n(i.value?.duration)+"s",1),e("span",null,"PLAYERS: "+n(i.value?.players.length)+" / "+n(i.value?.maxPlayers),1)]),e("div",Le,[(o(!0),l(_,null,h(i.value?.players,a=>(o(),l("div",{key:a.userId,class:Y(["player-card-lg",{host:a.isHost}])},[s[10]||(s[10]=e("div",{class:"avatar-lg"},"â—†",-1)),e("div",Be,n(a.username),1),a.userId===c.value?(o(),l("span",Ye,"YOU")):p("",!0),a.isHost?(o(),l("span",$e,"HOST")):p("",!0)],2))),128)),(o(!0),l(_,null,h(i.value?i.value.maxPlayers-i.value.players.length:0,a=>(o(),l("div",{key:`placeholder-${a}`,class:"player-card-lg empty"},[...s[11]||(s[11]=[e("div",{class:"avatar-lg empty"},"+",-1),e("div",{class:"player-name"},"EMPTY",-1)])]))),128))]),U.value?(o(),l("div",Ue,[e("button",{onClick:q,class:"start-btn",disabled:!i.value||i.value.players.length<1},"START GAME",8,Fe),i.value&&i.value.players.length<2?(o(),l("p",Ne,"Waiting for players...")):p("",!0)])):(o(),l("div",Ge,[...s[12]||(s[12]=[e("div",{class:"loading-spinner"},null,-1),e("p",{class:"waiting-text"},"WAITING FOR HOST TO START...",-1)])])),e("button",{onClick:G,class:"leave-btn"},"LEAVE ROOM")])):u.value==="PLAY"||u.value==="RESULT"?(o(),l("div",He,[u.value==="RESULT"?(o(),l("div",Ve,[e("div",je,[e("h1",We,n(oe.value?"VICTORY":"FINISH"),1),e("div",De,[(o(!0),l(_,null,h(A.value,(a,y)=>(o(),l("div",{key:a.userId,class:Y(["result-row",{winner:y===0,me:a.userId===c.value}])},[e("span",Xe,"#"+n(y+1),1),e("span",ze,n(a.username),1),e("span",Ke,n(a.progress.toFixed(1))+"% ("+n(a.clearCount||0)+" Wins)",1)],2))),128))]),e("button",{onClick:G,class:"action-btn"},"EXIT TO LOBBY")])])):p("",!0),e("div",qe,[e("div",{class:Y(["timer-display",{critical:m.value<30}])},n(te(m.value)),3),e("div",Je,[(o(!0),l(_,null,h(ae.value,(a,y)=>(o(),l("div",{key:a.userId,class:"lb-item"},[e("span",Qe,"#"+n(y+1),1),e("span",Ze,n(a.username),1),e("span",es,n(a.progress.toFixed(0))+"%",1)]))),128))])]),R.value?(o(),ce(S,{key:1,audioBuffer:R.value,obstacles:P.value,sections:F.value,loadMap:I.value,multiplayerMode:!0,opponentY:V.value?.y||360,opponentProgress:V.value?.progress||0,onExit:Z,onProgressUpdate:Q},null,8,["audioBuffer","obstacles","sections","loadMap","opponentY","opponentProgress"])):p("",!0)])):p("",!0)])}}}),us=ve(ss,[["__scopeId","data-v-56087d66"]]);export{us as default};
