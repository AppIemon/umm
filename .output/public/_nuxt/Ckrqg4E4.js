import{e as it,r as d,h as xe,j as De,C as Ye,i as ot,c as f,a as r,k as y,n as nt,m as ue,t as _,p as st,v as rt,o as h}from"./BrYDLEIV.js";import{G as ut}from"./DR3fCXgQ.js";import{_ as ct}from"./DlAUqK2U.js";const dt={class:"game-wrapper"},vt={class:"game-container"},ft={class:"hud"},ht={class:"hud-top-left"},pt={class:"game-actions"},yt={class:"title-container"},gt={key:0,class:"game-title"},mt={key:1,class:"game-title tutorial"},wt={class:"progress-bar-container"},Tt={class:"progress-text"},Mt={class:"score-container"},St={class:"score-val"},xt={class:"speed-indicator"},Pt={key:0,class:"mini-badge"},kt={key:1,class:"mini-badge"},Ct={key:2,class:"autoplay-badge"},_t={key:3,class:"autoplay-badge tutorial"},At={key:4,class:"autoplay-badge practice"},Rt={key:0,class:"status-overlay fail"},Bt={class:"status-content"},It={key:0,class:"new-best-text"},Ot={class:"status-sub"},Et={class:"status-stats"},Lt={key:1,class:"status-overlay win"},Nt={class:"status-content"},Gt={class:"status-stats"},Xt={class:"video-save-section"},Ut=["disabled"],Dt={key:0},Yt={key:1},Ht={key:1,class:"save-success"},Wt={key:0,class:"rating-vote pointer-events-auto"},Vt={class:"rating-controls"},Ft={class:"rating-value"},Jt={key:1,class:"rating-done"},zt={key:2,class:"overlay countdown-overlay"},$t={class:"countdown-text"},Kt={key:3,class:"validation-status"},jt={class:"mini-progress"},qt={key:4,class:"checkpoint-indicator"},Zt={key:5,class:"controls-hint"},Qt={key:0},He=.1,bt=it({__name:"GameCanvas",props:{audioBuffer:{},obstacles:{},sections:{},autoRetry:{type:Boolean},loadMap:{},isViewOnly:{type:Boolean},multiplayerMode:{type:Boolean},difficulty:{},opponentY:{},opponentProgress:{},practiceMode:{type:Boolean},tutorialMode:{type:Boolean},invincible:{type:Boolean}},emits:["retry","exit","complete","map-ready","progress-update","record-update"],setup(x,{emit:We}){const o=x,L=We,A=d(null),a=d(new ut),m=d(!1),R=d(!1),B=d(0),H=d(0),W=d(""),N=d(0),V=d(null),Pe=d(0),ce=d(!1),de=d(!1),X=d(o.difficulty||10),j=d(!1),ve=d(!1),U=d(0),fe=d(!1),q=d(15),Z=d(!1),Q=d(!1),b=d(!1);let D=null,ee=[];const Ve=async()=>{if(!(!o.loadMap?._id||Z.value))try{await $fetch(`/api/maps/${o.loadMap._id}/rate`,{method:"POST",body:{rating:q.value}}),Z.value=!0}catch{alert("Failed to submit rating.")}},Fe=()=>{if(A.value)try{ee=[],Q.value=!1;const e=A.value.captureStream(30);if(v&&p)try{const u=v.createMediaStreamDestination();p.connect(u),u.stream.getAudioTracks().forEach(I=>e.addTrack(I))}catch{console.log("[Recording] Audio capture not available, video only")}const l={mimeType:"video/webm;codecs=vp9"};MediaRecorder.isTypeSupported(l.mimeType)||(l.mimeType="video/webm"),D=new MediaRecorder(e,l),D.ondataavailable=u=>{u.data&&u.data.size>0&&ee.push(u.data)},D.start(100),console.log("[Recording] Started")}catch(e){console.error("[Recording] Failed to start:",e)}},ke=()=>{D&&D.state!=="inactive"&&(D.stop(),console.log("[Recording] Stopped"))},Je=async()=>{if(ee.length===0){alert("ÎÖπÌôîÎêú ÏòÅÏÉÅÏù¥ ÏóÜÏäµÎãàÎã§. Îã§Ïãú ÌîåÎ†àÏù¥Ìï¥Ï£ºÏÑ∏Ïöî.");return}b.value=!0;try{const e=new Blob(ee,{type:"video/webm"}),l=o.loadMap?.title||"gameplay",u=new Date().toISOString().slice(0,19).replace(/[:-]/g,""),T=`UMM_${l}_${u}.webm`,I=URL.createObjectURL(e),E=document.createElement("a");E.href=I,E.download=T,document.body.appendChild(E),E.click(),document.body.removeChild(E),URL.revokeObjectURL(I),Q.value=!0,console.log("[Recording] Saved:",T)}catch(e){console.error("[Recording] Save failed:",e),alert("ÏòÅÏÉÅ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.")}finally{b.value=!1}},O=d(0),te=d(!1),he=d(0),F=d(!1);let pe=null;const ye=d(360),ge=d(0);let v=null,p=null;const M=d([]);let ae=null,le=null,ie=!1,Ce,oe=0;const P=d(!1),ze=xe(()=>{const e=a.value.speedMultiplier;return e<.6?"#aa5500":e<.8?"#ff8800":e<1.1?"#4488ff":e<1.5?"#44ff44":e<1.8?"#ff44ff":"#ff4444"}),$e=xe(()=>{const e=a.value.speedMultiplier;return e<.6?"0.25x":e<.8?"0.5x":e<1.1?"1x":e<1.5?"2x":e<1.8?"3x":"4x"});xe(()=>X.value<8?"EASY":X.value<16?"NORMAL":X.value<24?"HARD":"IMPOSSIBLE");const Ke=async()=>{if(!v)return;const e=async l=>{try{const T=await(await fetch(l)).arrayBuffer();return await v.decodeAudioData(T)}catch(u){return console.error(`Failed to load sfx: ${l}`,u),null}};ae||(ae=await e("/audio/click_down.mp3")),le||(le=await e("/audio/click_up.mp3"))},ne=(e,l=.5)=>{if(!(!v||!e))try{const u=v.createBufferSource(),T=v.createGain();u.buffer=e,T.gain.value=l,u.connect(T),T.connect(v.destination),u.start()}catch{}},me=()=>{if(!o.audioBuffer||!A.value)return;se(),v||(v=new(window.AudioContext||window.webkitAudioContext)),v.state==="suspended"&&v.resume(),Ke();const e=o.multiplayerMode?!1:a.value.isAutoplay;a.value.setMapConfig({density:1,portalFrequency:.15,difficulty:X.value}),a.value.reset(),a.value.isAutoplay=e,j.value=e,o.loadMap?(a.value.loadMapData(o.loadMap),X.value=o.loadMap.difficulty,F.value=!0,o.tutorialMode&&o.loadMap.autoplayLog&&o.loadMap.autoplayLog.length>0&&(a.value.isAutoplay=!0,j.value=!0,console.log("[Tutorial] Using saved autoplayLog, length:",o.loadMap.autoplayLog.length)),o.loadMap.bestScore?U.value=Math.min(100,o.loadMap.bestScore/10):U.value=0):(a.value.generateMap(o.obstacles,o.sections,o.audioBuffer.duration,void 0,!1),o.tutorialMode&&(a.value.isAutoplay=!0,j.value=!0),Qe()),m.value=!1,R.value=!1,W.value="",N.value=0,H.value=0,B.value=0,ce.value=!1,ie=!1,L("progress-update",{progress:0,ghostProgress:0}),L("progress-update",{progress:0,ghostProgress:0}),M.value.length===0?($(),Ae()):(M.value=[],$(),Ae()),Pe.value++},je=()=>{ve.value||(L("map-ready",{difficulty:X.value,engineObstacles:a.value.obstacles,enginePortals:a.value.portals,autoplayLog:a.value.autoplayLog,duration:o.audioBuffer.duration}),ve.value=!0)},qe=()=>{je()},_e=()=>{if(!o.practiceMode||m.value)return;const e={x:a.value.playerX,y:a.value.playerY,velocity:a.value.velocity,isHolding:a.value.isHolding,cameraX:a.value.cameraX,isGravityInverted:a.value.isGravityInverted,speedMultiplier:a.value.speedMultiplier,isMini:a.value.isMini,waveAngle:a.value.waveAngle,score:a.value.score,progress:a.value.progress,startTimeOffset:(v?.currentTime||0)-a.value.startTime,obstacles:JSON.parse(JSON.stringify(a.value.obstacles)),portals:JSON.parse(JSON.stringify(a.value.portals)),timestamp:Date.now()};M.value.push(e);const l=A.value?.getContext("2d");l&&(l.save(),l.fillStyle="#00ff00",l.font="bold 30px Arial",l.fillText("CHECKPOINT SET!",A.value.width/2,100),l.restore()),console.log("Checkpoint set at",checkpoint.progress+"%")},Ze=()=>{if(M.value.length===0||!o.practiceMode)return;const e=M.value[M.value.length-1];if(a.value.playerX=e.x,a.value.playerY=e.y,a.value.velocity=e.velocity,a.value.isHolding=e.isHolding,a.value.cameraX=e.cameraX,a.value.isGravityInverted=e.isGravityInverted,a.value.speedMultiplier=e.speedMultiplier,a.value.isMini=e.isMini,a.value.waveAngle=e.waveAngle,a.value.score=e.score,a.value.progress=e.progress,a.value.obstacles=JSON.parse(JSON.stringify(e.obstacles)),a.value.portals=JSON.parse(JSON.stringify(e.portals)),m.value=!1,R.value=!1,W.value="",P.value=!0,a.value.isDead=!1,a.value.isPlaying=!0,p)try{p.stop()}catch{}if(v&&o.audioBuffer){p=v.createBufferSource(),p.buffer=o.audioBuffer,p.connect(v.destination);const l=e.startTimeOffset;a.value.startTime=v.currentTime-l,p.start(0,l),oe=v.currentTime}a.value.trail=[],we()},Qe=async()=>{if(!o.multiplayerMode){if(a.value.autoplayLog.length>0){F.value=!0;return}F.value=!1,te.value=!0,he.value=0;for(let e=0;;e++)try{if(e>0&&(console.log(`[Validation] Retry ${e+1}: Regenerating map with updated offsets...`),a.value.generateMap(o.obstacles,o.sections,o.audioBuffer.duration,void 0,!1,e)),await a.value.computeAutoplayLogAsync(a.value.playerX,a.value.playerY,u=>{he.value=u*100})){console.log(`[Validation] Path found on Attempt ${e+1}!`),F.value=!0;break}else if(e>100){console.error("[Validation] Safeguard triggered: Stopped after 100 failed retries.");break}}catch(l){console.error("Background validation error:",l);break}te.value=!1}},Ae=()=>{V.value="GO!",setTimeout(()=>{V.value=null,be()},400)},be=()=>{if(!v||!o.audioBuffer)return;p=v.createBufferSource(),p.buffer=o.audioBuffer,p.connect(v.destination),p.onended=()=>{!m.value&&P.value&&Be()};const e=v.currentTime+.05;p.start(e),a.value.isPlaying=!0,a.value.startTime=e,P.value=!0,oe=v.currentTime,Fe(),we()},se=()=>{if(P.value=!1,pe&&clearTimeout(pe),p){try{p.stop()}catch{}p.disconnect(),p=null}if(v){try{v.close()}catch{}v=null}cancelAnimationFrame(Ce)},J=e=>{if(e){const l=e.target;if(l&&(l.tagName==="INPUT"||l.tagName==="BUTTON"||l.closest(".no-prevent-default")))return;e.preventDefault()}!P.value||a.value.isAutoplay||(a.value.isHolding||ne(ae,1.5),a.value.setHolding(!0))},z=e=>{if(e){const l=e.target;if(l&&(l.tagName==="INPUT"||l.tagName==="BUTTON"||l.closest(".no-prevent-default")))return;e.preventDefault()}a.value.isAutoplay||(a.value.isHolding&&ne(le,1),a.value.setHolding(!1))},Re=e=>{e.code==="KeyC"&&o.practiceMode?_e():e.code==="KeyX"&&o.practiceMode&&M.value.length>0&&M.value.pop()};De(()=>{window.addEventListener("keydown",Re)}),Ye(()=>{window.removeEventListener("keydown",Re),se()});const et=()=>{if(m.value=!0,W.value=a.value.failReason||"CRASHED",N.value=a.value.getProgress(),P.value=!1,N.value>U.value?(U.value=N.value,fe.value=!0):fe.value=!1,p)try{p.stop()}catch{}setTimeout(()=>{ke(),L("record-update",{score:B.value,progress:H.value})},3e3);const e=()=>{m.value&&($(),requestAnimationFrame(e))};e(),pe=setTimeout(()=>{m.value&&(o.practiceMode&&M.value.length>0?Ze():me())},o.practiceMode?1e3:3e3)},Be=()=>{if(R.value=!0,P.value=!1,B.value=Math.floor(B.value+1e3),N.value=100,p)try{p.stop()}catch{}setTimeout(()=>{ke(),L("record-update",{score:B.value,progress:100})},3e3),L("complete",{score:B.value});const e=()=>{R.value&&($(),requestAnimationFrame(e))};e()},we=()=>{!P.value&&!m.value&&!R.value||(tt(),$(),P.value&&(Ce=requestAnimationFrame(we)))},tt=()=>{if(!v)return;const e=v.currentTime,l=e-a.value.startTime;let u=e-oe;if(oe=e,u>.1&&(u=.1),u<0&&(u=0),a.value.update(u,l),O.value=l,a.value.isAutoplay&&(a.value.isHolding&&!ie?ne(ae,1.5):!a.value.isHolding&&ie&&ne(le,1),ie=a.value.isHolding),B.value=a.value.score,H.value=a.value.progress,ce.value=a.value.isGravityInverted,de.value=a.value.isMini,a.value.isDead?o.invincible?(a.value.isDead=!1,a.value.isPlaying=!0):m.value||et():!a.value.isPlaying&&P.value&&!m.value&&!R.value&&Be(),(o.multiplayerMode||o.tutorialMode)&&a.value.totalLength>0){const T=a.value.playerX/a.value.totalLength*100;L("progress-update",{progress:Math.min(100,T),y:a.value.playerY,ghostProgress:o.opponentProgress||0});const I=o.opponentY!==void 0?o.opponentY:360,E=o.opponentProgress||0;ye.value+=(I-ye.value)*He,ge.value+=(E-ge.value)*He}},$=()=>{const e=A.value?.getContext("2d");if(!e||!A.value)return;const l=A.value.width,u=A.value.height,T=e.createLinearGradient(0,0,0,u);T.addColorStop(0,"#0a0a1a"),T.addColorStop(.5,"#151530"),T.addColorStop(1,"#0a0a1a"),e.fillStyle=T,e.fillRect(0,0,l,u),e.save(),e.strokeStyle="rgba(80, 80, 180, 0.08)",e.lineWidth=1;const I=40,E=-a.value.cameraX%I;for(let t=E;t<l;t+=I)e.beginPath(),e.moveTo(t,0),e.lineTo(t,u),e.stroke();for(let t=0;t<u;t+=I)e.beginPath(),e.moveTo(0,t),e.lineTo(l,t),e.stroke();e.restore(),e.save(),e.translate(-a.value.cameraX,0);const Te=a.value.isGravityInverted?"#ffff00":"#ff00ff",Me=a.value.isGravityInverted?"#ffff00":"#00ffff";if(e.fillStyle=Te,e.globalAlpha=.15,e.fillRect(a.value.cameraX,0,l,a.value.minY),e.globalAlpha=1,e.fillStyle=Me,e.globalAlpha=.15,e.fillRect(a.value.cameraX,a.value.maxY,l,u-a.value.maxY),e.globalAlpha=1,e.strokeStyle=Te,e.lineWidth=3,e.shadowBlur=15,e.shadowColor=Te,e.beginPath(),e.moveTo(a.value.cameraX,a.value.minY),e.lineTo(a.value.cameraX+l,a.value.minY),e.stroke(),e.strokeStyle=Me,e.shadowColor=Me,e.beginPath(),e.moveTo(a.value.cameraX,a.value.maxY),e.lineTo(a.value.cameraX+l,a.value.maxY),e.stroke(),e.shadowBlur=0,a.value.portals.forEach(t=>{if(t.x+t.width<a.value.cameraX-50||t.x>a.value.cameraX+l+50)return;e.save(),t.angle&&(e.translate(t.x+t.width/2,t.y+t.height/2),e.rotate(t.angle*Math.PI/180),e.translate(-(t.x+t.width/2),-(t.y+t.height/2)));const S=a.value.getPortalColor(t.type),i=a.value.getPortalSymbol(t.type),s=t.type==="mini_pink"||t.type==="mini_green";if(e.globalAlpha=t.activated?.3:1,e.fillStyle=S,e.shadowBlur=20,e.shadowColor=S,s){const n=t.x+t.width/2,c=t.y+t.height/2,g=t.width/2,k=t.height/2,C=8;e.beginPath();for(let w=0;w<=C*2;w++){const Y=Math.PI*2*w/(C*2)-Math.PI/2,Ge=w%2===0?1:.6,Xe=n+Math.cos(Y)*g*Ge,Ue=c+Math.sin(Y)*k*Ge;w===0?e.moveTo(Xe,Ue):e.lineTo(Xe,Ue)}e.closePath(),e.fill()}else e.beginPath(),e.roundRect(t.x,t.y,t.width,t.height,12),e.fill(),e.fillStyle="rgba(255,255,255,0.4)",e.beginPath(),e.roundRect(t.x+6,t.y+6,t.width-12,t.height-12,8),e.fill();e.shadowBlur=0,e.fillStyle="#000",e.font="bold 18px Outfit",e.textAlign="center",e.textBaseline="middle",e.fillText(i,t.x+t.width/2,t.y+t.height/2),e.restore()}),a.value.obstacles.forEach(t=>{if(t.x+t.width<a.value.cameraX-50||t.x>a.value.cameraX+l+50)return;if(e.save(),t.angle!==void 0&&t.angle!==0&&(e.translate(t.x+t.width/2,t.y+t.height/2),e.rotate(t.angle*Math.PI/180),e.translate(-(t.x+t.width/2),-(t.y+t.height/2))),t.type==="spike"||t.type==="mini_spike"){const i=t.type==="mini_spike";e.fillStyle=i?"#ff6666":"#ff4444",e.shadowBlur=i?8:12,e.shadowColor="#ff4444",e.beginPath(),t.y>300?(e.moveTo(t.x,t.y+t.height),e.lineTo(t.x+t.width/2,t.y),e.lineTo(t.x+t.width,t.y+t.height)):(e.moveTo(t.x,t.y),e.lineTo(t.x+t.width/2,t.y+t.height),e.lineTo(t.x+t.width,t.y)),e.closePath(),e.fill()}else if(t.type==="block")e.fillStyle="#444",e.shadowBlur=5,e.shadowColor="#666",e.fillRect(t.x,t.y,t.width,t.height),e.fillStyle="#555",e.fillRect(t.x+2,t.y+2,t.width-4,t.height-4);else if(t.type==="triangle"||t.type==="steep_triangle"){const i=t.type==="steep_triangle";e.fillStyle=i?"#222":"#333",e.shadowBlur=5,e.shadowColor="#555",e.beginPath(),e.moveTo(t.x,t.y+t.height),e.lineTo(t.x+t.width,t.y+t.height),e.lineTo(t.x+t.width,t.y),e.closePath(),e.fill(),e.fillStyle=i?"#444":"#555";const s=4;e.beginPath(),e.moveTo(t.x+s*2,t.y+t.height-s),e.lineTo(t.x+t.width-s,t.y+t.height-s),e.lineTo(t.x+t.width-s,t.y+s*2),e.fill()}else if(t.type==="saw"){const i=t.x+t.width/2,s=t.y+t.height/2,n=t.width/2;e.fillStyle="#ffaa00",e.shadowBlur=20,e.shadowColor="#ffaa00",e.beginPath(),e.arc(i,s,n,0,Math.PI*2),e.fill(),e.fillStyle="#ff6600";const c=10,g=O.value*8;for(let k=0;k<c;k++){const C=Math.PI*2*k/c+g,w=i+Math.cos(C)*n*.75,Y=s+Math.sin(C)*n*.75;e.beginPath(),e.arc(w,Y,n*.15,0,Math.PI*2),e.fill()}e.fillStyle="#cc8800",e.beginPath(),e.arc(i,s,n*.25,0,Math.PI*2),e.fill()}else if(t.type==="spike_ball"){const i=t.x+t.width/2,s=t.y+t.height/2,n=t.width/2;e.fillStyle="#666",e.shadowBlur=15,e.shadowColor="#444";const c=8,g=O.value*3;e.fillStyle="#444";for(let C=0;C<c;C++){const w=Math.PI*2*C/c+g;e.beginPath();const Y=i+Math.cos(w)*n*1.2,Ne=s+Math.sin(w)*n*1.2;e.moveTo(i+Math.cos(w-.2)*n*.8,s+Math.sin(w-.2)*n*.8),e.lineTo(Y,Ne),e.lineTo(i+Math.cos(w+.2)*n*.8,s+Math.sin(w+.2)*n*.8),e.fill()}const k=e.createRadialGradient(i-n*.3,s-n*.3,n*.1,i,s,n);k.addColorStop(0,"#888"),k.addColorStop(1,"#222"),e.fillStyle=k,e.beginPath(),e.arc(i,s,n*.8,0,Math.PI*2),e.fill()}else if(t.type==="laser"){const i=t.y+t.height/2,s=Math.sin(O.value*15)*5+10;e.strokeStyle="#ff3333",e.lineWidth=2,e.shadowBlur=Math.max(0,s),e.shadowColor="#ff0000",e.beginPath(),e.moveTo(t.x,i),e.lineTo(t.x+t.width,i),e.stroke(),e.strokeStyle="#ffffff",e.lineWidth=1,e.shadowBlur=0,e.beginPath(),e.moveTo(t.x,i),e.lineTo(t.x+t.width,i),e.stroke(),e.fillStyle="#777",e.fillRect(t.x,t.y,8,t.height),e.fillRect(t.x+t.width-8,t.y,8,t.height)}else if(t.type==="v_laser"){const i=t.x+t.width/2,s=Math.sin(O.value*15)*5+10;e.strokeStyle="#ff3333",e.lineWidth=2,e.shadowBlur=Math.max(0,s),e.shadowColor="#ff0000",e.beginPath(),e.moveTo(i,t.y),e.lineTo(i,t.y+t.height),e.stroke(),e.strokeStyle="#ffffff",e.lineWidth=1,e.shadowBlur=0,e.beginPath(),e.moveTo(i,t.y),e.lineTo(i,t.y+t.height),e.stroke(),e.fillStyle="#777",e.fillRect(t.x,t.y,t.width,8),e.fillRect(t.x,t.y+t.height-8,t.width,8)}else if(t.type==="slope")e.fillStyle="#222",e.beginPath(),t.angle>0?(e.moveTo(t.x,t.y+t.height),e.lineTo(t.x+t.width,t.y),e.lineTo(t.x,t.y)):(e.moveTo(t.x+t.width,t.y+t.height),e.lineTo(t.x,t.y),e.lineTo(t.x+t.width,t.y)),e.closePath(),e.fill(),e.strokeStyle="rgba(100,200,255,0.3)",e.lineWidth=3,e.stroke();else if(t.type==="mine"){const i=t.x+t.width/2,s=t.y+t.height/2,n=t.width/2,c=Math.sin(O.value*10)*.1+.9;e.fillStyle="#ff3333",e.shadowBlur=10,e.shadowColor="#ff0000",e.beginPath();for(let g=0;g<6;g++){const k=Math.PI/3*g+O.value*2,C=i+Math.cos(k)*n*c,w=s+Math.sin(k)*n*c;g===0?e.moveTo(C,w):e.lineTo(C,w)}e.closePath(),e.fill(),e.fillStyle="#550000",e.beginPath(),e.arc(i,s,n*.4,0,Math.PI*2),e.fill()}else if(t.type==="orb"){const i=t.x+t.width/2,s=t.y+t.height/2,n=t.width/2,c=Math.sin(O.value*5)*.1+1,g=e.createRadialGradient(i,s,n*.1,i,s,n*c);g.addColorStop(0,"#ffffff"),g.addColorStop(.4,"#aa44ff"),g.addColorStop(.8,"#4400cc"),g.addColorStop(1,"rgba(68, 0, 204, 0)"),e.fillStyle=g,e.globalCompositeOperation="lighter",e.beginPath(),e.arc(i,s,n*c,0,Math.PI*2),e.fill(),e.globalCompositeOperation="source-over"}e.restore()}),a.value.isAutoplay&&a.value.aiPredictedPath.length>1){e.save(),e.beginPath(),e.moveTo(a.value.aiPredictedPath[0].x,a.value.aiPredictedPath[0].y);for(let t=1;t<a.value.aiPredictedPath.length;t++)e.lineTo(a.value.aiPredictedPath[t].x,a.value.aiPredictedPath[t].y);e.strokeStyle="rgba(0, 255, 255, 0.15)",e.lineWidth=12,e.lineCap="round",e.lineJoin="round",e.stroke(),e.strokeStyle="rgba(0, 255, 255, 0.6)",e.lineWidth=3,e.stroke(),e.restore()}if(a.value.trail.length>1){e.beginPath(),e.moveTo(a.value.trail[0].x,a.value.trail[0].y);for(let S=1;S<a.value.trail.length;S++){const i=a.value.trail[S];i&&e.lineTo(i.x,i.y)}const t=a.value.isGravityInverted?"rgba(255, 255, 0, 0.6)":"rgba(0, 255, 255, 0.6)";e.strokeStyle=t,e.lineWidth=14,e.lineCap="round",e.lineJoin="round",e.stroke(),e.shadowBlur=0}if(o.multiplayerMode){const S=ge.value/100*a.value.totalLength,i=ye.value;e.save(),e.fillStyle="rgba(255, 0, 255, 0.8)",e.shadowBlur=20,e.shadowColor="#ff00ff";const s=35;e.translate(S,i),e.beginPath(),e.moveTo(s/2,0),e.lineTo(-s/3,-s/3),e.lineTo(-s/6,0),e.lineTo(-s/3,s/3),e.closePath(),e.fill(),e.fillStyle="white",e.font="bold 16px Outfit",e.textAlign="center",e.fillText("OPPONENT",0,-30),e.restore()}a.value.particles.forEach(t=>{e.fillStyle=t.color,e.globalAlpha=Math.max(0,t.life),e.beginPath(),e.arc(t.x,t.y,4,0,Math.PI*2),e.fill()}),e.globalAlpha=1,o.practiceMode&&M.value.forEach((t,S)=>{e.save();const i=15,s=S===M.value.length-1;e.translate(t.x,t.y),e.beginPath(),e.moveTo(0,-i),e.lineTo(i,0),e.lineTo(0,i),e.lineTo(-i,0),e.closePath(),s?(e.fillStyle="#00ff00",e.shadowBlur=15,e.shadowColor="#00ff00"):e.fillStyle="rgba(0, 255, 0, 0.4)",e.fill(),e.strokeStyle="#fff",e.lineWidth=2,e.stroke(),e.restore()});const Oe=a.value.playerX,Ee=a.value.playerY,K=a.value.playerSize,Le=a.value.isHolding?-1:1,at=a.value.isGravityInverted?-Le:Le,lt=Math.atan2(at,1);e.save(),e.translate(Oe,Ee),e.rotate(lt);const Se=a.value.isGravityInverted?"#ffff00":a.value.isHolding?"#00ffff":"#ff00ff";e.shadowBlur=25,e.shadowColor=Se;const G=K*1.2;e.beginPath(),e.moveTo(G,0),e.lineTo(-G*.5,-G*.6),e.lineTo(-G*.15,0),e.lineTo(-G*.5,G*.6),e.closePath();const re=e.createLinearGradient(-G,0,G,0);re.addColorStop(0,Se),re.addColorStop(.5,"#ffffff"),re.addColorStop(1,Se),e.fillStyle=re,e.fill(),e.strokeStyle="#fff",e.lineWidth=1.5,e.stroke(),e.restore(),e.shadowBlur=0,a.value.showHitboxes&&(e.strokeStyle="#00ff00",e.lineWidth=2,e.strokeRect(Oe-K,Ee-K,K*2,K*2),e.strokeStyle="#ff0000",a.value.obstacles.forEach(t=>{if(t.x+t.width<a.value.cameraX-50||t.x>a.value.cameraX+l+100)return;const S=a.value.getObstacleStateAt(t,O.value),i=S.y,s=S.angle||0;e.save(),e.translate(t.x+t.width/2,i+t.height/2),s!==0&&e.rotate(s*Math.PI/180);const n=t.width/2,c=t.height/2;if(t.type==="slope")e.beginPath(),s>0?(e.moveTo(-n,c),e.lineTo(n,-c),e.lineTo(-n,-c)):(e.moveTo(n,c),e.lineTo(-n,-c),e.lineTo(n,-c)),e.closePath(),e.stroke();else if(t.type==="triangle"||t.type==="steep_triangle")e.beginPath(),e.moveTo(-n,c),e.lineTo(n,c),e.lineTo(n,-c),e.closePath(),e.stroke();else if(t.type==="spike"||t.type==="mini_spike"){const g=t.y>360;e.beginPath(),g?(e.moveTo(-n,c),e.lineTo(0,-c),e.lineTo(n,c)):(e.moveTo(-n,-c),e.lineTo(0,c),e.lineTo(n,-c)),e.closePath(),e.stroke()}else t.type==="saw"||t.type==="spike_ball"||t.type==="mine"||t.type==="orb"?(e.beginPath(),e.arc(0,0,n,0,Math.PI*2),e.stroke()):(t.type==="laser"||t.type,e.strokeRect(-n,-c,t.width,t.height));e.restore()})),e.restore(),(R.value||m.value)&&(e.save(),e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(0,0,l,u),e.restore())},Ie=()=>{if(document.hidden&&P.value){if(p)try{p.stop()}catch{}P.value=!1,m.value=!0,W.value="Ìè¨Ïª§Ïä§ Ïù¥ÌÉàÎ°ú Ï§ëÎã®Îê®"}};return De(()=>{window.addEventListener("keydown",e=>{e.repeat||(e.code==="Space"||e.code==="ArrowUp"||e.code==="KeyW")&&J(e)}),window.addEventListener("keyup",e=>{(e.code==="Space"||e.code==="ArrowUp"||e.code==="KeyW")&&z(e)}),window.addEventListener("mousedown",J),window.addEventListener("mouseup",z),window.addEventListener("touchstart",J,{passive:!1}),window.addEventListener("touchend",z,{passive:!1}),document.addEventListener("visibilitychange",Ie),me()}),Ye(()=>{se(),window.removeEventListener("mousedown",J),window.removeEventListener("mouseup",z),window.removeEventListener("touchstart",J),window.removeEventListener("touchend",z),document.removeEventListener("visibilitychange",Ie)}),ot(()=>o.audioBuffer,()=>{se(),me()}),(e,l)=>(h(),f("div",dt,[r("div",vt,[r("canvas",{ref_key:"canvas",ref:A,width:"1280",height:"720"},null,512),r("div",ft,[r("div",ht,[r("div",pt,[!x.multiplayerMode&&!x.loadMap&&F.value&&!ve.value?(h(),f("button",{key:0,onClick:qe,class:"hud-action-btn save"}," SAVE MAP ")):y("",!0),r("button",{onClick:l[0]||(l[0]=u=>L("exit",{progress:N.value,score:B.value,outcome:m.value?"fail":"win"})),class:"hud-action-btn exit"},"ÎÇòÍ∞ÄÍ∏∞"),x.practiceMode&&!m.value?(h(),f("button",{key:1,onClick:_e,class:"hud-action-btn checkpoint"},"SET CP (C)")):y("",!0)]),r("div",yt,[r("div",{class:nt(["wave-icon",{inverted:ce.value}])},"‚ñ∂",2),x.tutorialMode?(h(),f("h1",mt,"TUTORIAL")):(h(),f("h1",gt,"ULTRA MUSIC MANIA"))]),r("div",wt,[r("div",{class:"progress-bar",style:ue({width:H.value+"%"})},null,4),U.value>0?(h(),f("div",{key:0,class:"best-record-marker",style:ue({left:U.value+"%"})},[...l[2]||(l[2]=[r("div",{class:"marker-line"},null,-1),r("span",{class:"marker-text"},"BEST",-1)])],4)):y("",!0),r("span",Tt,_(Math.floor(H.value))+"%",1)])]),r("div",Mt,[l[3]||(l[3]=r("div",{class:"score-label"},"SCORE",-1)),r("div",St,_(Math.floor(B.value)),1)]),r("div",xt,[r("span",{style:ue({color:ze.value})},_($e.value),5),de.value?(h(),f("span",Pt,"MINI")):y("",!0),de.value?(h(),f("span",kt,"MINI")):y("",!0),j.value&&!x.tutorialMode?(h(),f("span",Ct,"AUTO MODE")):y("",!0),x.tutorialMode?(h(),f("span",_t,"TUTORIAL")):y("",!0),x.practiceMode?(h(),f("span",At,"PRACTICE")):y("",!0)]),m.value?(h(),f("div",Rt,[r("div",Bt,[l[5]||(l[5]=r("h1",{class:"status-text fail"},"CRASHED",-1)),fe.value?(h(),f("p",It,"üéâ NEW BEST! "+_(N.value)+"%",1)):y("",!0),r("p",Ot,_(W.value),1),r("div",Et,[r("span",null,_(N.value)+"% PROGRESS",1),l[4]||(l[4]=r("span",{class:"stat-divider"},"|",-1)),r("span",null,"ATTEMPT "+_(Pe.value),1)])])])):y("",!0),R.value?(h(),f("div",Lt,[r("div",Nt,[l[8]||(l[8]=r("h1",{class:"status-text win"},"COMPLETE!",-1)),l[9]||(l[9]=r("p",{class:"status-sub"},"Î™®Îì† Ïû•Ïï†Î¨ºÏùÑ ÎèåÌååÌñàÏäµÎãàÎã§",-1)),r("div",Gt,[r("span",null,"SCORE "+_(Math.floor(B.value)),1)]),r("div",Xt,[Q.value?y("",!0):(h(),f("button",{key:0,onClick:Je,class:"save-video-btn",disabled:b.value},[b.value?(h(),f("span",Dt,"üíæ Ï†ÄÏû• Ï§ë...")):(h(),f("span",Yt,"üé¨ ÏòÅÏÉÅ Ï†ÄÏû•"))],8,Ut)),Q.value?(h(),f("p",Ht,"‚úÖ ÏòÅÏÉÅÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!")):y("",!0),l[6]||(l[6]=r("p",{class:"save-hint"},"ÌÅ¥Î¶¨Ïñ¥ Ïû•Î©¥ÏùÑ ÎèôÏòÅÏÉÅÏúºÎ°ú Ï†ÄÏû•Ìï©ÎãàÎã§",-1))]),x.loadMap&&x.loadMap._id&&!Z.value?(h(),f("div",Wt,[l[7]||(l[7]=r("p",{class:"rating-label"},"RATE THIS MAP (1-30)",-1)),r("div",Vt,[st(r("input",{type:"range",min:"1",max:"30","onUpdate:modelValue":l[1]||(l[1]=u=>q.value=u),class:"rating-slider"},null,512),[[rt,q.value,void 0,{number:!0}]]),r("span",Ft,_(q.value),1)]),r("button",{onClick:Ve,class:"submit-rating-btn"},"SUBMIT VOTE")])):Z.value?(h(),f("div",Jt," THANK YOU FOR VOTING! ")):y("",!0)])])):y("",!0),V.value?(h(),f("div",zt,[r("div",$t,_(V.value),1)])):y("",!0),te.value&&!m.value&&!R.value?(h(),f("div",Kt,[l[10]||(l[10]=r("div",{class:"status-msg"},"OPTIMIZING MAP...",-1)),r("div",jt,[r("div",{class:"fill",style:ue({width:he.value+"%"})},null,4)])])):y("",!0),x.practiceMode&&M.value.length>0?(h(),f("div",qt," CPs: "+_(M.value.length)+" (Last: "+_(Math.floor(M.value[M.value.length-1].progress))+"%) ",1)):y("",!0),!V.value&&!m.value&&!R.value&&!te.value?(h(),f("div",Zt,[l[11]||(l[11]=r("span",null,"ÌÅ¥Î¶≠/Ïä§ÌéòÏù¥Ïä§ Ïú†ÏßÄ = ÏúÑÎ°ú | Ìï¥Ï†ú = ÏïÑÎûòÎ°ú",-1)),x.practiceMode?(h(),f("span",Qt," | [C] Ï≤¥ÌÅ¨Ìè¨Ïù∏Ìä∏ | [X] ÏµúÍ∑º ÏÇ≠Ï†ú")):y("",!0)])):y("",!0)])])]))}}),la=Object.assign(ct(bt,[["__scopeId","data-v-898d13e5"]]),{__name:"GameCanvas"});export{la as _};
