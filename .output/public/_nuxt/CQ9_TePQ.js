import{e as Z,r as p,j as ee,i as K,c as S,o as b,a as n,k as U,n as H,t as R,s as W,p as te,v as ae,q as se,F as ne,l as le,f as ie,x as ue,h as re,y as ce,b as de,m as Q,d as X,z as fe,A as ve}from"./OScbCsOj.js";import{_ as oe}from"./DlAUqK2U.js";import{_ as pe}from"./B9gDmzY8.js";import{G as me}from"./C0FcKQV0.js";const he={class:"song-selector"},ye={class:"tabs"},ge={key:0,class:"tab-content"},we={key:0},be={key:1,class:"highlight"},_e={key:1,class:"tab-content"},Se={class:"youtube-input-container"},Ae=["disabled"],De=["disabled"],ke={key:0,class:"error-msg"},Me={key:1,class:"youtube-preview"},Ce={class:"highlight"},xe={key:2,class:"tab-content"},Ie={key:0,class:"storage-list"},Te=["onClick"],Re={class:"name"},Oe={class:"date"},Le={key:1,class:"empty-msg"},$e=["disabled"],Ee=Z({__name:"SongSelector",emits:["select"],setup(j,{emit:T}){const k=T,A=p("upload"),u=p(null),x=p(null),y=p(null),m=p([]),_=p(null);function L(){const f=localStorage.getItem("umm_recent_maps");if(f)try{m.value=JSON.parse(f).sort((i,v)=>v.timestamp-i.timestamp)}catch(i){console.error(i)}}ee(L),K(A,f=>{f==="storage"&&L()});function O(f){_.value=f,y.value=null}const d=p(""),M=p(!1),D=p("");async function C(){if(d.value){M.value=!0,D.value="",u.value=null,y.value=null;try{const f=await fetch("/api/youtube",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:d.value})});if(!f.ok){const I=await f.json();throw new Error(I.message||"Failed to download")}const i=f.headers.get("content-disposition");let v="youtube_audio.mp3";if(i){const I=i.match(/filename="?(.+)"?/);I&&I[1]&&(v=I[1])}const q=await f.blob(),N=new File([q],v,{type:q.type||"audio/mpeg"});E(N)}catch(f){console.error(f),D.value=f.message||"Failed to load YouTube video"}finally{M.value=!1}}}function F(){x.value?.click()}function $(f){const i=f.target;i.files?.[0]&&E(i.files[0])}function g(f){f.dataTransfer?.files?.[0]&&E(f.dataTransfer.files[0])}function E(f){u.value=f,y.value=f,_.value=null}async function G(){A.value==="storage"&&_.value?k("select",{type:"storage",data:_.value}):y.value&&k("select",y.value)}return(f,i)=>(b(),S("div",he,[n("div",ye,[n("button",{class:H({active:A.value==="upload"}),onClick:i[0]||(i[0]=v=>A.value="upload")},"UPLOAD",2),n("button",{class:H({active:A.value==="youtube"}),onClick:i[1]||(i[1]=v=>A.value="youtube")},"YOUTUBE",2),n("button",{class:H({active:A.value==="storage"}),onClick:i[2]||(i[2]=v=>A.value="storage")},"STORAGE",2)]),A.value==="upload"?(b(),S("div",ge,[n("div",{class:"drop-zone",onDragover:i[3]||(i[3]=W(()=>{},["prevent"])),onDrop:W(g,["prevent"]),onClick:F},[u.value?(b(),S("p",be,R(u.value.name),1)):(b(),S("p",we,"DROP FILE HERE"))],32),n("input",{type:"file",ref_key:"fileInput",ref:x,accept:"audio/*",style:{display:"none"},onChange:$},null,544)])):A.value==="youtube"?(b(),S("div",_e,[n("div",Se,[te(n("input",{"onUpdate:modelValue":i[4]||(i[4]=v=>d.value=v),type:"text",placeholder:"Paste YouTube URL here...",onKeyup:se(C,["enter"]),disabled:M.value},null,40,Ae),[[ae,d.value]]),n("button",{class:"fetch-btn",onClick:C,disabled:!d.value||M.value},R(M.value?"LOADING...":"LOAD"),9,De)]),D.value?(b(),S("p",ke,R(D.value),1)):U("",!0),u.value&&A.value==="youtube"?(b(),S("div",Me,[n("p",Ce,"Loaded: "+R(u.value.name),1)])):U("",!0)])):A.value==="storage"?(b(),S("div",xe,[m.value.length>0?(b(),S("div",Ie,[(b(!0),S(ne,null,le(m.value,v=>(b(),S("div",{key:v.id,class:H(["storage-item",{selected:_.value?.id===v.id}]),onClick:q=>O(v)},[n("span",Re,R(v.name),1),n("span",Oe,R(new Date(v.timestamp).toLocaleDateString()),1)],10,Te))),128))])):(b(),S("p",Le,"NO RECENT DATA FOUND"))])):U("",!0),n("button",{class:"confirm-btn",disabled:!y.value&&!_.value||M.value,onClick:G}," SELECT ",8,$e)]))}}),Fe=Object.assign(oe(Ee,[["__scopeId","data-v-4e296932"]]),{__name:"SongSelector"}),Be=()=>{const j=p(null);return{analyzeAudio:async(k,A,u)=>{u&&u({step:"오디오 헤더를 읽는 중...",percent:5}),j.value||(j.value=new(window.AudioContext||window.webkitAudioContext));const x=await k.arrayBuffer();u&&u({step:"오디오 데이터를 디코딩하는 중...",percent:15});const y=await j.value.decodeAudioData(x),m=y.getChannelData(0),_=y.sampleRate,L=Math.floor(_/150);u&&u({step:"최고 음량을 파악하고 있습니다...",percent:25});let O=0;for(let e=0;e<m.length;e+=L){const s=Math.abs(m[e]||0);s>O&&(O=s)}O<.01&&(O=.1);const d=.45-(A-1)/29*.35,M=O*d,D=.35-(A-1)/29*.3;u&&u({step:"비트 패턴을 분석 중입니다...",percent:35});const C=[];let F=0;const $=new Float32Array(m.length);for(let e=0;e<m.length;e++)$[e]=Math.abs(m[e]||0);const g=Math.floor(_*.03);let E=0;for(let e=0;e<Math.min(g,$.length);e++)E+=$[e];const G=m.length/L;let f=0;for(let e=0;e<m.length;e+=L){f++;const s=e/_;E/g>M&&s-F>D&&(C.push(s),F=s);const c=Math.min(e+L,m.length);for(let h=e;h<c;h++){E-=$[h];const w=h+g;w<$.length&&(E+=$[w])}if(u&&f%Math.floor(G/10)===0){const h=f/G*35;u({step:"비트 패턴을 분석 중입니다...",percent:Math.floor(35+h)})}}u&&u({step:"장애물을 최적 배치하고 있습니다...",percent:75});const i=[];for(let e=0;e<C.length;e++){const s=C[e];if(s!==void 0&&(i.push(s),e<C.length-1)){const r=C[e+1];if(r===void 0)continue;const c=r-s;c>D*2.5&&i.push(s+c/2),c>D*4&&(i.push(s+c/3),i.push(s+c*2/3))}}if(i.sort((e,s)=>e-s),i.length<30){const e=D*1.2;for(let s=0;s<y.duration;s+=e)i.some(c=>Math.abs(c-s)<D*.8)||i.push(s);i.sort((s,r)=>s-r)}u&&u({step:"BPM을 분석하는 중...",percent:80});let v=120;if(C.length>=4){const e=[];for(let s=1;s<Math.min(C.length,50);s++){const r=C[s]-C[s-1];r>.2&&r<2&&e.push(r)}if(e.length>0){e.sort((c,h)=>c-h);const r=60/e[Math.floor(e.length/2)];v=Math.round(r/5)*5,v=Math.max(60,Math.min(200,v))}}const N=60/v*4;console.log(`[AudioAnalyzer] Detected BPM: ${v}, Measure Length: ${N.toFixed(3)}s`),u&&u({step:"곡의 분위기 변화를 감지하는 중...",percent:85});const I=[],P=_,z=[];for(let e=0;e<m.length;e+=P){let s=0;const r=Math.min(m.length,e+P);for(let c=e;c<r;c++){const h=m[c]??0;s+=h*h}z.push(Math.sqrt(s/(r-e||1)))}const J=6;let B=0,t=z[0]||.001,a=0,o=0;for(let e=0;e<z.length;e++){const s=z[e]??0;a+=s,o++;const r=e-B,c=Math.abs(s-t)/t;if(r>=J&&(c>.4||r>=15)){const h=a/o;I.push({startTime:B,endTime:e,intensity:h}),B=e,a=0,o=0,t=h||.001}}if(B<z.length){const e=o>0?a/o:0;I.push({startTime:B,endTime:y.duration,intensity:e})}const l=Math.max(...I.map(e=>e.intensity),.001);return I.forEach(e=>{e.intensity=e.intensity/l}),u&&u({step:"맵 생성을 완료했습니다!",percent:100}),{buffer:y,obstacles:i,sections:I,duration:y.duration,bpm:v,measureLength:N}}}},Ne={class:"play-page"},Ue={key:0,class:"setup-container"},ze={key:0,class:"processing-overlay"},Ge={class:"loader-content"},qe={class:"progress-bar"},Ye={key:0,class:"time-left"},je={key:1},Pe={key:2,class:"failure-log"},Ve={class:"fail-tag"},Je={key:1,class:"desc"},He={key:2,class:"desc map-notice"},Ke={class:"difficulty-select"},We={class:"diff-header"},Qe={class:"slider-container"},Xe=Z({__name:"play",setup(j){const T=p("upload"),k=p(null),{analyzeAudio:A}=Be(),u=p(null),x=p([]),y=p([]),m=p(!1),_=p({step:"",percent:0}),L=p(0),O=p(0),d=p(null),M=p(null),D=p(null),{user:C}=ie(),F=fe(),$=ue(),g=p(10),E=re(()=>g.value<8?"EASY":g.value<16?"NORMAL":g.value<24?"HARD":"IMPOSSIBLE"),G=t=>{if(t<8)return"#00ff88";if(t<16)return"#ffff00";if(t<24)return"#ff8800"},f=async t=>{if("type"in t&&t.type==="storage"){const o=t.data;if(d.value=o.mapData,x.value=o.mapData.beatTimes,y.value=o.mapData.sections,g.value=o.mapData.difficulty,o.mapData.audioData){const l=new(window.AudioContext||window.webkitAudioContext),s=await(await fetch(o.mapData.audioData)).arrayBuffer();u.value=await l.decodeAudioData(s)}T.value="play";return}const a=t;k.value=a,m.value=!0,L.value=Date.now(),N.value=!1;try{const o=new(window.AudioContext||window.webkitAudioContext),l=await A(a,g.value,c=>{if(_.value=c,c.percent>5){const h=(Date.now()-L.value)/1e3,w=h/(c.percent/100);O.value=Math.max(0,w-h)}});u.value=l.buffer,x.value=l.obstacles,y.value=l.sections;const e=new me({difficulty:g.value,density:1,portalFrequency:.15}),s=Date.now()+Math.floor(Math.random()*1e6);let r=!1;for(let c=0;;c++){const h=c===0?"AI가 맵을 분석하고 있습니다...":`맵 보정 중... (${c+1}회차)`;if(_.value={step:h,percent:0},e.generateMap(l.obstacles,l.sections,l.duration,s+c,!1,c,l.bpm,l.measureLength),r=await e.computeAutoplayLogAsync(200,360,w=>{_.value.percent=Math.floor(w*100)}),r){_.value.step="맵 저장 중...",M.value=null;break}if(e.validationFailureInfo&&(M.value={x:Math.floor(e.validationFailureInfo.x),y:Math.floor(e.validationFailureInfo.y),rawObstacles:e.validationFailureInfo.nearObstacles},ve(()=>I())),c>100)break}if(r)d.value={title:a.name.substring(0,100),difficulty:g.value,seed:s,engineObstacles:e.obstacles,enginePortals:e.portals,autoplayLog:e.autoplayLog,duration:l.duration,beatTimes:l.obstacles,sections:l.sections,bpm:l.bpm,measureLength:l.measureLength,audioData:null},i(d.value),await P(d.value),_.value.step="준비 완료!";else throw new Error("지나갈 수 있는 맵을 생성하지 못했습니다. 다시 시도해 주세요.");setTimeout(()=>{m.value=!1,T.value="play"},500)}catch(o){console.error(o),m.value=!1,alert(o.message||"오디오 분석 또는 로드에 실패했습니다")}},i=async t=>{const a=JSON.parse(localStorage.getItem("umm_recent_maps")||"[]");let o=null;if(k.value&&k.value.size<50*1024*1024){const e=new FileReader;o=await new Promise(s=>{e.onload=()=>s(e.result),e.readAsDataURL(k.value)})}const l={id:Date.now(),name:t.title,timestamp:Date.now(),mapData:{...t,audioData:o}};a.unshift(l),localStorage.setItem("umm_recent_maps",JSON.stringify(a.slice(0,10)))},v=()=>{T.value="play"},q=()=>{sessionStorage.getItem("umm_is_test")?(sessionStorage.removeItem("umm_is_test"),$.push("/editor")):T.value="upload"},N=p(!1),I=()=>{if(!D.value||!M.value)return;const t=D.value.getContext("2d");if(!t)return;const{x:a,y:o,rawObstacles:l}=M.value,e=D.value.width,s=D.value.height;t.fillStyle="#050510",t.fillRect(0,0,e,s);const r=.5,c=a-e/2/r,h=360-s/2/r;t.strokeStyle="rgba(255,255,255,0.05)";for(let w=0;w<e;w+=20)t.beginPath(),t.moveTo(w,0),t.lineTo(w,s),t.stroke();l.forEach(w=>{t.save(),t.translate((w.x-c)*r,(w.y-h)*r),w.angle&&t.rotate(w.angle*Math.PI/180),t.fillStyle=w.type==="spike"?"#ff4444":"#555",t.strokeStyle="#ff00ff",t.lineWidth=1;const Y=w.width*r,V=w.height*r;w.type==="spike"?(t.beginPath(),w.y>300?(t.moveTo(0,V),t.lineTo(Y/2,0),t.lineTo(Y,V)):(t.moveTo(0,0),t.lineTo(Y/2,V),t.lineTo(Y,0)),t.fill(),t.stroke()):(t.fillRect(0,0,Y,V),t.strokeRect(0,0,Y,V)),t.restore()}),t.fillStyle="#fff",t.shadowBlur=10,t.shadowColor="#00ffff",t.beginPath(),t.arc((a-c)*r,(o-h)*r,5,0,Math.PI*2),t.fill()},P=async t=>{if(!N.value&&!(!k.value&&!d.value?.audioUrl))try{const a={title:(k.value?.name||d.value?.title||"Unknown Map").substring(0,100),difficulty:t.difficulty,seed:x.value.length*777+Math.floor(t.duration*100),beatTimes:x.value,sections:y.value,engineObstacles:t.engineObstacles,enginePortals:t.enginePortals,autoplayLog:t.autoplayLog,duration:t.duration,creatorName:C.value?.username||"Guest",isShared:!1};if(k.value)if(a.audioUrl=`/audio/${k.value.name}`,k.value.size<100*1024*1024){const l=new FileReader,e=new Promise(s=>{l.onload=()=>s(l.result),l.readAsDataURL(k.value)});a.audioData=await e}else console.warn("Audio file too large for server storage (>100MB). Skipping audio persistence.");else d.value?.audioUrl&&(a.audioUrl=d.value.audioUrl,d.value.audioData&&d.value.audioData.length<100*1024*1024&&(a.audioData=d.value.audioData));const o=await $fetch("/api/maps",{method:"POST",body:a});N.value=!0,console.log(`[Database] Map successfully saved. ID: ${o._id}`),a.audioData||console.log("Audio data was not saved (File too large).")}catch(a){console.error("Failed to save map auto-registration:",a)}},z=async t=>{if(d.value?._id){t.score>(d.value.bestScore||0)&&(d.value.bestScore=t.score);try{(await $fetch(`/api/maps/${d.value._id}/record`,{method:"POST",body:{score:t.score,username:C.value?.username||"Guest"}})).updated&&console.log(`[Record] New best record: ${t.score}`)}catch(a){console.error("Failed to update record:",a)}}},J=async t=>{d.value=t,x.value=t.beatTimes,y.value=t.sections,g.value=t.difficulty;const a=new(window.AudioContext||window.webkitAudioContext),o=a.createBuffer(1,Math.max(1,a.sampleRate*(t.duration||10)),a.sampleRate);u.value=o,T.value="play"},B=async()=>{const t=sessionStorage.getItem("umm_load_map");if(t)try{const o=JSON.parse(t);if(sessionStorage.removeItem("umm_load_map"),d.value=o,x.value=o.beatTimes,y.value=o.sections,g.value=o.difficulty,o.audioData){const l=new(window.AudioContext||window.webkitAudioContext),s=await(await fetch(o.audioData)).arrayBuffer();u.value=await l.decodeAudioData(s),T.value="play";return}else if(o.audioUrl)console.log("Map session data found but missing audioData. Waiting for user file.");else{await J(o);return}}catch(o){console.error("Failed to parse session map:",o)}const a=F.query.map||F.query.mapId;if(a)try{m.value=!0;const o=await $fetch(`/api/maps/${a}`);if(o)if(d.value=o,x.value=o.beatTimes,y.value=o.sections,g.value=o.difficulty,o.audioData||o.audioUrl)try{let l;if(o.audioData){l=await(await fetch(o.audioData)).arrayBuffer();const s=new(window.AudioContext||window.webkitAudioContext);u.value=await s.decodeAudioData(l),T.value="play"}else console.log("Map loaded without audio. Waiting for user file.")}catch(l){console.warn("Auto-load failed, waiting for user file",l)}else await J(o)}catch(o){console.error("Failed to load map:",o)}finally{m.value=!1}};return ee(B),K(()=>F.query.map,t=>{t&&B()}),K(()=>F.query.mapId,t=>{t&&B()}),(t,a)=>{const o=Fe,l=pe;return b(),S("div",Ne,[a[10]||(a[10]=n("div",{class:"background-anim"},null,-1)),T.value==="upload"?(b(),S("div",Ue,[m.value?(b(),S("div",ze,[n("div",Ge,[a[2]||(a[2]=n("div",{class:"wave-loader"},"◆",-1)),n("h2",null,R(_.value.step||"맵 생성 중..."),1),n("div",qe,[n("div",{class:"fill",style:Q({width:_.value.percent+"%",animation:"none"})},null,4)]),O.value>0?(b(),S("p",Ye,"예상 남은 시간: 약 "+R(Math.ceil(O.value))+"초",1)):_.value.percent>0?(b(),S("p",je,"거의 다 되었습니다...")):U("",!0),M.value?(b(),S("div",Pe,[n("span",Ve,"CRITICAL BLOCKAGE AT "+R(M.value.x),1),n("canvas",{ref_key:"failCanvas",ref:D,width:"300",height:"150",class:"fail-preview"},null,512),a[1]||(a[1]=n("div",{class:"fail-details"}," AI failed to find a path through this section. ",-1))])):U("",!0)])])):U("",!0),a[8]||(a[8]=n("div",{class:"header-icon"},"◆",-1)),a[9]||(a[9]=n("h1",{class:"title"},"ULTRA MUSIC MANIA",-1)),d.value?(b(),S("p",He,[a[3]||(a[3]=X(" 로드된 맵: ",-1)),n("strong",null,R(d.value.title),1),a[4]||(a[4]=n("br",null,null,-1)),a[5]||(a[5]=X(" 게임을 시작하려면 이 맵에 사용된 노래 파일을 선택해주세요. ",-1))])):(b(),S("p",Je,"음악 파일을 선택하면 자동으로 맵이 생성됩니다")),de(o,{onSelect:f}),n("div",Ke,[n("div",We,[a[6]||(a[6]=n("label",null,"난이도 설정:",-1)),n("span",{class:"diff-value",style:Q({color:G(g.value)})},R(E.value)+" ("+R(g.value)+") ",5)]),n("div",Qe,[te(n("input",{type:"range",min:"1",max:"30","onUpdate:modelValue":a[0]||(a[0]=e=>g.value=e),class:"diff-slider"},null,512),[[ae,g.value,void 0,{number:!0}]]),a[7]||(a[7]=n("div",{class:"slider-marks"},[n("span",null,"EASY"),n("span",null,"NORMAL"),n("span",null,"HARD"),n("span",null,"INSANE")],-1))])])])):U("",!0),T.value==="play"?(b(),ce(l,{key:1,audioBuffer:u.value,obstacles:x.value,sections:y.value,loadMap:d.value,difficulty:g.value,onRetry:v,onExit:q,onMapReady:P,onRecordUpdate:z},null,8,["audioBuffer","obstacles","sections","loadMap","difficulty"])):U("",!0)])}}}),st=oe(Xe,[["__scopeId","data-v-905900a4"]]);export{st as default};
