import{e as mt,r as n,h as me,j as Je,C as Ke,i as wt,c as u,a as i,k as g,n as Mt,m as we,t as S,p as Tt,v as bt,o as c}from"./DcswZMe2.js";import{G as kt,d as Pt}from"./B98MRPuF.js";import{_ as St}from"./DlAUqK2U.js";const xt={class:"game-wrapper"},_t={class:"game-container"},Ct={class:"hud"},At={class:"hud-top-left"},It={class:"game-actions"},Et={class:"title-container"},Rt={key:0,class:"game-title"},Ot={key:1,class:"game-title tutorial"},Bt={class:"progress-bar-container"},Lt={class:"progress-text"},Dt={class:"score-container"},Nt={class:"score-val"},Gt={class:"speed-indicator"},Xt={key:0,class:"mini-badge"},Ut={key:1,class:"mini-badge"},Ht={key:2,class:"autoplay-badge"},Yt={key:3,class:"autoplay-badge tutorial"},Vt={key:4,class:"autoplay-badge practice"},Ft={key:0,class:"status-overlay fail"},Wt={class:"status-content"},zt={key:0,class:"new-best-text"},$t={class:"status-sub"},Jt={class:"status-stats"},Kt={key:1,class:"status-overlay win"},jt={class:"status-content"},qt={class:"status-stats"},Zt={class:"video-save-section"},Qt=["disabled"],ea={key:0},ta={key:1},aa={key:1,class:"save-success"},la={key:0,class:"rating-vote pointer-events-auto"},sa={class:"rating-controls"},oa={class:"rating-value"},ia={key:1,class:"rating-done"},na={key:2,class:"overlay countdown-overlay"},ra={class:"countdown-text"},ua={key:3,class:"validation-status"},ca={class:"mini-progress"},da={key:4,class:"checkpoint-indicator"},va={key:5,class:"controls-hint"},fa={key:0,class:"tutorial-message-bubble"},pa={key:1},ha={key:0},je=.1,ga=mt({__name:"GameCanvas",props:{audioBuffer:{},obstacles:{},sections:{},autoRetry:{type:Boolean},loadMap:{},isViewOnly:{type:Boolean},multiplayerMode:{type:Boolean},difficulty:{},opponentY:{},opponentProgress:{},practiceMode:{type:Boolean},tutorialMode:{type:Boolean},invincible:{type:Boolean}},emits:["retry","exit","complete","map-ready","progress-update","record-update"],setup(k,{emit:qe}){const s=k,I=qe,_=n(null),t=n(new kt),y=n(!1),C=n(!1),A=n(0),U=n(0),W=n(""),O=n(0),z=n(null),Oe=n(0),Me=n(!1),Te=n(!1),H=n(s.difficulty||10),ee=n(!1),be=n(!1),Y=n(0),ke=n(!1),te=n(15),ae=n(!1),le=n(!1),se=n(!1);let V=null,oe=[];const Ze=async()=>{if(!(!s.loadMap?._id||ae.value))try{await $fetch(`/api/maps/${s.loadMap._id}/rate`,{method:"POST",body:{rating:te.value}}),ae.value=!0}catch{alert("Failed to submit rating.")}},Qe=()=>{if(_.value)try{oe=[],le.value=!1;const e=_.value.captureStream(30);if(r&&d)try{const o=r.createMediaStreamDestination();d.connect(o),o.stream.getAudioTracks().forEach(m=>e.addTrack(m))}catch{console.log("[Recording] Audio capture not available, video only")}const l={mimeType:"video/webm;codecs=vp9"};MediaRecorder.isTypeSupported(l.mimeType)||(l.mimeType="video/webm"),V=new MediaRecorder(e,l),V.ondataavailable=o=>{o.data&&o.data.size>0&&oe.push(o.data)},V.start(100),console.log("[Recording] Started")}catch(e){console.error("[Recording] Failed to start:",e)}},Be=()=>{V&&V.state!=="inactive"&&(V.stop(),console.log("[Recording] Stopped"))},et=async()=>{if(oe.length===0){alert("ÎÖπÌôîÎêú ÏòÅÏÉÅÏù¥ ÏóÜÏäµÎãàÎã§. Îã§Ïãú ÌîåÎ†àÏù¥Ìï¥Ï£ºÏÑ∏Ïöî.");return}se.value=!0;try{const e=new Blob(oe,{type:"video/webm"}),l=s.loadMap?.title||"gameplay",o=new Date().toISOString().slice(0,19).replace(/[:-]/g,""),f=`UMM_${l}_${o}.webm`,m=URL.createObjectURL(e),b=document.createElement("a");b.href=m,b.download=f,document.body.appendChild(b),b.click(),document.body.removeChild(b),URL.revokeObjectURL(m),le.value=!0,console.log("[Recording] Saved:",f)}catch(e){console.error("[Recording] Save failed:",e),alert("ÏòÅÏÉÅ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.")}finally{se.value=!1}},ie=n(0),ne=n(!1),Pe=n(0),$=n(!1);let Se=null;const xe=n(360),_e=n(0);let r=null,d=null;const T=n([]);let re=null,ue=null,ce=!1;const de=n(null);let Ce=null;const Le=me(()=>{if(de.value)return de.value;if(!s.loadMap?.messages)return null;const e=U.value,l=s.loadMap.messages.filter(o=>o.progress<=e);return l.length===0?null:l[l.length-1].text}),J=(e,l=3e3)=>{de.value=e,Ce&&clearTimeout(Ce),Ce=setTimeout(()=>{de.value=null},l)};let De,ve=0;const x=n(!1),tt=me(()=>{const e=t.value.speedMultiplier;return e<.6?"#aa5500":e<.8?"#ff8800":e<1.1?"#4488ff":e<1.5?"#44ff44":e<1.8?"#ff44ff":"#ff4444"}),at=me(()=>{const e=t.value.speedMultiplier;return e<.6?"0.25x":e<.8?"0.5x":e<1.1?"1x":e<1.5?"2x":e<1.8?"3x":"4x"});me(()=>H.value<8?"EASY":H.value<16?"NORMAL":H.value<24?"HARD":"IMPOSSIBLE");const lt=async()=>{if(!r)return;const e=async l=>{try{const f=await(await fetch(l)).arrayBuffer();return await r.decodeAudioData(f)}catch(o){return console.error(`Failed to load sfx: ${l}`,o),null}};re||(re=await e("/audio/click_down.mp3")),ue||(ue=await e("/audio/click_up.mp3"))},fe=(e,l=.5)=>{if(!(!r||!e))try{const o=r.createBufferSource(),f=r.createGain();o.buffer=e,f.gain.value=l,o.connect(f),f.connect(r.destination),o.start()}catch{}},Ae=()=>{if(!s.audioBuffer||!_.value)return;pe(),r||(r=new(window.AudioContext||window.webkitAudioContext)),r.state==="suspended"&&r.resume(),lt();const e=s.multiplayerMode?!1:t.value.isAutoplay;t.value.setMapConfig({density:1,portalFrequency:.15,difficulty:H.value}),t.value.reset(),t.value.isAutoplay=e,ee.value=e,s.loadMap?(t.value.loadMapData(s.loadMap),H.value=s.loadMap.difficulty,$.value=!0,s.tutorialMode&&s.loadMap.autoplayLog&&s.loadMap.autoplayLog.length>0&&(t.value.isAutoplay=!0,ee.value=!0,console.log("[Tutorial] Using saved autoplayLog, length:",s.loadMap.autoplayLog.length)),s.loadMap.bestScore?Y.value=Math.min(100,s.loadMap.bestScore/10):Y.value=0):(t.value.generateMap(s.obstacles,s.sections,s.audioBuffer.duration,void 0,!1),s.tutorialMode&&(t.value.isAutoplay=!0,ee.value=!0),nt()),y.value=!1,C.value=!1,W.value="",O.value=0,U.value=0,A.value=0,Me.value=!1,ce=!1,I("progress-update",{progress:0,ghostProgress:0}),I("progress-update",{progress:0,ghostProgress:0}),T.value.length===0?(q(),Ge()):(T.value=[],q(),Ge()),Oe.value++},st=()=>{be.value||(I("map-ready",{difficulty:H.value,engineObstacles:t.value.obstacles,enginePortals:t.value.portals,autoplayLog:t.value.autoplayLog,duration:s.audioBuffer.duration}),be.value=!0)},ot=()=>{st()},Ne=()=>{if(!s.practiceMode||y.value)return;const e={x:t.value.playerX,y:t.value.playerY,velocity:t.value.velocity,isHolding:t.value.isHolding,cameraX:t.value.cameraX,isGravityInverted:t.value.isGravityInverted,speedMultiplier:t.value.speedMultiplier,isMini:t.value.isMini,waveAngle:t.value.waveAngle,score:t.value.score,progress:t.value.progress,startTimeOffset:(r?.currentTime||0)-t.value.startTime,obstacles:JSON.parse(JSON.stringify(t.value.obstacles)),portals:JSON.parse(JSON.stringify(t.value.portals)),timestamp:Date.now()};T.value.push(e);const l=_.value?.getContext("2d");l&&(l.save(),l.fillStyle="#00ff00",l.font="bold 30px Arial",l.fillText("CHECKPOINT SET!",_.value.width/2,100),l.restore()),console.log("Checkpoint set at",checkpoint.progress+"%")},it=()=>{if(T.value.length===0||!s.practiceMode)return;const e=T.value[T.value.length-1];if(t.value.playerX=e.x,t.value.playerY=e.y,t.value.velocity=e.velocity,t.value.isHolding=e.isHolding,t.value.cameraX=e.cameraX,t.value.isGravityInverted=e.isGravityInverted,t.value.speedMultiplier=e.speedMultiplier,t.value.isMini=e.isMini,t.value.waveAngle=e.waveAngle,t.value.score=e.score,t.value.progress=e.progress,t.value.obstacles=JSON.parse(JSON.stringify(e.obstacles)),t.value.portals=JSON.parse(JSON.stringify(e.portals)),y.value=!1,C.value=!1,W.value="",x.value=!0,t.value.isDead=!1,t.value.isPlaying=!0,d)try{d.stop()}catch{}if(r&&s.audioBuffer){d=r.createBufferSource(),d.buffer=s.audioBuffer,d.connect(r.destination);const l=e.startTimeOffset;t.value.startTime=r.currentTime-l,d.start(0,l),ve=r.currentTime}t.value.trail=[],Ie()},nt=async()=>{if(s.multiplayerMode)return;if(t.value.autoplayLog.length>0){$.value=!0;return}$.value=!1,ne.value=!0,Pe.value=0;let e=0,l=0;for(let o=0;o<100;o++)try{if(o>0){const m=t.value.validationFailureInfo;if(m&&m.x>0){const b=t.value.autoplayLog.find(he=>he.x>=m.x-500),B=b?b.time:0;Math.abs(B-e)<.1?l++:(e=B,l=0),console.log(`[Validation] Fixing impossible part at X=${m.x.toFixed(0)} (T=${e.toFixed(2)}s). Section retry: ${l}`);const Z={time:e,stateEvents:t.value.lastStateEvents,beatActions:t.value.lastBeatActions,obstacles:t.value.obstacles,portals:t.value.portals};t.value.generateMap(s.obstacles,s.sections,s.audioBuffer.duration,void 0,!1,l,120,2,void 0,Z)}else console.log(`[Validation] No failure info. Restarting full generation. Attempt ${o}`),t.value.generateMap(s.obstacles,s.sections,s.audioBuffer.duration,void 0,!1,o),e=0,l=0}if(await t.value.computeAutoplayLogAsync(t.value.playerX,t.value.playerY,m=>{const b=e/s.audioBuffer.duration*100,B=m*(100-b);Pe.value=b+B})){console.log(`[Validation] Path found after ${o} total fixes!`),$.value=!0;break}}catch(f){console.error("Background validation error:",f);break}ne.value=!1},Ge=()=>{z.value="GO!",setTimeout(()=>{z.value=null,rt()},400)},rt=()=>{if(!r||!s.audioBuffer)return;d=r.createBufferSource(),d.buffer=s.audioBuffer,d.connect(r.destination),d.onended=()=>{!y.value&&x.value&&Ue()};const e=r.currentTime+.05;d.start(e),t.value.isPlaying=!0,t.value.startTime=e,x.value=!0,ve=r.currentTime,Qe(),Ie()},pe=()=>{if(x.value=!1,Se&&clearTimeout(Se),d){try{d.stop()}catch{}d.disconnect(),d=null}if(r){try{r.close()}catch{}r=null}cancelAnimationFrame(De)},K=e=>{if(e){const l=e.target;if(l&&(l.tagName==="INPUT"||l.tagName==="BUTTON"||l.closest(".no-prevent-default")))return;e.preventDefault()}!x.value||t.value.isAutoplay||(t.value.isHolding||fe(re,1.5),t.value.setHolding(!0))},j=e=>{if(e){const l=e.target;if(l&&(l.tagName==="INPUT"||l.tagName==="BUTTON"||l.closest(".no-prevent-default")))return;e.preventDefault()}t.value.isAutoplay||(t.value.isHolding&&fe(ue,1),t.value.setHolding(!1))},Xe=e=>{e.code==="KeyC"&&s.practiceMode?Ne():e.code==="KeyX"&&s.practiceMode&&T.value.length>0&&T.value.pop()};Je(()=>{window.addEventListener("keydown",Xe),t.value.onPortalActivation=e=>{if(s.tutorialMode)switch(e){case"gravity_yellow":case"gravity_blue":J("GRAVITY SWITCHED! ‚Üï");break;case"speed_2":case"speed_3":case"speed_4":J("SPEED UP! ‚è©");break;case"speed_0.5":case"speed_0.25":J("SLOW DOWN! ‚è™");break;case"mini_pink":J("MINI MODE: TIGHT SPACES! ‚ú®");break;case"mini_green":J("NORMAL SIZE RESTORED");break}}}),Ke(()=>{window.removeEventListener("keydown",Xe),pe()});const ut=()=>{if(y.value=!0,W.value=t.value.failReason||"CRASHED",O.value=t.value.getProgress(),x.value=!1,O.value>Y.value?(Y.value=O.value,ke.value=!0):ke.value=!1,d)try{d.stop()}catch{}setTimeout(()=>{Be(),I("record-update",{score:A.value,progress:U.value})},3e3);const e=()=>{y.value&&(q(),requestAnimationFrame(e))};e(),Se=setTimeout(()=>{y.value&&(s.practiceMode&&T.value.length>0?it():Ae())},s.practiceMode?1e3:3e3)},Ue=()=>{if(C.value=!0,x.value=!1,A.value=Math.floor(A.value+1e3),O.value=100,d)try{d.stop()}catch{}setTimeout(()=>{Be(),I("record-update",{score:A.value,progress:100})},3e3),I("complete",{score:A.value});const e=()=>{C.value&&(q(),requestAnimationFrame(e))};e()},Ie=()=>{!x.value&&!y.value&&!C.value||(ct(),q(),x.value&&(De=requestAnimationFrame(Ie)))},ct=()=>{if(!r)return;const e=r.currentTime,l=e-t.value.startTime;let o=e-ve;if(ve=e,o>.1&&(o=.1),o<0&&(o=0),t.value.update(o,l),ie.value=l,t.value.isAutoplay&&s.tutorialMode&&(t.value.isHolding&&!ce?fe(re,1.5):!t.value.isHolding&&ce&&fe(ue,1),ce=t.value.isHolding),A.value=t.value.score,U.value=t.value.progress,Me.value=t.value.isGravityInverted,Te.value=t.value.isMini,t.value.isDead?s.invincible?(t.value.isDead=!1,t.value.isPlaying=!0):y.value||ut():!t.value.isPlaying&&x.value&&!y.value&&!C.value&&Ue(),(s.multiplayerMode||s.tutorialMode)&&t.value.totalLength>0){const f=t.value.playerX/t.value.totalLength*100;I("progress-update",{progress:Math.min(100,f),y:t.value.playerY,ghostProgress:s.opponentProgress||0});const m=s.opponentY!==void 0?s.opponentY:360,b=s.opponentProgress||0;xe.value+=(m-xe.value)*je,_e.value+=(b-_e.value)*je}},q=()=>{const e=_.value?.getContext("2d");if(!e||!_.value)return;const l=_.value.width,o=_.value.height,f=e.createLinearGradient(0,0,0,o);f.addColorStop(0,"#0a0a1a"),f.addColorStop(.5,"#151530"),f.addColorStop(1,"#0a0a1a"),e.fillStyle=f,e.fillRect(0,0,l,o),e.save(),e.strokeStyle="rgba(80, 80, 180, 0.08)",e.lineWidth=1;const m=40,b=-t.value.cameraX%m;for(let a=b;a<l;a+=m)e.beginPath(),e.moveTo(a,0),e.lineTo(a,o),e.stroke();for(let a=0;a<o;a+=m)e.beginPath(),e.moveTo(0,a),e.lineTo(l,a),e.stroke();e.restore(),e.save(),e.translate(-t.value.cameraX,0);const B=t.value.isGravityInverted?"#ffff00":"#ff00ff",Z=t.value.isGravityInverted?"#ffff00":"#00ffff";if(e.fillStyle=B,e.globalAlpha=.15,e.fillRect(t.value.cameraX,0,l,t.value.minY),e.globalAlpha=1,e.fillStyle=Z,e.globalAlpha=.15,e.fillRect(t.value.cameraX,t.value.maxY,l,o-t.value.maxY),e.globalAlpha=1,e.strokeStyle=B,e.lineWidth=3,e.shadowBlur=15,e.shadowColor=B,e.beginPath(),e.moveTo(t.value.cameraX,t.value.minY),e.lineTo(t.value.cameraX+l,t.value.minY),e.stroke(),e.strokeStyle=Z,e.shadowColor=Z,e.beginPath(),e.moveTo(t.value.cameraX,t.value.maxY),e.lineTo(t.value.cameraX+l,t.value.maxY),e.stroke(),e.shadowBlur=0,t.value.portals.forEach(a=>{if(a.x+a.width<t.value.cameraX-50||a.x>t.value.cameraX+l+50)return;e.save(),a.angle&&(e.translate(a.x+a.width/2,a.y+a.height/2),e.rotate(a.angle*Math.PI/180),e.translate(-(a.x+a.width/2),-(a.y+a.height/2)));const M=t.value.getPortalColor(a.type),v=t.value.getPortalSymbol(a.type),w=a.type==="mini_pink"||a.type==="mini_green";if(e.globalAlpha=a.activated?.3:1,e.fillStyle=M,e.shadowBlur=20,e.shadowColor=M,w){const p=a.x+a.width/2,h=a.y+a.height/2,N=a.width/2,Fe=a.height/2,E=8;e.beginPath();for(let R=0;R<=E*2;R++){const P=Math.PI*2*R/(E*2)-Math.PI/2,D=R%2===0?1:.6,G=p+Math.cos(P)*N*D,X=h+Math.sin(P)*Fe*D;R===0?e.moveTo(G,X):e.lineTo(G,X)}e.closePath(),e.fill()}else e.beginPath(),e.roundRect(a.x,a.y,a.width,a.height,12),e.fill(),e.fillStyle="rgba(255,255,255,0.4)",e.beginPath(),e.roundRect(a.x+6,a.y+6,a.width-12,a.height-12,8),e.fill();e.shadowBlur=0,e.fillStyle="#000",e.font="bold 18px Outfit",e.textAlign="center",e.textBaseline="middle",e.fillText(v,a.x+a.width/2,a.y+a.height/2),e.restore()}),t.value.obstacles.forEach(a=>{a.x+a.width<t.value.cameraX-50||a.x>t.value.cameraX+l+50||(e.save(),Pt(e,a,a.x,a.y,ie.value),e.restore())}),t.value.isAutoplay&&t.value.aiPredictedPath.length>1){e.save(),e.beginPath(),e.moveTo(t.value.aiPredictedPath[0].x,t.value.aiPredictedPath[0].y);for(let a=1;a<t.value.aiPredictedPath.length;a++)e.lineTo(t.value.aiPredictedPath[a].x,t.value.aiPredictedPath[a].y);e.strokeStyle="rgba(0, 255, 255, 0.15)",e.lineWidth=12,e.lineCap="round",e.lineJoin="round",e.stroke(),e.strokeStyle="rgba(0, 255, 255, 0.6)",e.lineWidth=3,e.stroke(),e.restore()}if(t.value.trail.length>1){e.beginPath(),e.moveTo(t.value.trail[0].x,t.value.trail[0].y);for(let M=1;M<t.value.trail.length;M++){const v=t.value.trail[M];v&&e.lineTo(v.x,v.y)}const a=t.value.isGravityInverted?"rgba(255, 255, 0, 0.6)":"rgba(0, 255, 255, 0.6)";e.strokeStyle=a,e.lineWidth=14,e.lineCap="round",e.lineJoin="round",e.stroke(),e.shadowBlur=0}if(s.multiplayerMode){const M=_e.value/100*t.value.totalLength,v=xe.value;e.save(),e.fillStyle="rgba(255, 0, 255, 0.8)",e.shadowBlur=20,e.shadowColor="#ff00ff";const w=35;e.translate(M,v),e.beginPath(),e.moveTo(w/2,0),e.lineTo(-w/3,-w/3),e.lineTo(-w/6,0),e.lineTo(-w/3,w/3),e.closePath(),e.fill(),e.fillStyle="white",e.font="bold 16px Outfit",e.textAlign="center",e.fillText("OPPONENT",0,-30),e.restore()}if(t.value.particles.forEach(a=>{e.fillStyle=a.color,e.globalAlpha=Math.max(0,a.life),e.beginPath(),e.arc(a.x,a.y,4,0,Math.PI*2),e.fill()}),e.globalAlpha=1,e.globalAlpha=1,t.value.boss.active){const a=t.value.boss;e.save(),e.translate(a.x,a.y),e.shadowBlur=40,e.shadowColor="#ff0000",e.fillStyle="#440000",e.beginPath();const M=60;for(let v=0;v<8;v++){const w=Math.PI*2*v/8;e.lineTo(Math.cos(w)*M,Math.sin(w)*M)}e.fill(),e.fillStyle="#ff0000",e.beginPath(),e.arc(0,0,20,0,Math.PI*2),e.fill(),e.restore(),a.projectiles.forEach(v=>{e.save(),e.translate(v.x,v.y),e.fillStyle="#ffff00",e.shadowBlur=10,e.shadowColor="#ffaa00",e.beginPath(),e.arc(0,0,15,0,Math.PI*2),e.fill(),e.restore()})}s.practiceMode&&T.value.forEach((a,M)=>{e.save();const v=15,w=M===T.value.length-1;e.translate(a.x,a.y),e.beginPath(),e.moveTo(0,-v),e.lineTo(v,0),e.lineTo(0,v),e.lineTo(-v,0),e.closePath(),w?(e.fillStyle="#00ff00",e.shadowBlur=15,e.shadowColor="#00ff00"):e.fillStyle="rgba(0, 255, 0, 0.4)",e.fill(),e.strokeStyle="#fff",e.lineWidth=2,e.stroke(),e.restore()});const he=t.value.playerX,Ye=t.value.playerY,Q=t.value.playerSize,Ve=t.value.isHolding?-1:1,dt=t.value.isGravityInverted?-Ve:Ve,vt=Math.atan2(dt,1);e.save(),e.translate(he,Ye),e.rotate(vt);const Ee=t.value.isGravityInverted?"#ffff00":t.value.isHolding?"#00ffff":"#ff00ff";e.shadowBlur=25,e.shadowColor=Ee;const L=Q*1.2;e.beginPath(),e.moveTo(L,0),e.lineTo(-L*.5,-L*.6),e.lineTo(-L*.15,0),e.lineTo(-L*.5,L*.6),e.closePath();const ge=e.createLinearGradient(-L,0,L,0);ge.addColorStop(0,Ee),ge.addColorStop(.5,"#ffffff"),ge.addColorStop(1,Ee),e.fillStyle=ge,e.fill(),e.strokeStyle="#fff",e.lineWidth=1.5,e.stroke(),e.restore(),e.shadowBlur=0,t.value.showHitboxes&&(e.strokeStyle="#00ff00",e.lineWidth=2,e.strokeRect(he-Q,Ye-Q,Q*2,Q*2),e.strokeStyle="#ff0000",t.value.obstacles.forEach(a=>{if(a.x+a.width<t.value.cameraX-50||a.x>t.value.cameraX+l+100)return;const M=t.value.getObstacleStateAt(a,ie.value),v=M.y,w=M.angle||0;e.save(),e.translate(a.x+a.width/2,v+a.height/2),w!==0&&e.rotate(w*Math.PI/180);const p=a.width/2,h=a.height/2;if(a.type==="slope")e.beginPath(),w>0?(e.moveTo(-p,h),e.lineTo(p,-h),e.lineTo(-p,-h)):(e.moveTo(p,h),e.lineTo(-p,-h),e.lineTo(p,-h)),e.closePath(),e.stroke();else if(a.type==="triangle"||a.type==="steep_triangle")e.beginPath(),e.moveTo(-p,h),e.lineTo(p,h),e.lineTo(p,-h),e.closePath(),e.stroke();else if(a.type==="spike"||a.type==="mini_spike"){const N=a.y>360;e.beginPath(),N?(e.moveTo(-p,h),e.lineTo(0,-h),e.lineTo(p,h)):(e.moveTo(-p,-h),e.lineTo(0,h),e.lineTo(p,-h)),e.closePath(),e.stroke()}else if(a.type==="planet"||a.type==="star"){e.beginPath(),e.arc(0,0,p,0,Math.PI*2),e.stroke();const N=ie.value;if(a.children&&a.children.length>0){const E=a.children,R=a.customData?.orbitSpeed??1;E.forEach((P,F)=>{const D=N*R+F*(Math.PI*2/E.length),G=a.customData?.orbitDistance??a.width*.85,X=Math.cos(D)*G,ye=Math.sin(D)*G,ft=P.width?P.width/2:14;if(e.beginPath(),e.arc(X,ye,ft,0,Math.PI*2),e.stroke(),P.type==="planet"){const We=P.customData?.orbitCount??2,pt=P.customData?.orbitSpeed??2,ze=P.customData?.orbitDistance??P.width*.8;for(let Re=0;Re<We;Re++){const $e=N*pt+Re*(Math.PI*2/We),ht=X+Math.cos($e)*ze,gt=ye+Math.sin($e)*ze,yt=8;e.beginPath(),e.arc(ht,gt,yt,0,Math.PI*2),e.stroke()}}})}else{const E=a.customData?.orbitCount??(a.type==="star"?0:2);if(E>0){const R=a.customData?.orbitSpeed??1,P=a.customData?.orbitDistance??a.width*.8;for(let F=0;F<E;F++){const D=N*R+F*(Math.PI*2/E),G=Math.cos(D)*P,X=Math.sin(D)*P,ye=a.type==="star"?20:10;e.beginPath(),e.arc(G,X,ye,0,Math.PI*2),e.stroke()}}}}else a.type==="saw"||a.type==="spike_ball"||a.type==="mine"||a.type==="orb"?(e.beginPath(),e.arc(0,0,p,0,Math.PI*2),e.stroke()):(a.type==="laser"||a.type,e.strokeRect(-p,-h,a.width,a.height));e.restore()})),e.restore(),(C.value||y.value)&&(e.save(),e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(0,0,l,o),e.restore()),t.value.isMeasureHighlight&&(e.save(),e.fillStyle="rgba(255, 255, 255, 0.15)",e.globalCompositeOperation="screen",e.fillRect(0,0,l,o),e.restore())},He=()=>{if(document.hidden&&x.value){if(d)try{d.stop()}catch{}x.value=!1,y.value=!0,W.value="Ìè¨Ïª§Ïä§ Ïù¥ÌÉàÎ°ú Ï§ëÎã®Îê®"}};return Je(()=>{window.addEventListener("keydown",e=>{e.repeat||(e.code==="Space"||e.code==="ArrowUp"||e.code==="KeyW")&&K(e)}),window.addEventListener("keyup",e=>{(e.code==="Space"||e.code==="ArrowUp"||e.code==="KeyW")&&j(e)}),window.addEventListener("mousedown",K),window.addEventListener("mouseup",j),window.addEventListener("touchstart",K,{passive:!1}),window.addEventListener("touchend",j,{passive:!1}),document.addEventListener("visibilitychange",He),Ae()}),Ke(()=>{pe(),window.removeEventListener("mousedown",K),window.removeEventListener("mouseup",j),window.removeEventListener("touchstart",K),window.removeEventListener("touchend",j),document.removeEventListener("visibilitychange",He)}),wt(()=>s.audioBuffer,()=>{pe(),Ae()}),(e,l)=>(c(),u("div",xt,[i("div",_t,[i("canvas",{ref_key:"canvas",ref:_,width:"1280",height:"720"},null,512),i("div",Ct,[i("div",At,[i("div",It,[!k.multiplayerMode&&!k.loadMap&&$.value&&!be.value?(c(),u("button",{key:0,onClick:ot,class:"hud-action-btn save"}," SAVE MAP ")):g("",!0),i("button",{onClick:l[0]||(l[0]=o=>I("exit",{progress:O.value,score:A.value,outcome:y.value?"fail":"win"})),class:"hud-action-btn exit"},"ÎÇòÍ∞ÄÍ∏∞"),i("button",{onClick:l[1]||(l[1]=o=>I("change-mode")),class:"hud-action-btn mode-change"},"MODE"),k.practiceMode&&!y.value?(c(),u("button",{key:1,onClick:Ne,class:"hud-action-btn checkpoint"},"SET CP (C)")):g("",!0)]),i("div",Et,[i("div",{class:Mt(["wave-icon",{inverted:Me.value}])},"‚ñ∂",2),k.tutorialMode?(c(),u("h1",Ot,"TUTORIAL")):(c(),u("h1",Rt,"ULTRA MUSIC MANIA"))]),i("div",Bt,[i("div",{class:"progress-bar",style:we({width:U.value+"%"})},null,4),Y.value>0?(c(),u("div",{key:0,class:"best-record-marker",style:we({left:Y.value+"%"})},[...l[3]||(l[3]=[i("div",{class:"marker-line"},null,-1),i("span",{class:"marker-text"},"BEST",-1)])],4)):g("",!0),i("span",Lt,S(Math.floor(U.value))+"%",1)])]),i("div",Dt,[l[4]||(l[4]=i("div",{class:"score-label"},"SCORE",-1)),i("div",Nt,S(Math.floor(A.value)),1)]),i("div",Gt,[i("span",{style:we({color:tt.value})},S(at.value),5),Te.value?(c(),u("span",Xt,"MINI")):g("",!0),Te.value?(c(),u("span",Ut,"MINI")):g("",!0),ee.value&&!k.tutorialMode?(c(),u("span",Ht,"AUTO MODE")):g("",!0),k.tutorialMode?(c(),u("span",Yt,"TUTORIAL")):g("",!0),k.practiceMode?(c(),u("span",Vt,"PRACTICE")):g("",!0)]),y.value?(c(),u("div",Ft,[i("div",Wt,[l[6]||(l[6]=i("h1",{class:"status-text fail"},"CRASHED",-1)),ke.value?(c(),u("p",zt,"üéâ NEW BEST! "+S(O.value)+"%",1)):g("",!0),i("p",$t,S(W.value),1),i("div",Jt,[i("span",null,S(O.value)+"% PROGRESS",1),l[5]||(l[5]=i("span",{class:"stat-divider"},"|",-1)),i("span",null,"ATTEMPT "+S(Oe.value),1)])])])):g("",!0),C.value?(c(),u("div",Kt,[i("div",jt,[l[9]||(l[9]=i("h1",{class:"status-text win"},"COMPLETE!",-1)),l[10]||(l[10]=i("p",{class:"status-sub"},"Î™®Îì† Ïû•Ïï†Î¨ºÏùÑ ÎèåÌååÌñàÏäµÎãàÎã§",-1)),i("div",qt,[i("span",null,"SCORE "+S(Math.floor(A.value)),1)]),i("div",Zt,[le.value?g("",!0):(c(),u("button",{key:0,onClick:et,class:"save-video-btn",disabled:se.value},[se.value?(c(),u("span",ea,"üíæ Ï†ÄÏû• Ï§ë...")):(c(),u("span",ta,"üé¨ ÏòÅÏÉÅ Ï†ÄÏû•"))],8,Qt)),le.value?(c(),u("p",aa,"‚úÖ ÏòÅÏÉÅÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!")):g("",!0),l[7]||(l[7]=i("p",{class:"save-hint"},"ÌÅ¥Î¶¨Ïñ¥ Ïû•Î©¥ÏùÑ ÎèôÏòÅÏÉÅÏúºÎ°ú Ï†ÄÏû•Ìï©ÎãàÎã§",-1))]),k.loadMap&&k.loadMap._id&&!ae.value?(c(),u("div",la,[l[8]||(l[8]=i("p",{class:"rating-label"},"RATE THIS MAP (1-30)",-1)),i("div",sa,[Tt(i("input",{type:"range",min:"1",max:"30","onUpdate:modelValue":l[2]||(l[2]=o=>te.value=o),class:"rating-slider"},null,512),[[bt,te.value,void 0,{number:!0}]]),i("span",oa,S(te.value),1)]),i("button",{onClick:Ze,class:"submit-rating-btn"},"SUBMIT VOTE")])):ae.value?(c(),u("div",ia," THANK YOU FOR VOTING! ")):g("",!0)])])):g("",!0),z.value?(c(),u("div",na,[i("div",ra,S(z.value),1)])):g("",!0),ne.value&&!y.value&&!C.value?(c(),u("div",ua,[l[11]||(l[11]=i("div",{class:"status-msg"},"OPTIMIZING MAP...",-1)),i("div",ca,[i("div",{class:"fill",style:we({width:Pe.value+"%"})},null,4)])])):g("",!0),k.practiceMode&&T.value.length>0?(c(),u("div",da," CPs: "+S(T.value.length)+" (Last: "+S(Math.floor(T.value[T.value.length-1].progress))+"%) ",1)):g("",!0),!z.value&&!y.value&&!C.value&&!ne.value?(c(),u("div",va,[k.tutorialMode&&Le.value?(c(),u("div",fa,S(Le.value),1)):(c(),u("div",pa,[l[12]||(l[12]=i("span",null,"ÌÅ¥Î¶≠/Ïä§ÌéòÏù¥Ïä§ Ïú†ÏßÄ = ÏúÑÎ°ú | Ìï¥Ï†ú = ÏïÑÎûòÎ°ú",-1)),k.practiceMode?(c(),u("span",ha," | [C] Ï≤¥ÌÅ¨Ìè¨Ïù∏Ìä∏ | [X] ÏµúÍ∑º ÏÇ≠Ï†ú")):g("",!0)]))])):g("",!0)])])]))}}),Ma=Object.assign(St(ga,[["__scopeId","data-v-419ad202"]]),{__name:"GameCanvas"});export{Ma as _};
